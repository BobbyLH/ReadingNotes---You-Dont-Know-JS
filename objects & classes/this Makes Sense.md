# `this` çœ‹ä¸ŠåŽ»æ˜¯é‚£ä¹ˆå›žäº‹äº†ï¼(`this` All Makes Sense Now!)
ä¹‹å‰æåŠ `this` çš„ç»‘å®šå–å†³äºŽå‡½æ•°è°ƒç”¨æ—¶çš„è°ƒç”¨æ¡ä»¶ï¼Œå³å‡½æ•°å¦‚ä½•è¢«è°ƒç”¨ â€”â€” **è°ƒç”¨ç‚¹(call-site)**ã€‚

## è°ƒç”¨ç‚¹(Call-site)
æ‰€è°“ *è°ƒç”¨ç‚¹(call-site)*ï¼Œå³ä»£ç ä¸­å‡½æ•°è°ƒç”¨çš„ä½ç½®(åŒºåˆ«å‡½æ•°å£°æ˜Žçš„ä½ç½®)ã€‚ä½†ä»…ä»…é€šè¿‡ *å®šä½å‡½æ•°çš„è°ƒç”¨ä½ç½®* æ¥æ‰¾åˆ° *è°ƒç”¨ç‚¹* å¹¶ä¸é‚£ä¹ˆæœ‰æ•ˆï¼Œå› ä¸ºæœ‰äº›ä¹¦å†™ä»£ç çš„æ¨¡å¼ä¼šå°†å…¶æŽ©ç›–èµ·æ¥ã€‚

å¦ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µæ˜¯ *è°ƒç”¨æ ˆ(call-stack)* â€”â€” å½“å‰å‡½æ•° *æ‰§è¡Œæ—¶* çš„å·²è°ƒç”¨çš„æ ˆã€‚

ðŸ‘‡ *è°ƒç”¨ç‚¹* å’Œ *è°ƒç”¨æ ˆ*ï¼š
```js
function baz () {
  // call-stack is baz
  // that means call-site is in global scope
  console.log('baz');
  bar();
}

function bar () {
  // call-stack is in baz -> bar
  // that means call-site is in baz
  console.log('bar');
  foo();
}

function foo () {
  // call-stack is in baz -> bar -> foo
  // that means call-site is in bar
  console.log('foo');
}

baz(); // the bar call-site
```

ä»Ž *è°ƒç”¨æ ˆ* ä¸­åˆ†æžå‡º *è°ƒç”¨ç‚¹* æ˜¯ä¸ºäº†èŽ·å– `this` çš„ç»‘å®šï¼Œä½ å¯ä»¥ä½¿ç”¨æµè§ˆå™¨è‡ªå¸¦çš„debuggerå·¥å…·ï¼Œæˆ–è€…ç›´æŽ¥åœ¨ä»£ç é‡Œæ’å…¥ `debugger`ï¼Œæ¥åœ¨ `foo` å‡½æ•°çš„ä½ç½®æ‰“æ–­ç‚¹ï¼Œè€ŒåŽåœ¨å¯è§†åŒ–çš„å›¾å½¢ç•Œé¢ä¸­æŸ¥çœ‹ðŸ‘†è¿™æ®µä»£ç çœŸå®žçš„è°ƒç”¨æ ˆ(å³ä¾§ç¬¬äºŒè¡Œçš„Call Stack)ï¼š

![avatar](./assets/this_all_makes_sense_now_call_stack.png)

## è§„å®šï¼Œä¸æ˜¯ä¹Œé¾Ÿçš„å±è‚¡(Nothing But Rules)
æƒ³è¦çŸ¥é“ `this` çš„ç»‘å®šæŒ‡å‘ï¼Œæˆ‘ä»¬å¿…é¡»å…ˆæŸ¥çœ‹ *è°ƒç”¨ç‚¹*ï¼Œå¹¶æ ¹æ® **4** ä¸ªæ—¢å®šçš„è§„åˆ™æ¥çŸ¥æ™“ `this` çš„çœŸå®žæŒ‡å‘ã€‚

### é»˜è®¤ç»‘å®š(Default Binding)
ç¬¬ä¸€ä¸ªåœºæ™¯æ˜¯æˆ‘ä»¬æœ€ä¸ºç†ŸçŸ¥çš„ï¼Œå³ *å•ç‹¬åœ°è°ƒç”¨æŸä¸ªå‡½æ•°(standalone function invocation)*ã€‚ä½ å¯ä»¥æŠŠè¿™ä¸ªè§„åˆ™ç†è§£æˆå…¶ä»–ç»‘å®šè§„åˆ™éƒ½æ²¡ç”Ÿæ•ˆæ—¶ï¼Œå¯¹äºŽ `this` ç»‘å®šçš„ ç¼ºçœ/é»˜è®¤è§„åˆ™ã€‚

```js
function foo () {
  console.log(this.a);
}

var a = 2;

foo(); // 2
```

ðŸ‘† å…¨å±€çš„å˜é‡å£°æ˜Ž `var a = 2;` å®žé™…ä¸ŠåŒç­‰äºŽåœ¨ *å…¨å±€å¯¹è±¡(global-object)* ä¸­åŠ å…¥äº†ä¸€ä¸ªå±žæ€§å€¼ `a` â€”â€” å®ƒä»¬ä¸æ˜¯äº’ä¸ºå¤åˆ¶å“ï¼Œå®ƒä»¬å°±æ˜¯å½¼æ­¤ï¼Œå®ƒä»¬æ˜¯ä¸€ä¸ªç¡¬å¸çš„ä¸¤é¢ï¼ŒåŒºåˆ«ä»…åœ¨äºŽçœ‹é—®é¢˜çš„è§’åº¦ä¸åŒè€Œå·²ã€‚

ç´§æŽ¥ç€ï¼Œæˆ‘ä»¬è°ƒç”¨å‡½æ•° `foo` è€ŒåŽæ‰§è¡Œå…¶ä¸­çš„ä»£ç å— `console.log(this.a);` èŽ·å–åˆ°äº†å˜é‡ `a` çš„å€¼å¹¶å°†ç»“æžœæ‰“å°åœ¨æŽ§åˆ¶å°ä¸Šã€‚ä¸ºä»€ä¹ˆ `this.a` èƒ½å¤ŸèŽ·å–å˜é‡ `a` çš„å€¼ï¼Ÿ â€”â€” æˆ‘ä»¬å…ˆæŸ¥çœ‹ *è°ƒç”¨ç‚¹(call-site)*ï¼Œå‘çŽ°å¯¹äºŽå‡½æ•° `foo` æ˜¯ *å•ç‹¬è°ƒç”¨* çš„ï¼Œåˆ™å¯ä»¥ç¡®è®¤åº”ç”¨çš„æ˜¯é»˜è®¤ç»‘å®šè§„åˆ™ï¼Œå› æ­¤è¿™æ—¶å€™çš„ `this` ç»‘å®šçš„æ˜¯å…¨å±€å¯¹è±¡ã€‚

ä½†å¦‚æžœï¼Œæˆ‘ä»¬ä½¿ç”¨äº† *ä¸¥æ ¼æ¨¡å¼(strict mode)* â€”â€” `"use strict";`ï¼Œ`this` çš„é»˜è®¤ç»‘å®šçš„ *å…¨å±€å¯¹è±¡* åˆ™ä¼šè¢«æ›¿æ¢æˆ `undefined`ã€‚

```js
function foo () {
  "use strict";

  console.log(this.a);
}

var a = 2;

foo(); // TypeError
```

æœ‰ä¸ªé‡è¦çš„ç»†èŠ‚ç‚¹ï¼š`this` çš„ç»‘å®šè§„åˆ™è™½ç„¶åŸºäºŽ *è°ƒç”¨ç‚¹*ï¼Œå…¨å±€å¯¹è±¡ä¹Ÿåªä¼šåœ¨é»˜è®¤ç»‘å®šè§„åˆ™ä¸”æ²¡æœ‰è¿è¡Œåœ¨ *ä¸¥æ ¼æ¨¡å¼* æ‰ä¼šç»‘å®šåˆ° `this` ä¸Šã€‚ä½†åœ¨ *è°ƒç”¨ç‚¹* ä¸Šå£°æ˜Žçš„ *ä¸¥æ ¼æ¨¡å¼*ï¼Œå¹¶ä¸èƒ½å†³å®šåœ¨è¿™ä¸ªç‚¹ä¸Šè°ƒç”¨çš„å‡½æ•°æ˜¯å¦éƒ½éµå¾ª *ä¸¥æ ¼æ¨¡å¼*ï¼š

```js
function foo () {
  console.log(this.a);
}

var a = 2;

(function () {
  "use strict";

  foo(); // 2
})();
```

### éšå¼ç»‘å®š(Implicit Binding)
å¦ä¸€ä¸ª `this` çš„ç»‘å®šè§„åˆ™éœ€è¦å…³æ³¨ï¼šå‡½æ•°çš„ *è°ƒç”¨ç‚¹* æ˜¯å¦æœ‰ *ä¸Šä¸‹æ–‡å¯¹è±¡(context object)*ï¼›æ¢å¥è¯è¯´ï¼Œ*è°ƒç”¨ç‚¹* æ˜¯å¦æ‹¥æœ‰æˆ–åŒ…å«æŸä¸ªå¯¹è±¡ï¼š
```js
function foo () {
  console.log(this.a);
}

var obj = {
  a: 2,
  foo
}

obj.foo(); // 2
```

é¦–å…ˆï¼Œæ— è®ºå‡½æ•° `foo` æ˜¯æå‰å£°æ˜Žè€ŒåŽè¢«åŠ å…¥åˆ°å¯¹è±¡ `obj` ä¸­çš„ï¼Œè¿˜æ˜¯ `foo` ä¼´éšå¯¹è±¡åˆå§‹åŒ–æ—¶æ‰ä¸€å¹¶å£°æ˜Žï¼Œè¿™éƒ½ä¸æ˜¯é‡ç‚¹ã€‚é‡ç‚¹æ˜¯å‡½æ•° `foo` è¢« `obj` æ‰€åŒ…å«ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ç†è§£æˆå¯¹è±¡ `obj` ä¿å­˜äº†å¯¹å‡½æ•° `foo` çš„å¼•ç”¨æŒ‡é’ˆã€‚

`obj.foo();` åœ¨å‡½æ•° `foo` è°ƒç”¨ä¹‹å‰è¿˜æœ‰ä¸€ä¸ªå¯¹äºŽ `obj` çš„å¼•ç”¨ï¼Œè¿™ä¸ª `obj` å°±æ˜¯ä¹‹å‰æåˆ°çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡*ã€‚è€Œè¿™æ­£å¥½ç¬¦åˆ `this` çš„ *éšå¼ç»‘å®š* è§„åˆ™ â€”â€” `this` ç»‘å®šåˆ°å‡½æ•°å¼•ç”¨çš„å¯¹è±¡ `obj` ä¸Šï¼Œå› æ­¤ `this.a` æŒ‡ä»£çš„å°±æ˜¯ `obj.a`ã€‚

å¤šå±‚å¼•ç”¨æ—¶ï¼Œåªæœ‰æœ€åŽä¸€å±‚çš„å¯¹è±¡å¼•ç”¨æ‰ä¼šç»‘å®šåˆ° `this` ä¸Šï¼š
```js
function foo () {
  console.log(this.a);
}

var obj2 = {
  a: 42,
  foo
};

var obj1 = {
  a: 2,
  obj2
};

obj1.obj2.foo(); // 42
```

#### éšå¼ç»‘å®šçš„ä¸¢å¤±é—®é¢˜(Implicitly Lost)
ä¸€ä¸ªå¸¸è§çš„ä»¤äººå›°æƒ‘åœ¨äºŽ `this` çš„éšå¼ç»‘å®šä¼šä¸¢å¤±ï¼Œå¹¶é€€å›žåˆ°é»˜è®¤ç»‘å®šè§„åˆ™ï¼Œå³ `this` è¦ä¹ˆæŒ‡å‘å…¨å±€å¯¹è±¡ï¼Œè¦ä¹ˆæ˜¯ `undefined`ï¼Œè¿™å–å†³äºŽæ˜¯å¦åº”ç”¨äº† *ä¸¥æ ¼æ¨¡å¼*ðŸ‘‡ï¼š

```js
function foo () {
  console.log(this.a);
}

var obj = {
  a: 2,
  foo
};

var bar = obj.foo;

var a = 'lost binding';

bar(); // "lost binding"
```

ðŸ‘†è™½ç„¶å˜é‡ `bar` æ˜¾ç„¶æ˜¯å¯¹ `obj.foo` çš„å¼•ç”¨ï¼Œä½†æ˜¯å…³é”®ç‚¹è¿˜æ˜¯åœ¨äºŽ *è°ƒç”¨ç‚¹* â€”â€” `bar();` æ˜¾ç„¶æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½• *ä¸Šä¸‹æ–‡å¯¹è±¡(context object)* çš„å‡½æ•°è°ƒç”¨ï¼Œå› æ­¤ä½¿ç”¨äº†é»˜è®¤è§„åˆ™ä¹Ÿä¸è¶³ä¸ºå¥‡äº†ã€‚

*å›žè°ƒå‡½æ•°* æ˜¯å¦ä¸€ä¸ªæ›´å¾®å¦™ã€æ›´æ™®éã€æ›´åé¢„æœŸçš„ä¸¢å¤±éšå¼ç»‘å®šçš„åœºæ™¯ðŸ‘‡ï¼š

```js
function foo () {
  console.log(this.a);
}

var obj = {
  a: 2,
  foo
};

function doFoo (callback) {
  callback && callback();
}

var a = 'lost binding';

doFoo(obj.foo); // "lost binding"
```

ðŸ‘†å‘ `doFoo(obj.foo);` ä¼ é€’å‚æ•°æ—¶ï¼Œè™½ç„¶ `obj.foo` æ˜¯æœ‰å¯¹è±¡çš„å¼•ç”¨ï¼Œä½†å‡½æ•°å¹¶æ²¡æœ‰è¢«è°ƒç”¨ï¼Œæ­¤æ—¶å¹¶ä¸æ˜¯æˆ‘ä»¬æåˆ°çš„ *è°ƒç”¨ç‚¹*ã€‚çœŸæ­£çš„ *è°ƒç”¨ç‚¹* è¿˜æ˜¯ `callback && callback();` â€”â€” æ²¡æœ‰æ¶‰åŠä»»ä½•çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡(context object)*ã€‚

ä½ å¯èƒ½ä¼šæƒ³ï¼Œå¦‚æžœæˆ‘ä½¿ç”¨å†…å»ºçš„æ–¹æ³•æŽ¥å—å›žè°ƒçš„æ–¹æ³•ï¼Œæ˜¯å¦æƒ…å†µæœ‰æ‰€æ”¹å˜å‘¢ï¼Ÿï¼š

```js
function foo () {
  console.log(this.a);
}

var obj = {
  a: 2,
  foo
};

var a = 'lost binding';

setTimeout(obj.foo, 1000); // "lost binding"
```

![avatar](./assets/this_all_makes_sense_now_implicit_lose.png)

ç­”æ¡ˆæ˜¾ç„¶æ˜¯ **ä¾ç„¶ä¼šä¸¢å¤±** â€”â€” å…³é”®ä¾ç„¶æ˜¯åœ¨ *è°ƒç”¨ç‚¹* ä¸Šã€‚

### æ˜¾ç¤ºç»‘å®š(Explicit Binding)
äº†è§£äº†é»˜è®¤ç»‘å®šå’Œéšå¼ç»‘å®šçš„è§„åˆ™åŽï¼Œæœ‰ä¸€éƒ¨åˆ†çš„ `this` æŒ‡å‘åœºæ™¯èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚äº†ï¼Œä½†å¦‚æžœæˆ‘ä»¬æƒ³è¦å¼ºåˆ¶å°†æŸä¸ªå‡½æ•°çš„ `this` ç»‘å®šåˆ°æŸä¸ª *ä¸Šä¸‹æ–‡å¯¹è±¡* ä¸Šï¼Œè€Œåˆä¸æƒ³å°†è¿™ä¸ªå‡½æ•°ä½œä¸ºè¿™ä¸ª *ä¸Šä¸‹æ–‡å¯¹è±¡* çš„æŸä¸ªæ–¹æ³•æ¥è°ƒç”¨ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨ *æ˜¾ç¤ºç»‘å®š* è§„åˆ™äº†ã€‚

`call(â€¦)` å’Œ `apply(â€¦)` æ˜¯æ¯ä¸ªå‡½æ•°éƒ½å…·å¤‡çš„å†…ç½®æ–¹æ³•ï¼Œå®ƒä»¬çš„ä½¿ç”¨åŸºæœ¬ç±»ä¼¼ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éƒ½æ˜¯ç»‘å®šåˆ° `this` çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡*ï¼ŒåŽé¢çš„åˆ™æ˜¯è°ƒç”¨è¯¥æ–¹æ³•(`call` å’Œ `apply`)çš„å‡½æ•°æ‰€éœ€è¦çš„å‚æ•°ï¼Œå®Œæˆè¿™äº›åŽï¼Œç«‹å³æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼š

```js
function foo () {
  console.log(this.a);
}

var obj = {
  a: 2
};

foo.call(obj); // 2
```

å¦‚æžœä½ å°† *åŽŸå§‹å€¼(primitive value)*(`string`ã€`number`ã€`boolean`) ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ `call` æˆ– `apply`ï¼Œé‚£ä¹ˆè¿™äº›åŽŸå§‹å€¼å°†ä¼šè¢«éšå¼è½¬æ¢æˆ *åŒ…è£…å¯¹è±¡*(`new String(â€¦)`ã€`new Number(â€¦)`ã€`new Boolean(â€¦)`)ã€‚

ä½†å¥½åƒæ˜¾ç¤ºç»‘å®šä¹Ÿå¹¶æ²¡æœ‰è§£å†³éšå¼ç»‘å®šä¸¢å¤± `this` çš„é—®é¢˜ï¼Ÿï¼

#### ç¡¬ç»‘å®š(Hard Binding)
å›´ç»•ç€æ˜¾ç¤ºç»‘å®šå®žçŽ°çš„ä¸€ç§ç»‘å®šæ¨¡å¼ï¼Œèƒ½å¤Ÿè§£å†³ä¸¢å¤± `this` çš„é—®é¢˜ï¼š

```js
function foo () {
  console.log(this.a);
}

var obj = {
  a: 2
};

var a = 'lost binding';

function bar () {
  foo.call(obj);
}

setTimeout(bar, 1000);

bar.call(window);
```

ðŸ‘†å‡½æ•° `bar` æ— è®ºæ˜¯ä½œä¸ºå›žè°ƒå‡½æ•°ï¼Œè¿˜æ˜¯è‡ªèº«çš„ `this` è¢«æ˜¾ç¤ºçš„ç»‘å®šåˆ°å…¨å±€å¯¹è±¡(`window`)ï¼Œè°ƒç”¨å®ƒéƒ½åªä¼šåœ¨æŽ§åˆ¶å°æ‰“å°å‡º `2` å³ `obj.a` çš„å€¼ â€”â€” å› ä¸ºå…¶å†…éƒ¨åªä¼šå°† `foo` çš„ `this` æ˜¾ç¤ºçš„ç»‘å®šåˆ° `obj` ä¸Šã€‚è¿™æ ·çš„ç»‘å®šæ¨¡å¼æˆ‘ä»¬ç§°ä¸º *ç¡¬ç»‘å®š*ã€‚

æ”¹è¿›ä¸€ä¸‹ï¼Œä½ å¯ä»¥å°†éœ€è¦è¿›è¡Œç¡¬ç»‘çš„å‡½æ•°å’Œ *ä¸Šä¸‹æ–‡å¯¹è±¡* ä½œä¸ºå‚æ•°ä¼ é€’ï¼š

```js
function foo (num) {
  console.log(this.a, num);

  return this.a + num;
}

function simpleBind (fn, ctx) {
  return function () {
    return fn.apply(ctx, arguments);
  }
}

var obj = {
  a: 2
};

var a = 'lost binding';

var bar = simpleBind(foo, obj);

var b = bar(5); // 2 5
console.log(b); // 7
```

ðŸ‘†ä¸Šé¢ä»£ç ä¸­çš„ `simpleBind` æ˜¯å†…ç½®çš„ `bind` æ–¹æ³•çš„éƒ¨åˆ†åŠŸèƒ½ç®€å•å®žçŽ°ï¼Œå†…ç½®çš„ `bind` æ–¹æ³•ä¸ä»…èƒ½å¤Ÿè¿”å›žä¸€ä¸ªå·²ç»ä¸º `this` ç»‘å®šäº† *ä¸Šä¸‹æ–‡å¯¹è±¡* çš„å‡½æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•°è¿˜æœ‰ä¸€ä¸ª `name` å±žæ€§çš„å€¼ä¸º `bound foo`ï¼Œå³ç»‘å®šäº† `this` çš„å‡½æ•° `foo`ã€‚

#### APIè°ƒç”¨çš„ â€œä¸Šä¸‹æ–‡â€(API Call "Context")
å¾ˆå¤šç¬¬ä¸‰æ–¹åº“çš„æ–¹æ³•ï¼Œç”šè‡³æ˜¯ä¸€äº›å†…ç½®çš„æ–¹æ³•ï¼Œæä¾›äº†å¯é€‰å‚æ•°ï¼Œè¿™ä¸ªå‚æ•°ä¼šè®©ä½ ä¼ é€’ *ä¸Šä¸‹æ–‡å¯¹è±¡* æ¥ç»‘å®šåˆ°å›žè°ƒå‡½æ•° `this` ä¸Šï¼š

```js
function foo (ele) {
  console.log(ele, this.id);
}

var obj = {
  id: 'awesome'
};

[1, 2, 3].forEach(foo, obj); // 1 "awesome" 2 "awesome" 3 "awesome"
```

ä»Žæœ¬è´¨ä¸Šæ¥è¯´ï¼Œè¿™äº›æ–¹æ³•éƒ½é‡‡ç”¨äº†æ˜¾ç¤ºç»‘å®šçš„è§„åˆ™ï¼Œå³ä½¿ç”¨ `call` å’Œ `apply` å†…ç½®æ–¹æ³•æ¥å¸®ä½ é¿å…ä¸€äº›éº»çƒ¦ã€‚

## `new` ç»‘å®š(`new` Binding)
ç¬¬å››ä¸ªï¼Œä¹Ÿæ˜¯æœ€åŽä¸€ä¸ª `this` çš„ç»‘å®šè§„åˆ™ï¼Œéœ€è¦æˆ‘ä»¬é‡æ–°æ€è€ƒJSä¸­çš„å‡½æ•°å’Œå¯¹è±¡ï¼Œä»¥åŠå…³äºŽå®ƒä»¬å¸¸è§çš„è¯¯åŒºã€‚

åœ¨ä¼ ç»Ÿçš„é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸­ï¼Œé€šå¸¸ä½¿ç”¨å…³é”®å­— `new` æ¥å®žä¾‹åŒ–ä¸€ä¸ªç±»ï¼Œè¿™ä¸ªå…³é”®å­—åœ¨JSä¸­ä¹ŸåŒæ ·å­˜åœ¨ã€‚ä½†JSä¸­ä½¿ç”¨å…³é”®å­— `new` è™½ç„¶çœ‹ä¸ŠåŽ»è·Ÿé¢å‘å¯¹è±¡çš„è¯­è¨€ä¸€æ ·ï¼Œå¥½åƒéƒ½å®žä¾‹åŒ–äº†ä¸€ä¸ªç±»ï¼Œä½†è¿™åªæ˜¯ä¸€ä¸ªå‡è±¡ã€‚

é¦–å…ˆï¼ŒJSä¸­æ‰€è°“çš„ *æž„é€ å™¨(constructor)* åªæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨å…¶å‰é¢ä½¿ç”¨äº†å…³é”®å­— `new` æ¥è°ƒç”¨å®ƒè€Œå·²ã€‚å®ƒå¹¶éžä¸€ä¸ªç±»ï¼Œä¹Ÿä¸æ˜¯å®žä¾‹åŒ–è¿™ä¸ªç±»ï¼Œå®ƒç”šè‡³éƒ½ä¸æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å‡½æ•° â€”â€” é™¤äº†ä½¿ç”¨ `new` æ¥ *åŠ«æŒ(hijacked)* å®ƒçš„è°ƒç”¨ï¼Œå®ƒæœ¬è´¨ä¸Šå’Œæ™®é€šçš„å‡½æ•°æ²¡ä»€ä¹ˆä¸¤æ ·ã€‚

æ¯”å¦‚ï¼Œå†…ç½®çš„ `Number(â€¦)` æž„é€ å‡½æ•°ï¼Œåœ¨ES5çš„è¯´æ˜Žæ–‡æ¡£é‡Œï¼Œå¯¹å…¶æœ‰æ¸…æ™°çš„å®šä¹‰ï¼š
> 15.7.2 The Number Constructor
> 
> When Number is called as part of a new expression it is a constructor: it initialises the newly created object.

JSä¸­å¹¶æ²¡æœ‰æ‰€è°“çš„ *æž„é€ å™¨å‡½æ•°(constructor functions)*ï¼Œåªæœ‰ *å‡½æ•°çš„æž„é€ è°ƒç”¨(construction calls of functions)*ã€‚

å½“å‡½æ•°å‰ä½¿ç”¨äº† `new` å…³é”®å­—æ—¶ï¼Œå‘ç”Ÿäº†å¦‚ä¸‹çš„äº‹æƒ…ï¼š
1. å‡­ç©ºåˆ›é€ äº†æ–°å¯¹è±¡ï¼Œå¹¶å°†å…¶å…³è”åˆ° *åŽŸåž‹(prototype)* ä¸Šï¼›
2. è¿™ä¸ªæ–°å¯¹è±¡è¢«ç»‘å®šä¸ºè¿™ä¸ªå‡½æ•°ä¸­çš„ `this` çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡*ï¼›
3. é™¤éžå‡½æ•°æ‰‹åŠ¨çš„è¿”å›žä¸€ä¸ªå¯¹è±¡ï¼Œå¦åˆ™å°±è¿™ä¸ªæ–°åˆ›å»ºçš„å¯¹è±¡ä¼šè¢«è¿”å›žã€‚

```js
function foo (a) {
  this.a = a;
}

var bar = new foo(a);

console.log(bar.a); // 2
```

`new` æ˜¯å‡½æ•°è°ƒç”¨æ—¶èƒ½å¤Ÿç»‘å®š `this` çš„æœ€åŽä¸€ç§æ–¹å¼ï¼Œæˆ‘ä»¬ç§°å…¶ä¸º *new ç»‘å®š*ã€‚

## ä¸€åˆ‡éƒ½äº•ç„¶æœ‰åº(Everything In Order)
å¦‚æžœåªæœ‰ä¸€ç§ `this` ç»‘å®šçš„è§„åˆ™ï¼Œé‚£ä¸€åˆ‡å°½åœ¨ä¸è¨€ä¸­ã€‚è€ŒçŽ°å®žæ˜¯æˆ‘ä»¬å¾€å¾€ä¼šé¢ä¸´å¤šç§ç»‘å®šè§„åˆ™ä¸€èµ·å‡ºçŽ°ï¼Œè¿™æ—¶å€™æ¬¡åºï¼Œæˆ–è€…è¯´æƒé‡å°±æ˜¾å¾—å¾ˆé‡è¦äº†ã€‚

ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„æƒ…å†µæ˜¯ï¼Œ*é»˜è®¤ç»‘å®šè§„åˆ™(default binding)* è‚¯å®šæ˜¯ä¼˜å…ˆçº§æœ€ä½Žçš„æƒ…å†µï¼Œå› æ­¤å…ˆæ¯”è¾ƒ *éšå¼ç»‘å®š(implicit binding)* å’Œ *æ˜¾ç¤ºç»‘å®š(explicit binding)*ï¼š

```js
function foo () {
  console.log(this.a);
}

var obj1 = {
  a: 3,
  foo
};

var obj2 = {
  a: 2,
  foo
};

obj1.foo(); // 3
obj2.foo(); // 2

obj1.foo.call(obj2); // 2
obj2.foo.call(obj1); // 3
```

ðŸ‘†å¾ˆæ˜¾ç„¶ï¼Œä»Ž `obj1.foo.call(obj2);` ä¼šè¾“å‡º `3` çš„ç»“æžœæ¥çœ‹ï¼Œ*æ˜¾ç¤ºç»‘å®š* çš„ä¼˜å…ˆçº§é«˜äºŽ *éšå¼ç»‘å®š*ã€‚

ðŸ‘‡æŽ¥ä¸‹åŽ»æ˜¯ *éšå¼ç»‘å®š(implicit binding)* å’Œ *new ç»‘å®š(new binding)*ï¼š

```js
function foo (num) {
  this.a = num;
}

var obj1 = {
  foo
};

var obj2 = {};

obj1.foo(2);
console.log(obj1.a); // 2

obj1.foo.call(obj2, 3);
console.log(obj2.a); // 3

var bar = new obj1.foo(4);
console.log(obj1.a); // 2
console.log(bar.a); // 4
```

å¾ˆæ˜¾ç„¶ï¼Œ`bar.a` çš„å€¼æ˜¯ `4`ï¼Œå› æ­¤ *new ç»‘å®š* ä¼˜å…ˆçº§é«˜äºŽ *éšå¼ç»‘å®š*ã€‚

**Note:** `new` å’Œ `call / apply` ä¸èƒ½å¤ŸåŒæ—¶ä½¿ç”¨ï¼Œå› æ­¤ `new foo.call(obj1);` æ˜¯ä¸èƒ½è¢«å…è®¸çš„ã€‚ä¸ºäº†èƒ½å¤Ÿæµ‹è¯• *new ç»‘å®š* å’Œ *æ˜¾ç¤ºç»‘å®š* çš„ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿç”¨ *ç¡¬ç»‘å®š* æ¥å®žçŽ°ã€‚

ä¸€èˆ¬æˆ‘ä»¬ç”¨ `Function.prototype.bind(â€¦)` æ¥å¯¹æŸä¸ªå‡½æ•°è¿›è¡Œä¸€å±‚ *åŒ…è£¹(wrapper)*ï¼Œè¿™ä¸ªåŒ…è£¹ä¼šå¿½è§†æŽ‰å…¶ä»–çš„ `this` ç»‘å®šè§„åˆ™ï¼Œè€Œä½¿ç”¨æˆ‘ä»¬æ‰‹åŠ¨æä¾›çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡* æ¥ç»‘å®šåˆ° `this` ä¸Šã€‚

å› æ­¤ï¼Œ*æ˜¾ç¤ºç»‘å®š* ä¼˜å…ˆäºŽ *new ç»‘å®š* æ˜¯ä¸€ä¸ªå¾ˆè½»æ˜“å°±è¢«æŽ¨æ–­å‡ºæ¥çš„ç»“è®ºï¼Œä½†å®žé™…ä¸Šå¹¶éžå¦‚æ­¤ï¼š

```js
function foo (num) {
  this.a = num;
}

var obj1 = {};
 
var bar = foo.bind(obj1);

bar(2);
console.log(obj1.a); // 2

var baz = new bar(3);

console.log(obj1.a); // 2
console.log(baz.a); // 3
```

ðŸ‘† `bar` æ˜¯ä½œä¸ºå‡½æ•° `foo` ç¡¬ç»‘å®šå…¶ `this` åˆ°å¯¹è±¡ `obj1` çš„ç»“æžœï¼Œä½†æ˜¯ `new bar(3);` å¹¶æ²¡æœ‰ç›´æŽ¥æ”¹å˜ `obj1.a` çš„å€¼ï¼Œè€Œæ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡(`baz`)ï¼Œå¹¶å°†å‡½æ•° `foo` çš„ `this` ç»‘å®šåˆ°è¿™ä¸ªå¯¹è±¡ä¸Šï¼Œä»Žè€Œå¾—åˆ° `baz.a` çš„ç»“æžœæ˜¯ `3`ã€‚

ä½†å¦‚æžœå›žé¡¾ä¹‹å‰æˆ‘ä»¬å†™çš„ä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿ *ç¡¬ç»‘å®š* çš„æ–¹æ³•ï¼Œä½ ä¼šæƒŠå¥‡çš„å‘çŽ°ï¼Œ`new` å¥½åƒæ²¡æœ‰åŠžæ³•é‡å†™ *ç¡¬ç»‘å®š* çš„è§„åˆ™ï¼š
```js
function simpleBind (fn, ctx) {
  return function () {
    return fn.apply(ctx, arguments);
  }
}

function foo (num) {
  this.a = num;
}

var obj1 = {};
 
var bar = simpleBind(foo, obj1);

bar(2);
console.log(obj1.a); // 2

var baz = new bar(3);

console.log(obj1.a); // 3
console.log(baz.a); // undefined
```

ä½†å®žé™…ä¸Šï¼Œåœ¨ES5ä¸­å‡ºçŽ°çš„å†…ç½®çš„æ–¹æ³• `Function.prototype.bind(â€¦)` æ˜¯æ›´å®Œå–„çš„ï¼Œæ¯”å¦‚æ‹¿ MDN ä¸­å¯¹å…¶è¿›è¡Œ [polyfill](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Function/bind) çš„ä»£ç ä¸ºä¾‹(èƒ½å¤Ÿä½¿ç”¨ `new` å…³é”®å­—çš„ç‰ˆæœ¬)ï¼š
```js
// It does work with `new funcA.bind(thisArg, args)`
if (!Function.prototype.bind) {
  var ArrayPrototypeSlice = Array.prototype.slice;
  Function.prototype.bind = function (oThis) {
    if (typeof this !== 'function') {
      throw new TypeError('Function.prototype.bind - ' + 'what is trying to be bound is not callable');
    }

    var aArgs = ArrayPrototypeSlice.call(arguments, 1),
    aArgsLength = aArgs.length,
    fToBind = this,
    fNOP = function () {},
    fBound = function () {
      aArgs.length = aArgsLength; // reset to default base arguments
      aArgs.push.apply(aArgs, arguments);
      return fToBind.apply(fNOP.prototype.isPrototypeOf(this) ? this : oThis, aArgs);
    };

    if (this.prototype) {
      fNOP.prototype = this.prototype;
    }
    fBound.prototype = new fNOP();

    return fBound;
  };
}
```

**Note:** ðŸ‘†MDNæä¾›çš„ `bind(â€¦)` çš„ polyfill å’ŒES5ä¸­å†…ç½®çš„ `bind(â€¦)` æ–¹æ³•åœ¨ç¡¬ç»‘å®šå†åŽè°ƒç”¨ `new`ï¼Œæœ‰äº›åœ°æ–¹æœ‰åŒºåˆ«ã€‚å› ä¸º polyfill ä¼šåˆ›å»ºä¸€ä¸ªå…·æœ‰ `prototype` å±žæ€§çš„å‡½æ•° `fBound` æ¥ä½œä¸ºç¡¬ç»‘å®šçš„è¿”å›žå‡½æ•°ï¼Œè€Œå†…ç½®çš„æ–¹æ³•è¿”å›žçš„å‡½æ•°åˆ™æ²¡æœ‰ã€‚
> The partial implementation creates functions that have a prototype property. (Proper bound functions have none.)

ðŸ‘‡è¿™æ®µä»£ç æ˜¯èƒ½å¤Ÿä½¿ç”¨ `new` å…³é”®å­—çš„æ ¸å¿ƒï¼š
```js
fNOP.prototype.isPrototypeOf(this) ? this : oThis

// ä»¥åŠ

if (this.prototype) {
  fNOP.prototype = this.prototype;
}
fBound.prototype = new fNOP();
```

å…¶ä¸­ï¼Œ`fNOP` çš„ *åŽŸåž‹å¯¹è±¡(prototype)* å¦‚æžœå’Œè¯¥å‡½æ•° *è°ƒç”¨ç‚¹* æ—¶ç»‘å®šçš„ *ä¸Šä¸‹æ–‡å¯¹è±¡* ä¸€è‡´æ—¶â‘ ï¼Œç¡¬ç»‘å®šæ‰€è¿”å›žçš„å‡½æ•°çš„ `this` æŒ‡å‘åˆ™ä¼šä½¿ç”¨è¿™ä¸ªæ–°çš„ `this` ä½œä¸º *ä¸Šä¸‹æ–‡å¯¹è±¡*ï¼Œè€Œéžä¹‹å‰é¢„è®¾ä¸”ä¿å­˜åœ¨å˜é‡ `oThis` ä¸­çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡*ã€‚

**â‘ :** è¯¥åœºæ™¯ç­‰äºŽä½¿ç”¨å…³é”®å­— `new` æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå› æ­¤æ—¶çš„ `this` æŒ‡ä»£çš„æ˜¯å…¶å‡½æ•°è‡ªèº«ï¼Œå³`fBound`ã€‚è€Œ `fNOP.prototype = this.prototype;` è¿™è¡Œä»£ç å°† `fNOP` çš„ *åŽŸåž‹å¯¹è±¡* æå‰ä¿å­˜ä¸ºè¿›è¡Œç¡¬ç»‘å®šçš„å‡½æ•°çš„ *åŽŸåž‹å¯¹è±¡*ï¼›éšåŽå°† `fBound` çš„ *åŽŸåž‹å¯¹è±¡* èµ‹å€¼ä¸º `new fNOP();` è¿›è¡Œäº† *åŽŸåž‹é“¾* çš„å…³è”æ“ä½œã€‚å› æ­¤ï¼Œå¦‚æžœä½¿ç”¨ `new` æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œé‚£ä¹ˆ `fBound` çš„ *åŽŸåž‹å¯¹è±¡* å…¶å®žå°±æ˜¯ `fNOP.prototype`ã€‚

å¦ä¸€ä¸ª `bind(â€¦)` æ‰€å…·å¤‡çš„èƒ½åŠ›åˆ™æ˜¯å°†ç¬¬ä¸€æ¬¡è¿›è¡Œç¡¬ç»‘å®šè¿‡ç¨‹ä¸­ï¼Œé™¤å¼€ç¬¬ä¸€ä¸ªå‚æ•°(å³ç»‘å®šä¸Šä¸‹æ–‡çš„ `oThis`)çš„å‰©ä½™å‚æ•° `aArgs`ï¼Œä½œä¸ºä¸‹æ¬¡è°ƒç”¨è¿™ä¸ªç¡¬ç»‘å®šå‡½æ•°çš„é»˜è®¤å‚æ•°ä¼ é€’è¿›åŽ»ï¼Œä»ŽæŠ€æœ¯è§’åº¦å°†ï¼Œè¿™ä¸ªç‰¹æ€§å«åš *éƒ¨åˆ†åº”ç”¨(partial application)*ï¼Œä¹Ÿç§°ä¸º *æŸ¯é‡ŒåŒ–(currying)*ï¼š

```js
function foo (p1, p2) {
  this.val = p1 + p2;
}

var bar = foo.bind(null, 'your ');

var baz = new bar('name');

console.log(baz.val); // 'your name'
```

### `this` çš„å†³å®šæ—¶åˆ»(Determining `this`)
æ€»ç»“ä¸€ä¸‹ç»‘å®š `this` çš„è§„åˆ™ï¼Œä»Žä¸Šå¾€ä¸‹ä»£è¡¨ä¼˜å…ˆçº§çš„ä»Žé«˜åˆ°åº•ï¼š
1. è‹¥å‡½æ•°é€šè¿‡ `new` å…³é”®å­—è°ƒç”¨ï¼Œåˆ™ `this` æŒ‡å‘æ–°åˆ›å»ºçš„è¿™ä¸ªå¯¹è±¡ï¼š
  `var bar = new foo();`

2. å‡½æ•°è°ƒç”¨ `apply` æˆ– `call` æ¥æ˜¾ç¤ºçš„ç»‘å®š `this`ï¼š
  `var bar = foo.call(obj2);`

3. å‡½æ•°çš„ *è°ƒç”¨ç‚¹* åŒ…å«äº†æŸä¸ª *ä¸Šä¸‹æ–‡å¯¹è±¡* æ¥éšå¼çš„ç»‘å®š `this`ï¼š
  `var bar = obj1.foo();`

4. ä¸Šè¿°æƒ…å†µéƒ½ä¸æ»¡è¶³ï¼Œåˆ™ä½¿ç”¨é»˜è®¤ç»‘å®šè§„åˆ™ â€”â€” *ä¸¥æ ¼æ¨¡å¼* ä¸‹ `this` æ˜¯ `undefined`ï¼Œå¦åˆ™ `this` æŒ‡å‘å…¨å±€å¯¹è±¡ï¼š
  `var bar = foo();`

ðŸ‘†è¿™äº›åŸºæœ¬æ˜¯æ‰€æœ‰çš„ `this` ç»‘å®šè§„åˆ™ã€‚

## ç»‘å®šè§„åˆ™ä¹‹å¤–(Binding Exceptions)
å‡¡äº‹éƒ½æœ‰ä¾‹å¤–ï¼Œ`this` çš„ç»‘å®šä¹Ÿä¸èƒ½å¹¸å…ã€‚

### è¢«å¿½ç•¥çš„`this`(Ignored `this`)
å¦‚æžœä½ ä¼ å…¥ `null` æˆ– `undefined` ä½œä¸º `call`ã€`apply` æˆ– `bind` çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œ`null` æˆ– `undefined` ä¼šè¢«å¿½ç•¥ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯é»˜è®¤ç»‘å®šè§„åˆ™ï¼š

```js
function foo () {
  console.log(this.a);
}

var a = 2;

foo.call(null); // 2
```

ä½ å¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ `null` æˆ– `undefined` ä½œä¸º `this` çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡*ï¼Ÿå› ä¸ºä¸€èˆ¬æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `apply` ç¬¬äºŒä¸ªå‚æ•°æ˜¯æ•°ç»„çš„ç‰¹æ€§ï¼ŒæŠŠä¸€ä¸ªæ‹¥æœ‰å¾ˆå¤šå‚æ•°(å½¢å‚)çš„å‡½æ•°çš„å‚æ•°(å®žå‚)ï¼Œæ”¾è¿›ä¸€ä¸ªæ•°ç»„ä¸­(ä¾¿äºŽç®¡ç†)ï¼Œç„¶åŽä½¿ç”¨ `apply` æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼›æˆ–è€…ä½¿ç”¨ `bind` çš„æŸ¯é‡ŒåŒ–ç‰¹æ€§ï¼Œé¢„å…ˆä¿ç•™ä¸€äº›å‚æ•°ï¼Œä»¥ä¾¿åœ¨åŽé¢ä½¿ç”¨çš„æ—¶å€™è‡ªåŠ¨å¸¦ä¸Šè¿™äº›å‚æ•°ï¼š

```js
function foo (a, b, c) {
  console.log(a + b + c);
}

foo.apply(null, [1, 2, 3]); // 6

var bar = foo.bind(null, 1, 2);

bar(3); // 6

bar(4); // 7
```

`apply` å’Œ `bind` éƒ½éœ€è¦ç¬¬ä¸€ä¸ªå‚æ•°ä½œä¸ºæŒ‡å®š `this` çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡*ï¼Œå¦‚æžœä½ è°ƒç”¨çš„å‡½æ•°æ ¹æœ¬ä¸å…³å¿ƒ `this` çš„æŒ‡å‘ï¼Œé‚£ä¹ˆ `null` å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å ä½ç¬¦ã€‚

**Note:** è™½ç„¶ ES6 ä¸­å·²ç»æœ‰ `...` æ‰©å±•è¿ç®—ç¬¦ï¼Œèƒ½å¤Ÿè§£æž„æ•°ç»„ï¼Œä½†æ˜¯ `bind` æ–¹æ³•è‡ªå¸¦çš„ *æŸ¯é‡ŒåŒ–(currying)* ç‰¹æ€§è¿˜æœªæœ‰æ›¿ä»£ç‰©ï¼Œå› æ­¤è¿™ç§æƒ…å†µä»ç„¶éœ€è¦å…³æ³¨ã€‚

æœ€å±é™©çš„æƒ…å†µå¾€å¾€æ˜¯åœ¨ä½ æœªæ›¾é¢„æ–™çš„æ—¶å€™å‘ç”Ÿï¼Œå°±æ¯”å¦‚ä½ æ˜¯ç”¨äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„å¼€æºçš„åº“ï¼Œä½ ä¸æ¸…æ¥šå®ƒçš„å…·ä½“å®žçŽ°ç»†èŠ‚è€Œè´¸ç„¶å°†å®ƒæä¾›çš„æŸä¸ªæ–¹æ³•ï¼Œç”¨ `null` æˆ– `undefined` ä½œä¸º `this` çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡*ï¼Œé‚£æœ‰å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›å¾ˆéš¾è¿½è¸ªåˆ°çš„bugã€‚

#### å®‰å…¨çš„`this`(Safer `this`)
åˆ›å»ºä¸€ä¸ªæ²¡æœ‰ä»»ä½•å§”æ‰˜ï¼Œä¸”å®Œå…¨æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œä½œä¸º `this` ç»‘å®šçš„ *éš”ç¦»å¸¦(DMZ de-militarized zone)*ï¼Œæ˜¯ä¸€ä¸ªå¸¸è§çš„ç¡®ä¿ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨(æ¯”å¦‚ `this` æ ¹æ®é»˜è®¤è§„åˆ™ç»‘å®šåˆ°å…¨å±€å¯¹è±¡ä¸Šï¼Œè€ŒåŽå¯¹å…¨å±€å¯¹è±¡äº§ç”Ÿæ±¡æŸ“ç­‰æ„å¤–çš„ç»“æžœ)çš„åŠžæ³•ä¹‹ä¸€ã€‚

ç”¨ `Ã¸` æ¥æŒ‡ä»£è¿™ä¸ªç©ºå¯¹è±¡æ›´å…·è¯­ä¹‰åŒ–ï¼Œä½¿ç”¨ `Object.create(null)` åˆ›å»ºå‡ºä¸€ä¸ªæ²¡æœ‰ä»£ç† `Object.prototype` çš„ç©ºå¯¹è±¡ï¼š

```js
function foo (a, b, c) {
  console.log(a + b + c);
}

var Ã¸ = Object.create(null);

foo.apply(Ã¸, [1, 2, 3]); // 6

var bar = foo.bind(Ã¸, 1, 2);

bar(3); // 6

bar(4); // 7
```

### é—´æŽ¥ç»‘å®šäº†`this`(Indirection)
å¦å¤–ä¸€ä¸ªéœ€è¦è­¦æƒ•çš„æƒ…å†µæ˜¯åœ¨èµ‹å€¼çš„æ—¶å€™å‘ç”Ÿçš„ *é—´æŽ¥å¼•ç”¨(indirect references)*ï¼Œåœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼Œä¸€æ—¦è°ƒç”¨äº†è¯¥å‡½æ•°å¼•ç”¨ï¼Œæ‰§è¡Œçš„æ˜¯é»˜è®¤çš„ç»‘å®šè§„åˆ™ï¼š

```js
function foo () {
  console.log(this.a);
}

var a = 2;
var o = { a: 3 };
var p = { a: 4, foo };

(o.foo = p.foo)(); // 2
```

`o.foo = p.foo` ä»…ä»…æ˜¯å¯¹åº•å±‚å‡½æ•°å¯¹è±¡çš„å¼•ç”¨ï¼ŒçœŸæ­£æ‰§è¡Œçš„ *è°ƒç”¨ç‚¹* æ˜¯ `foo()` è€Œä¸æ˜¯ `p.foo()` æˆ– `o.foo()`ï¼Œå› æ­¤æŒ‰ç…§è§„åˆ™ï¼Œé»˜è®¤ç»‘å®šä¼šè¢«æ‰§è¡Œã€‚

### è½¯ç»‘å®š(Softening Binding)
è™½ç„¶ä½¿ç”¨ç¡¬ç»‘å®šèƒ½å¤Ÿè§£å†³ *ä¸ç»æ„é—´ä¸¢å¤± `this` ç»‘å®šè€Œå¯¼è‡´é»˜è®¤ç»‘å®šè§„åˆ™ç”Ÿæ•ˆ* çš„æƒ…å†µï¼Œä½†ç¡¬ç»‘å®šè®©å‡½æ•°å¤±åŽ»äº†çµæ´»åº¦ â€”â€” é™¤éžä½ ä½¿ç”¨ `new` å…³é”®å­—ï¼Œå¦åˆ™ä»»ä½•çš„éšå¼ç»‘å®šï¼Œç”šè‡³æ˜¯æ˜¾ç¤ºç»‘å®šè§„åˆ™éƒ½æ²¡æ•ˆæžœã€‚

*è½¯ç»‘å®š* æ˜¯è§£å†³è¿™ç§é—®é¢˜çš„ä¸€ä¸ªåŠžæ³•ï¼š

```js
if (!Function.prototype.softBind) {
  Function.prototype.softBind = function (presetCtx) {
    var fn = this,
    curried = [].slice.call(arguments, 1),
    bound = function bound () {
      return fn.apply(
        (!this || (typeof window !== 'undefined' && this === window) || (typeof global !== 'undefined' && this === global))
          ? presetCtx
          : this,
        curried.concat.apply(curried, arguments)
      );
    };
    bound.prototype = Object.create(fn.prototype);

    return bound;
  }
}
```

é™¤äº†æ£€æµ‹ *è°ƒç”¨ç‚¹* çš„ `this` æ˜¯å¦å¯ç”¨çš„æ˜¯é»˜è®¤ç»‘å®šè§„åˆ™ä¹‹å¤–ï¼Œ`softBind` åŸºæœ¬å’Œ ES5 ä¸­çš„ `bind` æ–¹æ³•ç±»ä¼¼ã€‚å…¶æ ¸å¿ƒå°±æ˜¯é¢„è®¾ä¸€ä¸ª `presetCtx` ä½œä¸ºæ›¿ä»£é»˜è®¤ç»‘å®šè§„åˆ™çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡*ï¼Œè€ŒåŽè¿”å›žçš„å‡½æ•°åˆ¤æ–­å…¶ *è°ƒç”¨ç‚¹* çš„ `this` æŒ‡å‘ï¼Œåªè¦ä¸æ˜¯å…¨å±€å¯¹è±¡ï¼Œé‚£ä¹ˆå°±åº”ç”¨å½“å‰çš„ `this` æŒ‡å‘ï¼Œå¦åˆ™å°† `this` ç»‘å®šåˆ°é¢„è®¾çš„ *ä¸Šä¸‹æ–‡å¯¹è±¡* ä¸Šã€‚

```js
function foo (a, b, c) {
  console.log(a + b + this.c);
}

var bar = foo.softBind(obj1, 1, 2);

var c = 3;
var obj1 = { c: 4 };
var obj2 = { c: 5, bar };
var obj3 = { c: 6 };

obj2.bar(); // 8

bar.call(obj3); // 9

bar(); // 7
```

å¯ä»¥çœ‹åˆ°ï¼Œ`bar();` æŽ§åˆ¶å°æ‰“å°çš„å€¼æ˜¯ `7`ï¼Œå³ä¸º `1+2+4`ï¼Œè€Œå…¶ä»–çš„ `obj2.bar();` å’Œ `bar.call(obj3);` éƒ½åº”ç”¨ä¸Šäº†éšå¼ç»‘å®šè§„åˆ™å’Œæ˜¾ç¤ºç»‘å®šè§„åˆ™ï¼Œå”¯ä¸€ä¸ç”Ÿæ•ˆçš„æ˜¯é»˜è®¤ç»‘å®šè§„åˆ™ã€‚

## è¯æ³•`this`(Lexical `this`)
æ­£å¸¸çš„å‡½æ•°çš„ `this` ç»‘å®šï¼Œéƒ½éµå®ˆðŸ‘†æåˆ°çš„å››ç§è§„åˆ™ï¼Œé™¤äº† ES6 ä¸­æ–°å¢žçš„ *ç®­å¤´å‡½æ•°(arrow-function)* å¤–ã€‚

ç®­å¤´å‡½æ•° çš„å£°æ˜Žå’Œæ™®é€šå‡½æ•°ä¸åŒï¼Œå®ƒä¸ä½¿ç”¨å…³é”®å­— `function`ï¼Œè€Œæ˜¯ç”¨ `=>` è¿™æ ·çš„èƒ–ç®­å¤´(fat-arrow)æ“ä½œç¬¦æ›¿ä»£ã€‚ç®­å¤´å‡½æ•°çš„ `this` ç»‘å®šè§„åˆ™é‡‡ç”¨çš„æ˜¯ *ç»‘å®šåˆ°ç®­å¤´å‡½æ•°æ‰€å¤„çš„å°é—­ä½œç”¨åŸŸ(enclosing scope)çš„ `this`ä¸Š*ï¼Œè¯¥ä½œç”¨åŸŸå¯ä»¥æ˜¯å‡½æ•°ä½œç”¨åŸŸï¼Œä¹Ÿå¯ä»¥æ˜¯å…¨å±€ä½œç”¨åŸŸï¼š

```js
function foo () {
  return () => {
    console.log(this.a);
  }
}

var obj1 = {
  a: 2
};

var obj2 = {
  a: 3
};

var bar = foo.call(obj1);

bar.call(obj2); // 2
```
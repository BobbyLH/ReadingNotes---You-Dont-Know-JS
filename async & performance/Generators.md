# Generators
å›é¡¾ä¸‹ç¬¬äºŒèŠ‚æåˆ°çš„ä½¿ç”¨ callback è¿›è¡Œå¼‚æ­¥ç¼–ç¨‹çš„å¼Šç«¯ï¼š
- ä¸ç¬¦åˆæˆ‘ä»¬å¤§è„‘æŒ‰æ­¥éª¤è¿›è¡Œçš„å·¥ä½œæ¨¡å¼

- å› ä¸º IoC çš„é—®é¢˜ï¼Œcallback å¹¶ä¸å®‰å…¨å¯ä¿¡

åœ¨ç¬¬ä¸‰èŠ‚ä¸­å‡ºç°çš„ Promise å¾ˆå¥½çš„è§£å†³äº†ğŸ‘†å®‰å…¨å¯ä¿¡çš„é—®é¢˜ï¼Œä½†å¯¹äºç¬¦åˆå¤§è„‘çš„å·¥ä½œæ¨¡å¼ï¼Œä¾ç„¶æ— èƒ½ä¸ºåŠ›ã€‚è€Œæ¥ä¸‹å»æˆ‘ä»¬çš„æ¢ç´¢æŒ‰ç…§åŒæ­¥æ¨¡å¼å®ç°çš„å¼‚æ­¥ç¼–ç¨‹ â€”â€” Generator å¼‚æ­¥ç¼–ç¨‹çš„æµç¨‹æ§åˆ¶ï¼Œå°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€å‰‚è‰¯è¯ã€‚

## æ‰“ç ´ â€œä¸€è·‘å°±åˆ°åº•â€(Breaking Run-to-Completion)
ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨ JS ä¸­ï¼Œæ™®é€šçš„å‡½æ•°ä¸€æ—¦å¼€å§‹æ‰§è¡Œï¼Œå°±åªèƒ½æ‰§è¡Œåˆ°åº•ï¼Œæ²¡æœ‰æœºåˆ¶èƒ½å¤Ÿæ‰“æ–­å®ƒçš„æ‰§è¡Œã€‚

è€Œ ES6 å¼•å…¥çš„ generator æ˜¯ä¸€ä¸ªæ–°ç±»å‹çš„å‡½æ•°ï¼Œå®ƒèƒ½å¤Ÿæ‰“ç ´è¿™ä¸ª â€œæ— æ³•åœæœºâ€ é—®é¢˜ã€‚

ä¸€ä¸ªç®€å•çš„æ€æƒ³å®éªŒå¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£ï¼š

```js
var x = 1;

function foo () {
  x++;
  bar();
  console.log('x: ', x);
}

function bar () {
  x++;
}

foo(); // x: 3
```

ğŸ‘†æ˜¾è€Œæ˜“è§ `x` çš„ç»“æœæ˜¯ `3`ï¼›ä½†è‹¥å½“ `bar()` æ²¡æœ‰åœ¨ `foo()` ä¸­è¢«è°ƒç”¨ï¼Œè€Œåˆæƒ³è®© `x` çš„ç»“æœä¸å˜ï¼Œæœ‰ä»€ä¹ˆåŠæ³•èƒ½å®ç°å‘¢ï¼Ÿ

åœ¨ å¯æŠ¢å å¼çš„å¤šçº¿ç¨‹è¯­è¨€(preemptive multithreaded languages) ä¸­ï¼Œå½“æŸä¸ªçº¿ç¨‹æ‰§è¡Œåˆ° `x++` æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å°±èƒ½è§ç¼æ’é’ˆçš„è°ƒç”¨ `bar()`ï¼Œä»è€Œå°†ç»“æœç»´æŒä¸å˜ã€‚ä½† JS ä¸ä»…ä¸èƒ½å®ç° â€œæŠ¢å â€ï¼Œè€Œä¸”å®ƒè¿˜æ˜¯å•çº¿ç¨‹çš„ï¼Œé‚£è¿™æ ·çš„å®ç°ä¹Ÿå°±æ— ä»è°ˆèµ·äº†ã€‚

ä¸è¿‡ï¼Œæœ‰äº† generator ä¹‹åï¼Œå®ç°è¿™æ ·çš„ ååŒå¹¶å‘(cooperative concurrency) æœºåˆ¶æˆä¸ºäº†å¯èƒ½ï¼Œå› ä¸ºä½ èƒ½æš‚åœ `foo()` çš„æ‰§è¡Œï¼š

```js
var x = 1;

function *foo () {
  x++;
  yield;
  console.log('x: ', x);
}

function bar () {
  x++;
}

var it = foo();
it.next();
x; // 2
bar();
x; // 3
it.next(); // x: 3
```

**Note**ï¼šå…³äº `*` çš„ä½ç½®ï¼Œç‰µæ‰¯åˆ°äº†é£æ ¼çš„é€‰æ‹©ï¼Œæ¯”å¦‚æœ‰çš„æ–‡æ¡£æˆ–ä»£ç ä¸­æ˜¯å°† `*` é è¿‘ `function`ï¼š`function* foo () {â€¦â€¦}`ã€‚è€Œä½œè€…é€‰æ‹©å°† `*` é è¿‘å‡½æ•°åæ˜¯ä¸ºäº†æ›´ä¾¿äºè¡¨è¾¾ï¼Œå°±æ¯”å¦‚ `*foo()` å’Œ `foo()` çš„åŒºåˆ«ä¸€æœ›ä¾¿çŸ¥ã€‚

ä¸Šé¢æ•´ä¸ª generator å‡½æ•° `*foo()` æ‰§è¡Œçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š
  1. `it = foo()` å¹¶ä¸æ˜¯æ‰§è¡Œ generatorï¼Œè€Œæ˜¯ç›¸å½“äºæ„é€ äº†ä¸€ä¸ª *iterator* å¯¹è±¡ï¼Œç”¨æ¥æ§åˆ¶æ•´ä¸ª generator çš„æ‰§è¡Œï¼›

  2. ç¬¬ä¸€æ¬¡è°ƒç”¨ `it.next()` æ‰æ˜¯æ­£å¼å¼€å§‹æ‰§è¡Œ generatorï¼Œå¹¶ä¸”æ‰§è¡Œäº†ç¬¬ä¸€è¡Œ `x++` ä»£ç ï¼›

  3. éšåé‡åˆ°äº†ç¬¬ä¸€ä¸ª `yield` å…³é”®å­—ï¼Œå‡½æ•° `*foo()` çš„æ‰§è¡Œå°±æš‚åœäº†ï¼›

  4. è€Œåæˆ‘ä»¬è¾“å…¥ `x` å¾—åˆ°äº†å…¶å½“å‰çš„å€¼ä¸º `2`ï¼›

  5. æ¥ä¸‹å»æ‰§è¡Œäº† `bar()`ï¼Œåœ¨å…¶å†…éƒ¨æ‰§è¡Œäº† `x++` çš„ä»£ç ï¼›

  6. å†ä¸€æ¬¡æ£€æŸ¥ `x` çš„å€¼ä¸º `3`ï¼› 

  7. æœ€ç»ˆï¼Œè°ƒç”¨ `it.next()` å°†æš‚åœçš„ generator å‡½æ•°æ¢å¤æ‰§è¡Œï¼Œå¹¶æ§åˆ¶å°æ‰“å°å‡ºäº† `"x: 3"` çš„ä¿¡æ¯â€¦â€¦

æ€»çš„æ¥è®²ï¼Œåœ¨ generator å‡½æ•°ä¸­ï¼Œé€šè¿‡å…³é”®å­— `yield` å°±èƒ½æš‚åœ generator å‡½æ•°çš„æ‰§è¡Œï¼Œè€Œåå¯ä»¥é€šè¿‡è°ƒç”¨ `next()` æ¢å¤å‡½æ•°çš„æ‰§è¡Œã€‚å¹¶ä¸”ï¼Œå‡½æ•°æ‰§ä¸æ‰§è¡Œå®Œæ˜¾ç„¶ä¸æ˜¯å¼ºåˆ¶è¦æ±‚çš„ â€”â€” çœ‹ä¸Šå»æ²¡å•¥äº†ä¸èµ·ï¼Ÿ

### è¾“å…¥å’Œè¾“å‡º(Input and Output)
generator å‡½æ•°æœ¬è´¨ä¸Šæ¥çœ‹ä¾ç„¶æ˜¯å‡½æ•°ï¼Œå› æ­¤ä¸€äº›æ™®é€šå‡½æ•°çš„åŸºæœ¬ç‰¹æ€§ä¾ç„¶å¯¹å®ƒæœ‰æ•ˆï¼Œå°±æ¯”å¦‚ â€œè¾“å…¥â€ â€”â€” å‚æ•° å’Œ â€œè¾“å‡ºâ€ â€”â€” è¿”å›å€¼ï¼š

```js
function *foo(x, y) {
  return x * y;
}

var it = foo();

var res = it.next(6, 7);

res.value; // 42
```

ğŸ‘† æˆ‘ä»¬å°† `6` å’Œ `7` ä½œä¸º `*foo(â€¦)` çš„å‚æ•°ä¼ å…¥ï¼Œè€Œåè®¡ç®—å‡º `6 * 7` çš„å€¼åè¿”å› â€”â€” é™¤äº†åœ¨æ¿€æ´» generator å‡½æ•°çš„å½¢å¼ä¸Šï¼Œè¿™äº›æ“ä½œå¥½åƒå’Œæ™®é€šçš„å‡½æ•°è°ƒç”¨æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§çš„åŒºåˆ«ã€‚ä½†ç»†èŠ‚å´ä¸èƒ½å¿½è§†ï¼š`*foo(6, 7)` å¹¶ä¸æ˜¯å‡½æ•°è°ƒç”¨ï¼Œè€Œæ˜¯æ„å»ºå‡ºäº†ä¸€ä¸ª iterator å¯¹è±¡ï¼›`it.next()` æ‰å¼€å§‹æ‰§è¡Œ generator çš„å‡½æ•°ä½“å†…å®¹ï¼Œè€Œå…¶è¿”å›å€¼æ˜¯ä¸€ä¸ªåŒ…å«äº† `value` å±æ€§çš„å¯¹è±¡ï¼›è€Œ `value` çš„å€¼åˆ™æ˜¯ `yield` æˆ– `return` è¾“å‡ºçš„å€¼ã€‚

ä½†ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡æ¥æ§åˆ¶ generator å‡½æ•°å‘¢ï¼Ÿè®©å®ƒè‡ªæ‰§è¡Œä¸å¥½å—ï¼Ÿ

#### è¿­ä»£çš„ä¿¡æ¯(Iteration Messaging)
é™¤äº†ç”¨å‚æ•°å’Œè¿”å›å€¼å®ç° â€œè¾“å…¥â€ å’Œ â€œè¾“å‡ºâ€ ä¹‹å¤–ï¼Œé€šè¿‡å…³é”®å­— `yield` å’Œ è¿­ä»£å¯¹è±¡çš„ `next(â€¦)` æ–¹æ³•ï¼Œèƒ½å¤Ÿå®ç°é¢—ç²’åº¦æ›´ç»†ï¼Œæ›´æœ‰ç”¨çš„ â€œè¾“å…¥â€ å’Œ â€œè¾“å‡ºâ€ï¼š

```js
function *foo(x) {
  const baseInd = Math.round(Math.random() * 10);
  var y = x * (yield baseInd);
  return y;
}

var it = foo(6);

var res = it.next();

res.value;

res = it.next(res.value * 5);

res.value;
```

`foo(6)` å°† `6` ä½œä¸ºå‚æ•°ä¼ å…¥ generator å‡½æ•°ï¼Œè°ƒç”¨ `it.next()` åï¼Œè·å¾— `(yield baseInd)` ä¸­çš„ `baseInd`ï¼Œè€Œåå°†å…¶ä¹˜ä»¥ `5`ï¼Œå¹¶ä½œä¸ºå‚æ•°å†æ¬¡ä¼ é€’åˆ° generator ä¸­ï¼Œæœ€ç»ˆç”Ÿæˆçš„å€¼æ˜¯è¿™ä¸€ç³»åˆ—å‚æ•°ä¼ é€’çš„ç»„åˆï¼Œå³ `6 * baseInd * 5`ã€‚

éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œåœ¨ä¸Šé¢æ‰§è¡Œ generator çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸€ä¸ªæœ‰è¶£çš„ç°è±¡ â€”â€” `next(â€¦)` å§‹ç»ˆæ¯” `yield` å¤šä¸€ä¸ªã€‚æœ‰äº›äººè¯¯ä»¥ä¸ºè¿™æ˜¯ä¸ªé”™é…ï¼Œä½†å¯¼è‡´è¿™ä¸ª â€œé”™é…â€ çš„åŸå› æ˜¯å› ä¸ºç¬¬ä¸€ä¸ª `next(â€¦)` çš„ä½œç”¨æ˜¯å¯åŠ¨ generator å‡½æ•°ï¼Œè€Œååœ¨é‡åˆ°ç¬¬ä¸€ä¸ª `yield` å…³é”®å­—åæš‚åœæ•´ä¸ªå‡½æ•°çš„åç»­æ‰§è¡Œ â€”â€” è¿™å³æ„å‘³ç€è¯´ï¼Œä½ æƒ³è¦è·å¾— `yield` ä¹‹åçš„ç»“æœï¼Œè‡³å°‘è¿˜éœ€è¦æ‰§è¡Œä¸€æ¬¡ `next(â€¦)` æ‰è¡Œã€‚

##### ä¸¤ä¸ªé—®é¢˜çš„æ•…äº‹(Tale of Two Question)
æ¢ä¸ªè§’åº¦æ¥çœ‹è¿™ä¸ªæ‰€è°“çš„ â€œé”™é…â€ çš„é—®é¢˜å¯èƒ½ä¼šå¾—åˆ°ä¸ä¸€æ ·çš„è§£è¯»ã€‚

ç±»ä¼¼äºæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é€šè¿‡APIè¿›è¡Œé€šä¿¡ä¸€æ ·ï¼Œæˆ‘ä»¬å°† generator çš„å†…éƒ¨å’Œå¤–éƒ¨çš„ iterator åŒæ ·è§†ä¸ºæ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ï¼š

```js
function *server(x) {
  const baseInd = Math.round(Math.random() * 10);
  var y = x * (yield baseInd);
  return y;
}

var client = server(6); // å’ŒæœåŠ¡ç«¯å»ºç«‹äº†è¿æ¥ï¼Œå¹¶å‘é€äº† 6 ä½œä¸ºå‚æ•°

var res = client.next(); // å®¢æˆ·ç«¯ï¼šæœåŠ¡ç«¯ï¼Œè¯·æŠŠç¬¬ä¸€ä¸ªè¿”å›å€¼å‘Šè¯‰æˆ‘ï¼Œè°¢è°¢

res.value; // ä¸€ä¸ªç”±æœåŠ¡ç«¯ç”Ÿæˆçš„å€¼

res = client.next(res.value * 5); // å°†è¿™ä¸ªå€¼ä¹˜ä»¥ 5 å‘é€ç»™æœåŠ¡ç«¯

res.value; // å¾—åˆ°æœåŠ¡ç«¯æœ€ç»ˆç”Ÿæˆçš„å€¼
```

ğŸ‘† ä¸€ä¸ªç±»ä¼¼äº â€œåŠåŒå·¥é€šä¿¡â€ çš„æœºåˆ¶ç”±æ­¤è€Œæ¥ï¼Œå¹¶ä¸”ç”±äºç¬¬ä¸€æ¬¡è°ƒç”¨ `next()` çš„æ—¶å€™ï¼Œæœ¬è´¨ä¸Šæ¥çœ‹å°±æ˜¯å¯åŠ¨ generator å‡½æ•°ï¼Œè‹¥æ˜¯å°†å®ƒæƒ³è±¡æˆå‡½æ•°ä¸€å¼€å§‹å°±æœ‰ä¸€ä¸ªéšè—çš„ `yield`ï¼Œå¹¶ä¸”ä»è¿™é‡Œå‡ºå‘ï¼Œé‚£ä¹ˆä¸ç”¨ä¼ é€’ä»»ä½•å‚æ•°(argument-free)ä¹Ÿæ˜¯åœ¨æƒ…ç†ä¹‹ä¸­çš„ã€‚

æœ€åçš„ `return y` æ ‡ç¤ºç€æ•´ä¸ª generator å‡½æ•°æ‰§è¡Œå®Œæ¯•ã€‚è‹¥æ˜¯æ²¡æœ‰æ˜¾ç¤ºçš„å†™ `return` çš„ä»£ç ï¼Œé‚£ä¹ˆå’Œæ™®é€šå‡½æ•°ä¸€æ ·ï¼ŒJS å¼•æ“ä¼šéšå¼çš„å¸®ä½ åŠ ä¸Š `return undefined;` çš„è¯­å¥ã€‚
 
è¿™ç§é€šè¿‡ `yield` å’Œ `next(â€¦)` å®ç°çš„é€šä¿¡æœºåˆ¶éå¸¸å¼ºå¤§ï¼Œä½†ç¦»å¼‚æ­¥æµç¨‹æ§åˆ¶å¥½åƒè¿˜æœ‰ç‚¹è·ç¦»ï¼Ÿï¼åˆ«æ€¥ï¼Œæ¥ç€çœ‹ä¸‹å»ã€‚

### å¤šä¸ªè¿­ä»£å™¨(Multiple Iterators)
æ¯æ¬¡è°ƒç”¨ genenrator å‡½æ•°ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ iterator å®ä¾‹ï¼Œå³æ„å‘³ç€ä½ èƒ½åŒæ—¶åˆ›å»ºå¤šä¸ª iterator çš„å®ä¾‹ï¼Œè€Œä¸”å®ƒä»¬è¿˜èƒ½ç›¸äº’ä½œç”¨ï¼š

```js
function *foo() {
  var x = yield 2;
  z++;
  var y = yield (x * z);
  console.log(x, y, z);
}

var z = 1;

var it1 = foo();
var it2 = foo();

var val1 = it1.next().value; // 2
var val2 = it2.next().value; // 2

val1 = it1.next(val2 * 10).value; // 40
val2 = it2.next(val1 * 5).value; // 600

it1.next(val2 / 2); // 2 300 3
it2.next(val1 / 4); // 200 10 3

```

ğŸ‘†ä¸Šé¢çš„é€»è¾‘æœ‰ç‚¹ç»•ï¼Œè€Œä¸”ä¹Ÿæ²¡äººä¼šåœ¨çœŸå®çš„å¼€å‘ä¸­è¿™ä¹ˆåšï¼Œä½†å¹¶ä¸å¦¨ç¢æˆ‘ä»¬å°†å®ƒä½œä¸ºä¸€ä¸ªæ¡ˆä¾‹æ¥ç ”ç©¶å¤šä¸ª iterator çš„å®ä¾‹èƒ½å¤Ÿå®ç°äº’ç›¸å½±å“çš„ç°è±¡ã€‚

ç®€å•åˆ†æä¸‹è¿‡ç¨‹ï¼š
1. `it1` å’Œ `it2` æ˜¯ä¸¤ä¸ªç”± `*foo` åˆ›å»ºçš„ iterator å®ä¾‹ï¼Œå®ƒä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨çš„ `next()` æ–¹æ³•å¹¶è·å–è¿”å›å€¼ä¸­çš„ `value` å±æ€§æ—¶ï¼Œå…¶ç»“æœéƒ½æ˜¯ `2`ï¼›

2. `val2 * 10` å°±ç›¸å½“äº `2 * 10`ï¼Œå…¶ç»“æœ `20` ä½œä¸ºå‚æ•°ä¼ é€’ç»™ `it1`ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™å˜é‡ `x`ï¼Œè€Œåå˜é‡ `z` è‡ªå¢çš„ç»“æœæ˜¯ `2`ï¼Œå› æ­¤ `x * z` çš„ç»“æœç›¸å½“äº `20 * 2` å³ `40`ï¼Œå¹¶å°†å…¶ä½œä¸ºè¿”å›å€¼å¤åˆ¶ç»™ `val1`ï¼›

3. `val1 * 5` ç›¸å½“äº `40 * 5` å³ `200`ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ å…¥ `it2` ä¸­ï¼Œæ­¤æ—¶ `it2` ä¼šç»å† `it1` çš„æ­¥éª¤ï¼Œåªæ˜¯ `x` å’Œ `z` æ•°å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ†åˆ«æ˜¯ `200` å’Œ `3`ï¼Œå› æ­¤æœ€ç»ˆ `val2` çš„å€¼å˜æˆäº† `600`(æ¥è‡ª `yield (x * z)` çš„è¿”å›å€¼)ï¼›

4. `val2 / 2` çš„ç»“æœ `300` ä½œä¸ºå‚æ•°å†ä¸€æ¬¡ä¼ é€’åˆ° `it1` ä¸­ï¼Œè€Œåèµ‹å€¼ç»™äº† `y`ï¼Œå› æ­¤ `it1` æœ€ç»ˆæ‰“å°çš„ç»“æœæ˜¯ `2 300 3`ï¼›

5. åŒç†å¯å¾— `val1 / 4` çš„ç»“æœä¸º `40 / 4`ï¼Œè€Œåä¼ å…¥ `it2`ï¼Œæ‰“å°çš„ç»“æœä¸º `200 10 3`


#### äº¤é”™è¿›è¡Œ(interleaving)
å›é¡¾ä¸‹ä¹‹å‰æåˆ°çš„æ™®é€šå‡½æ•°çš„è¿è¡Œæ¨¡å¼ï¼š

```js
var a = 1;
var b = 2;

function foo () {
  a++;
  b = b * a;
  a = b + 3;
}

function bar () {
  b--;
  a = 8 + b;
  b = a * 2;
}
```

ğŸ‘†ä¸Šé¢çš„ä»£ç æ— è®ºæ˜¯ `foo` æˆ– `bar` å…ˆæ‰§è¡Œï¼Œæœ€ç»ˆéƒ½åªèƒ½å¾—åˆ°ä¸¤ç§ä¸ä¸€æ ·çš„ç»“æœã€‚ä½†æ˜¯ï¼Œè‹¥æˆ‘ä»¬ä½¿ç”¨ generator å‡½æ•°æ”¹é€ ä¸€ä¸‹ï¼Œé‚£å°±èƒ½å¾—åˆ°å¾ˆå¤šä¸ä¸€æ ·çš„ç»“æœï¼š

```js
var a = 1;
var b = 2;

function *foo() {
  a++;
  yield;
  b = b * a;
  a = (yield b) + 3;
}

function *bar() {
  b--;
  yield;
  a = (yield 8) * b;
  b = a * (yield 2);
}
```

ğŸ‘† `*foo()` å’Œ `*bar()` ä¸åŒçš„è°ƒç”¨é¡ºåºä¼šäº§ç”Ÿä¸ä¸€æ ·çš„ç»“æœï¼Œè€Œç”¨è¿™ä¸ªç‰¹æ€§æ¥æ¨¡æ‹Ÿ â€œçº¿ç¨‹ç«äº‰(threaded race conditions)â€ ä¹Ÿæ˜¯å¯è¡Œçš„ â€”â€” æ¯”å¦‚è¿™ä¸ªå‡½æ•°æœ‰å‰¯ä½œç”¨ï¼Œä¾èµ–å…¨å±€å˜é‡å•¥çš„ï¼š

å…ˆå®ç°ä¸€ä¸ªå·¥å…·å‡½æ•°ç”¨æ¥ç®€åŒ– iterator çš„æ‰§è¡Œï¼š

```js
function step (gen) {
  var it = gen();
  var last;

  return function () {
    last = it.next(last).value;
  }
}
```

æ¥ä¸‹æ¥ï¼Œä»…ä»…æ˜¯ä¸ºäº†å®éªŒçš„ç›®çš„ï¼Œæˆ‘ä»¬å†å®ç°å› å¤šä¸ª iterator äº¤äº’è€Œç›¸äº’å½±å“çš„ä¾‹å­ï¼š

```js
a = 1;
b = 2;

var s1 = step(foo);
var s2 = step(bar);

s1();
s1();
s1();

s2();
s2();
s2();
s2();

console.log(a, b); // 11 22
```

è‹¥æ˜¯ä½ çœŸçš„ç†è§£äº† generator å‡½æ•°çš„æ‰§è¡Œæœºåˆ¶ï¼Œé‚£å¾—å‡ºç»“æœå¹¶ä¸å›°éš¾ã€‚è‹¥æ˜¯è°ƒæ¢ä¸€ä¸‹ `s1()` å’Œ `s2()` çš„è°ƒç”¨é¡ºåºçš„è¯ï¼Œç»“æœä¼šåˆä¸ä¸€æ ·ï¼š

```js
// â€¦â€¦
s1();
s2();
s2();
s1();
s2();
s1();
s2();
// â€¦â€¦
```

ğŸ‘† é€šè¿‡ generator æ”¹é€ ï¼Œå…¶æœ€ç»ˆå¯èƒ½çš„ç»“æœçš„ä¸ªæ•°ï¼Œå’Œæ™®é€šå‡½æ•°åªæœ‰ä¸¤ä¸ªç»“æœç›¸æ¯”èµ·æ¥å¤§å¤§å¢åŠ ã€‚ä¸è¿‡ï¼Œé€šå¸¸æˆ‘ä»¬å¹¶ä¸ä¼šè¿™ä¹ˆå†™ä»£ç ï¼Œä½†è¿™ä¸ª â€œå¹¶å‘â€ çš„èƒ½åŠ›å…¶å®æœ‰å¤§ç”¨å¤„ï¼Œåé¢ç»†è¯´ã€‚

## Generatorç”Ÿæˆçš„å€¼(Generator'ing Values)
ä¹‹å‰çš„ä¸€äº›å°è¯•åªæ˜¯å¼€èƒƒèœï¼Œè¦ææ¸…æ¥š generator çš„åŸç†ï¼Œä¾ç„¶éœ€è¦ä¸€æ­¥æ­¥çš„åˆ†æå®ç°çš„ç»†èŠ‚ï¼Œè­¬å¦‚æˆ‘ä»¬å…ˆä» iterator å…¥æ‰‹ã€‚

### åˆ¶é€ è€…å’Œè¿­ä»£å™¨(Producers and Iterators)
æƒ³è±¡ä¸€ä¸‹æœ‰è¿™ä¸ªåœºæ™¯ï¼šä½ éœ€è¦ç”Ÿæˆå¤šä¸ªäº’ç›¸å…³è”çš„å€¼ï¼Œå½“å‰å€¼çš„çŠ¶æ€ä¾èµ–ä¹‹å‰çš„å€¼ã€‚ä¸ºäº†å®ç°è¿™ä¸ªéœ€æ±‚ï¼Œä¸€èˆ¬ä½ éœ€è¦ä¸€ä¸ªçŠ¶æ€ç®¡ç†å™¨ï¼Œæ¥å¸®å¿™è®°ä½æ¯ä¸€ä¸ªä¹‹å‰çš„å€¼çš„çŠ¶æ€ã€‚

æ¯”å¦‚ï¼Œå¯ä»¥å€ŸåŠ©é—­åŒ…æ¥å®ç°ï¼š

```js
var giveMeSomething = (function () {
  var nextVal;

  return function () {
    if (nextVal === undefined) {
      nextVal = 1;
    } else {
      nextVal = (3 * nextVal) + 6;
    }

    return nextVal;
  };
})();

giveMeSomething(); // 1
giveMeSomething(); // 9
giveMeSomething(); // 33
giveMeSomething(); // 105
```

é¦–å…ˆï¼Œè¿™ç§æ–¹å¼ğŸ‘†çš„å®ç°ä¼šæœ‰å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼›å…¶æ¬¡ï¼Œè‹¥æ˜¯ç”¨è¿™ç§æ–¹å¼æ¥ â€œè®°ä½â€ çš„éç®€å•ç±»å‹çš„å€¼ï¼Œé‚£ç”¨èµ·æ¥å°±å¾ˆç¹çäº†ã€‚

å®é™…ä¸Šï¼Œå¯¹äºä¸Šé¢çš„è¿™ç§æƒ…å†µï¼Œåœ¨ JS çš„å®ç°ä¸­ï¼Œå·²ç»æœ‰å¾ˆé€šç”¨çš„è§£å†³æ–¹æ¡ˆäº†ï¼šå’Œå¤§å¤šæ•°çš„è¯­è¨€ä¸€è‡´ï¼Œåœ¨ JS ä¸­ï¼Œå®ç°ä¸€å¥—è°ƒç”¨ `next()` æ–¹æ³•ï¼Œæ¥è·å¾—è¿”å›çš„å€¼çš„æœºåˆ¶ï¼Œå³å¯æ»¡è¶³è°ƒç”¨çŠ¶æ€çš„ä¿ç•™ï¼š

```js
var something = (function () {
  var nextVal;

  return {
    [Symbol.iterator]: function () {
      return this;
    },
    next: function () {
      if (nextVal === undefined) {
        nextVal = 1;
      } else {
        nextVal = (3 * nextVal) + 6;
      }

      return { done: false, value: nextVal };
    }
  }
})();

something.next().value; // 1
something.next().value; // 9
something.next().value; // 33
something.next().value; // 105
```

è°ƒç”¨ `next()` è€Œå¾—åˆ°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸¤ä¸ªå±æ€§çš„å¯¹è±¡ï¼š`done` å’Œ `value` åˆ†åˆ«ä»£è¡¨æ˜¯è¿­ä»£å®Œæˆçš„çŠ¶æ€å’Œæœ¬æ¬¡è¿­ä»£çš„å€¼ã€‚

ES6 æ–°å¢çš„ `forâ€¦of` å¾ªç¯æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å¯è‡ªåŠ¨è¿­ä»£çš„å¾ªç¯è¯­æ³•ï¼š

```js
for (const v of something) {
  console.info(v);
  if (v > 500) {
    break;
  }
}
// 1 9 33 105 321 969
```

å› ä¸º `something` è¿­ä»£å™¨è¿”å›çš„ `done` å§‹ç»ˆä¸º `false`ï¼Œå› æ­¤åªèƒ½æ‰‹åŠ¨åœ¨æ¡ä»¶æ»¡è¶³åï¼Œ`break` ç»ˆæ­¢å¾ªç¯ï¼Œå¦åˆ™å°±ä¼šä¸€ç›´å¾ªç¯ä¸‹å»ã€‚

`forâ€¦of` å¾ªç¯åœ¨æ¯æ¬¡è¿­ä»£çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šè°ƒç”¨è¢«å¾ªç¯å¯¹è±¡çš„ `next()` æ–¹æ³•ï¼Œä½†ä¸ä¼šä¼ é€’ä»»ä½•å‚æ•°è¿›å»ã€‚å½“ `done` ä¸º `true` çš„æ—¶å€™ï¼Œè‡ªåŠ¨ç»“æŸå¾ªç¯è¿­ä»£ â€”â€” è¿™æ•´ä¸ªæœºåˆ¶ååˆ†é€‚åˆç”¨æ¥éå†ä¸€ç»„æ•°æ®ã€‚

å½“ç„¶ï¼Œä½ ä¹Ÿèƒ½æ‰‹åŠ¨ä½¿ç”¨æ™®é€šçš„ `for` å¾ªç¯ï¼Œæ¥æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ï¼š

```js
for (let ret = something.next(); !ret.done; ret = something.next()) {
  console.info(ret.value);
  if (ret.value > 500) {
    break;
  }
}
```

ğŸ‘†è™½ç„¶æ²¡æœ‰ `forâ€¦of` å¾ªç¯æ¥çš„ä¼˜é›…ï¼Œä½†å¥½å¤„æ˜¯èƒ½å¤Ÿå¾€ `next(â€¦)` ä¸­ä¼ é€’éœ€è¦çš„å€¼ã€‚

è®¸å¤š JS åŸç”Ÿçš„å€¼ï¼Œéƒ½å†…ç½®äº†ä¸€ä¸ªé»˜è®¤çš„è¿­ä»£å™¨ï¼Œæ¯”å¦‚æ•°ç»„(åˆ—è¡¨)ï¼š

```js
var a = [1, 3, 5, 7, 9];

for (const val of a) {
  console.info(val);
}
// 1 3 5 7 9
```

**Note**ï¼šES6 ä¸­å¹¶æ²¡æœ‰ä¸ºæ™®é€šçš„ `object` å†…ç½®è¿­ä»£å™¨ï¼Œå…¶ä¸­ä¸€ä¸ªç¼˜ç”±æ˜¯æ²¡åŠæ³•ä¿è¯è¿­ä»£çš„é¡ºåºï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè‹¥æ˜¯æ™®é€šå¯¹è±¡å†…ç½®äº†è¿­ä»£å™¨ï¼Œé‚£ä¹ˆå…¶ä»–ç»§æ‰¿è‡ªæ™®é€šå¯¹è±¡çš„å…¶ä»–æ•°æ®ç±»å‹éƒ½ä¼šå—åˆ°å½±å“ã€‚ä½†æœ‰ä¸€ä¸ªæŠ˜ä¸­çš„åŠæ³•èƒ½è®©æ™®é€šçš„å¯¹è±¡ä¹Ÿèƒ½ç”¨ä¸Š `forâ€¦of` â€”â€” è°ƒç”¨ `Object.keys(â€¦)` APIï¼Œè·å–åŸºäºæ™®é€šå¯¹è±¡å±æ€§åçš„æ•°ç»„ï¼Œè€Œååœ¨éå†å®ƒï¼Œå¹¶æŒ¨ä¸ªå–å‡ºå±æ€§å€¼ã€‚

### å¯è¿­ä»£å¯¹è±¡(Iterable)
`iterable` å¯è¿­ä»£å¯¹è±¡å°±æ˜¯ä¸€ä¸ªåŒ…å«äº†è¿­ä»£å™¨çš„ js å¯¹è±¡ï¼Œæ¯”å¦‚ä¸Šé¢æåˆ°çš„ `something` â€”â€” å®ƒå®ç°äº† `next()` æ–¹æ³•ä»¥åŠå®šä¹‰äº† `Symbol.iterator` æ¥å£ã€‚

åœ¨ ES6 ä¸­ï¼Œä¸­å¯è¿­ä»£å¯¹è±¡ä¸­è·å–è¿­ä»£å™¨åªèƒ½é€šè¿‡è°ƒç”¨ `Symbol.iterator` æ‰€å®šä¹‰çš„å‡½æ•°ï¼Œå½“è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œåº”è¯¥è¿”å›ä¸€ä¸ªè¿­ä»£å™¨ã€‚å¹¶ä¸”ï¼Œè™½ç„¶ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œä½†æ¯æ¬¡è°ƒç”¨éƒ½åº”è¯¥è¿”å›ä¸€ä¸ªå…¨æ–°çš„è¿­ä»£å™¨ã€‚

æ¯”å¦‚ï¼Œåœ¨ä¸Šä¾‹ä¸­çš„æ•°ç»„ `a`ï¼Œå½“æŠŠå®ƒæ”¾åˆ° `forâ€¦of` å¾ªç¯ä¸­æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨å®ƒå†…ç½®çš„ `Symbol.iterator`ã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å½“ç„¶ä¹Ÿèƒ½æ‰‹åŠ¨çš„è°ƒç”¨å®ƒï¼š

```js
var a = [1, 3, 5, 7, 9];

var it = a[Symbol.iterator]();

it.next().value; // 1
it.next().value; // 3
it.next().value; // 5
```

ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ä¹‹å‰åœ¨å®šä¹‰ `something` çš„æ—¶å€™ï¼Œå®ƒçš„ `Symbol.iterator` æ˜¯è¿™æ ·å®ç°çš„ï¼š

```js
[Symbol.iterator]: function () { return this; }
```

è€Œåè‹¥æ˜¯å°†å®ƒç”¨åœ¨ `forâ€¦of` ä¸­çš„è¯ï¼š

```js
var a = [1, 3, 5, 7, 9];

for (const val of something) {
  console.info(val);
  if (val > 500) break;
}
// 1 3 5 7 9
```

ğŸ‘†è™½ç„¶çœ‹ä¸Šå»æœ‰ç‚¹æ€ªï¼Œä½†è¿™è¡Œå¾—é€šï¼Œå› ä¸ºå½“ `forâ€¦of` è°ƒç”¨ `something` çš„æ—¶å€™ï¼Œå®ƒç¡®å®šä¹‰äº† `Symbol.iterator`ï¼Œå¹¶ä¸”è¿”å›äº†å®ƒè‡ªå·± `this`ï¼Œè€Œå®ƒè‡ªå·±å®šä¹‰äº† `next()` æ–¹æ³•ï¼Œç¬¦åˆè§„èŒƒï¼Œäºæ˜¯æ¥ä¸‹å»å°±èƒ½è¿›è¡Œå¾ªç¯éå†äº†ã€‚

### ç”Ÿæˆå™¨ä¸­çš„è¿­ä»£å™¨(Generator Iterator)
ç”Ÿæˆå™¨(generator) ä»å…¶åŠŸèƒ½ä¸Šçœ‹ï¼Œå¯ä»¥å°†å…¶è§†ä¸ºæ˜¯ä¸€ä¸ªç”Ÿæˆè¿­ä»£å™¨çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸Šå®šä¹‰äº† `next()` æ–¹æ³•ã€‚

å› æ­¤ï¼Œä»æŠ€æœ¯è§’åº¦æ¥çœ‹ï¼Œgenerator å¹¶éæ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡ï¼Œå°½ç®¡å®ƒä»¬å¥½åƒå·®ä¸å¤šï¼Œä½†å½“ä½ è°ƒç”¨ generator çš„æ—¶å€™ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯ä¸€ä¸ªè¿­ä»£å™¨ï¼š

```js
function *foo() {};

var it = foo(); // it æ˜¯è¿­ä»£å¯¹è±¡
```

å½“ç„¶ï¼Œæˆ‘ä»¬åŒæ ·èƒ½å¤Ÿç”¨ generator æ¥å®ç°ä¸€ä¸ª `something`ï¼Œç”¨æ¥æ‰§è¡Œä¸€ä¸ªæ— é™å¾ªç¯çš„è¿­ä»£ï¼š

```js
function *something() {
  let nextVal;

  while (true) {
    if (nextVal === undefined) {
      nextVal = 1;
    } else {
      nextVal = (3 * nextVal) + 1;
    }

    yield nextVal;
  }
}
```

**Note**ï¼šè™½ç„¶éå¸¸ä¸æ¨èï¼Œåœ¨çœŸå®çš„ä»£ç ä¸­ä½¿ç”¨ä¸å¸¦ä»»ä½• `break` æˆ– `return` è¯­å¥çš„ `while(true) {â€¦}` â€”â€” å› ä¸ºè¿™æ ·ä¼šé€ æˆæµè§ˆå™¨çš„UIçº¿ç¨‹å¡æ­»ï¼›ä½†åœ¨ generator ä¸­ï¼Œå¹¶æ²¡æœ‰è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸º generator ä¸­æ¯ä¸€æ¬¡çš„ `yield` ä¼šæš‚åœ `while(true) {â€¦}`ï¼Œç­‰åˆ° JSä¸»çº¿ç¨‹ çš„ä»£ç éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œæ‰ä¼šå†æ¬¡æ‰§è¡Œã€‚

ç”±äºæ¯æ¬¡ `yield` éƒ½ä¼šä¿ç•™ `*something()` çš„è°ƒç”¨æ ˆï¼Œå› æ­¤ä¹Ÿç”¨ä¸ç€ç”¨ä¸€å¥—å¾ˆå…«è‚¡çš„æ¨¡æ¿ï¼Œé…åˆé—­åŒ…(closure)ï¼Œæ¥å®Œæˆå¯¹å½“å‰è°ƒç”¨æ ˆçš„çŠ¶æ€è®°å½• â€”â€” è¿™å¯ä¸æ˜¯ä»…ä»…ç®€åŒ–äº†ä»£ç è€Œå·² â€”â€” ä¸ä»…ä¸ç”¨è‡ªå·±æ‰‹åŠ¨å®šä¹‰ iterator æ¥å£ï¼Œè€Œä¸”ä»£ç ä¹Ÿæ›´è¯­ä¹‰åŒ–ï¼Œèƒ½å¤Ÿæ¸…æ¥šçš„è¡¨è¾¾å®ƒçš„èŒè´£æ‰€åœ¨ã€‚æ¯”å¦‚ï¼Œ`while(true) {â€¦}` å¾ªç¯å°±æ˜¯å‘Šè¯‰æˆ‘ä»¬ generator å¯ä»¥æ— é™æ‰§è¡Œä¸‹å»ã€‚

æŠŠ `*something()` å’Œ `forâ€¦of` å¾ªç¯ç»„åˆèµ·æ¥çœ‹çœ‹å’Œä¹‹å‰çš„åŒºåˆ«ï¼š

```js
for (const v of something()) {
  console.info(v);
  if (v > 500) {
    break;
  }
}
// 1 9 33 105 321 969
```

å€˜è‹¥æ˜¯ä½ ä»”ç»†è§‚å¯ŸğŸ‘†ä¸Šé¢çš„ä»£ç ï¼Œé€šå¸¸ä¼šæœ‰å‡ ä¸ªç–‘é—®ï¼š

  1. ä¸ºå•¥ä¸ç›´æ¥è°ƒç”¨ `for (const v of something) {â€¦}` è€Œæ˜¯ `const v of something()` å‘¢ï¼Ÿ

  2. è°ƒç”¨ `something()` ç”Ÿæˆçš„æ˜¯ä¸ªè¿­ä»£å™¨ï¼Œä½†ä¸ºä¹‹å‰è¯´è¿‡ï¼Œå¯ç”¨ `forâ€¦of` éå†çš„æ˜¯ä¸€ä¸ªå¯è¿­ä»£çš„å¯¹è±¡æ˜¯å§ï¼Ÿ

é’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œ`something` ä»…ä»…æ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œ`forâ€¦of` å¾ªç¯å¯ä¸èƒ½éå†å®ƒï¼›è€Œç¬¬äºŒä¸ªé—®é¢˜ï¼Œgenerator è¿”å›çš„è¿­ä»£å™¨åŒæ ·å®šä¹‰äº† `Symbol.iterator` çš„å‡½æ•°ï¼Œå¹¶ä¸”å®ƒçš„è¿”å›å€¼ä¾æ—§æ˜¯ `this`ã€‚

#### åœæ­¢ç”Ÿæˆå™¨(Stopping the Generator)
åœ¨ä¹‹å‰çš„ä»£ç ä¸­ï¼Œå½“ `*something()` é‡åˆ° `break` è¯­å¥åï¼Œä¼šä¸€ç›´ä¿ç•™å…¶è°ƒç”¨æ ˆä¹ˆï¼Ÿç­”æ¡ˆå½“ç„¶æ˜¯å¦å®šçš„ï¼šå½“`forâ€¦of` å¾ªç¯å‘ç”Ÿäº† "éæ­£å¸¸å®Œç»“(Abnormal completion)" å â€”â€” é€šå¸¸æ˜¯ç”± `break`ã€`return` æˆ– æœªæ•è·çš„å¼‚å¸¸(uncaught exception) å¯¼è‡´ â€”â€” æ­¤æ—¶ generator å°±ä¼šæ¥å—åˆ°ç»ˆæ­¢çš„ä¿¡å·ã€‚

**Note**ï¼šä»æŠ€æœ¯è§’åº¦è®²ï¼Œå½“æ­£å¸¸çš„éå†ç»“æŸæ˜¯ï¼Œ`forâ€¦of` å¾ªç¯ä¼šç»™è¿­ä»£å™¨å‘é€ä¸€ä¸ªç»ˆæ­¢ä¿¡å·ã€‚å¯¹äº generator ç”Ÿæˆçš„è¿­ä»£å™¨ï¼Œè¿™æ ·çš„ç»“æŸä¿¡å·å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œå› ä¸º generator çš„è¿­ä»£å™¨ä¼šæ—©ä¸€æ­¥ `forâ€¦of` è‡ªåŠ¨ç»“æŸè¿­ä»£ã€‚ä½†æ˜¯ï¼Œå¯¹äºè‡ªå®šä¹‰çš„è¿­ä»£å™¨ï¼Œè¿™ä¸ªæ­£å¸¸ç»“æŸéå†ä¿¡å·ï¼Œæœ‰æ—¶å€™å°±æ˜¾å¾—å¾ˆæœ‰ä»·å€¼äº†ã€‚

`forâ€¦of` ä¼šè‡ªåŠ¨è§¦å‘ç»“æŸä¿¡å·å¹¶å‘é€ç»™è¿­ä»£å™¨ï¼Œè‹¥æ˜¯æƒ³è¦æ‰‹åŠ¨è§¦å‘çš„è¯ï¼Œå¯ä»¥è°ƒç”¨è¿­ä»£å™¨ä¸Šå®šä¹‰çš„ `return(â€¦)` æ–¹æ³•ã€‚

åœ¨ generator ä¸­å®šä¹‰çš„ `tryâ€¦finally` åœ¨æœ‰ä¸€ä¸ªå¦™ç”¨ â€”â€” å½“è§¦å‘ç»“æŸä¿¡å·çš„æ—¶å€™ï¼Œä½ å¯ä»¥åœ¨ `finally` è¯­å¥ä¸­åšä¸€äº›æ”¶å°¾çš„å·¥ä½œï¼Œæ¯”å¦‚æ¸…é™¤ç¼“å­˜ã€æ–­å¼€æ•°æ®åº“é“¾æ¥å•¥çš„ï¼š

```js
function *something() {
  try {
    let nextVal;

    while (true) {
      if (nextVal === undefined) {
        nextVal = 1;
      } else {
        nextVal = (3 * nextVal) + 1;
      }

      yield nextVal;
    }
  } finally {
    console.info('cleaning up!');
  }
}
```

åœ¨å¤–éƒ¨æ‰‹åŠ¨çš„è°ƒç”¨ `return()` æ¥ç»“æŸè¿­ä»£ï¼š

```js
const it = something();
for (const v of it) {
	console.info(v);

	if (v > 500) {
		console.info(it.return('Hello World').value);
	}
}
// 1 9 33 105 321 969
// cleaning up!
// Hello World
```

`it.return(â€¦)` ä¼šç«‹å³ç»“æŸ generatorï¼Œè€Œåæ‰§è¡Œ `finally` é‡Œé¢çš„ä»£ç ã€‚ä¼ å…¥çš„å€¼ `'Hello World'` ä¼šç›´æ¥è¿”å›åˆ°å±æ€§ `value` ä¸­ï¼Œæ­¤æ—¶è¿”å›çš„ `done` ä¸º `true`ï¼Œå› æ­¤ `forâ€¦of` ä¼šç»“æŸéå†ã€‚

ä»¥ä¸Šç§ç§ï¼Œä»…ä»…æ˜¯ generator ä½¿ç”¨çš„å†°å±±ä¸€è§’ã€‚æ¥ä¸‹å»æˆ‘ä»¬è¦æ¢è®¨çš„æ‰æ˜¯ generator æœ€æ ¸å¿ƒçš„ä½¿ç”¨æ–¹å¼ â€”â€” é…åˆå¼‚æ­¥ä½¿ç”¨ã€‚

## ç”Ÿæˆå™¨å¼‚æ­¥çš„è¿­ä»£(Iterating Generators Asynchronously)
é‚£ä¹ˆï¼Œgenerator åˆ°åº•è§£å†³äº†å¼‚æ­¥ç¼–ç¨‹ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ

å…ˆå¿«é€Ÿå›é¡¾ä¸‹ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ â€”â€” å›è°ƒå‡½æ•°ï¼š

```js
function foo(x, y, cb) {
  ajax(
    'http://some.url.1/?x=' + x + '&y=' + y,
		cb
  );
}

foo(11, 31, function (err, txt) {
  if (err) {
    console.error(err);
  } else {
    console.log(txt);
  }
});
```

è‹¥æ˜¯å°†ä¸Šé¢ğŸ‘†çš„ä»£ç æ”¹å†™æˆ generator æ¥å®ç°ğŸ‘‡çš„è¯ï¼š

```js
function *main() {
  try {
    var txt = yield bar(11, 31);
    console.log(txt);
  } catch (err) {
    console.error(err);
  }
}

var it = main();

function bar(x, y) {
  ajax(
    'http://some.url.1/?x=' + x + '&y=' + y,
		function (err, data) {
      if (err) {
        it.throw(err);
      } else {
        it.next(data);
      }
    }
  );
}

it.next();
```

ç¬¬ä¸€çœ¼çœ‹ä¸Šå»ï¼Œå¥½åƒ generator çš„å®ç°çš„å¼‚æ­¥ä»£ç åˆè‡­åˆé•¿ã€‚ä½†åƒä¸‡åˆ«è¢«è¡¨åƒè¿·æƒ‘ï¼Œgenerator çš„å®ç°å®é™…ä¸Šè¦æ¯”å›è°ƒçš„å®ç°å¥½å¾ˆå¤šï¼Œå°±æ¯”å¦‚å¯¹æ¯”ä¸‹é¢è¿™ä¸¤æ®µè¿™æ®µä»£ç ï¼š

ä¸€ä¸ª `yield` å°±èƒ½åŒæ­¥è·å–åˆ°å†…å®¹ï¼š
  ```js
    var txt = yield bar(11, 31);
    console.log(txt);
  ```

è€Œè‹¥æ˜¯ç›´æ¥è°ƒç”¨ `foo(â€¦)` çš„è¯ï¼Œ`txt` å´æ ¹æœ¬æ²¡åŠæ³•æ‹¿åˆ°ç½‘ç»œè¯·æ±‚è¿”å›çš„å†…å®¹ï¼š
  ```js
    var txt = foo(
      11, 31,
      function (err, data) {
        //â€¦â€¦
      }
    );
    console.log(txt);
  ```

ä»…ä»…é€šè¿‡ `yield` å…³é”®å­—ï¼ŒğŸ‘†æˆ‘ä»¬å°±å®ç°äº†ä¸€æ®µçœ‹ä¸Šå»åƒåŒæ­¥ä»£ç çš„å¼‚æ­¥ç¼–ç¨‹ï¼Œå¹¶ä¸”åœ¨ `bar(â€¦)` ä¸­å±è”½äº†å¼‚æ­¥çš„ç»†èŠ‚ â€”â€” è¿™è§£å†³äº†ä¹‹å‰æˆ‘ä»¬æåŠçš„ *å›è°ƒå‡½æ•°çš„æ‰§è¡Œå’Œæˆ‘ä»¬å¤§è„‘çš„å·¥ä½œæ–¹å¼ä¸åŒ¹é…* é—®é¢˜ã€‚

æœ¬è´¨ä¸Šæ¥çœ‹ï¼Œè¿™ä¸€åˆ‡çš„å®ç°æ˜¯åŸºäºå°†å¼‚æ­¥ä»£ç çš„ç»†èŠ‚æŠ½è±¡å‡ºæ¥ï¼Œè€Œåæˆ‘ä»¬åªç”¨æŒ‰ç…§ *æœ‰åºçš„æµ* ä¸€æ ·çš„åŒæ­¥çš„ä»£ç æ¥å®ç°å…·ä½“ç»†èŠ‚å³å¯ã€‚

### åŒæ­¥ä»£ç çš„é”™è¯¯å¤„ç†
æ—¢ç„¶æ˜¯ä»¥åŒæ­¥çš„æ–¹å¼æ¥ä¹¦å†™çš„å¼‚æ­¥ä»£ç ï¼Œé‚£ä¹ˆå¯¹äºé”™è¯¯çš„å¤„ç†ï¼Œ`tryâ€¦catch` ä¾ç„¶æ˜¯ä¸äºŒçš„é€‰æ‹©ï¼š

```js
try {
  var txt = yield bar(11, 31);
  console.log(txt);
} catch (err) {
  console.error(err);
}
```

è¿™ä¸€åˆ‡èƒ½å¤Ÿå®ç°ï¼Œéƒ½æºäº `yield` çš„æš‚åœæœºåˆ¶ â€”â€” ä¸ä»…èƒ½å¤Ÿæš‚åœåç»­ä»£ç çš„è¿è¡Œï¼Œç­‰å¾…å¼‚æ­¥çš„å›è°ƒå‡½æ•° `return` çš„å€¼ï¼Œè€Œåæ¢å¤ä»£ç çš„æ‰§è¡Œï¼›åŒæ ·çš„ï¼Œå¯¹äºå¼‚æ­¥å‡½æ•°é‡Œæ‰€äº§ç”Ÿçš„é”™è¯¯ï¼ŒåŒæ ·å¯ä»¥ä»¥åŒæ­¥çš„æ–¹å¼è·å–åˆ°ï¼›å¹¶ä¸”ï¼Œæ— è®ºè¿™ä¸ªé”™è¯¯æ˜¯äº§ç”Ÿåœ¨ generator å‡½æ•°å†…ï¼Œè¿˜æ˜¯å‡½æ•°å¤–ï¼š

æ¯”å¦‚åœ¨ generator å‡½æ•°å¤–ï¼Œé€šè¿‡è¿­ä»£å¯¹è±¡è°ƒç”¨ `throw(â€¦)` æ–¹æ³•ï¼Œæ‰‹åŠ¨è§¦å‘çš„é”™è¯¯ï¼š

  ```js
    function *main() {
      var x = yield 'Hello Generator';
      console.log(x);
    }

    var it = main();
    it.next();
    try {
      it.throw(42);
    } catch (err) {
      console.error(err); // 42
    }
  ```

åˆæ¯”å¦‚ï¼Œç›´æ¥åœ¨ generator å‡½æ•°å†…äº§ç”Ÿçš„é”™è¯¯ï¼š

  ```js
    function *main() {
      var x = yield 'Hello Generator';
      yield x.toLowerCase(); // x éå­—ç¬¦ä¸²ï¼Œè°ƒç”¨ toLowerCase æ–¹æ³•ä¼šå¯¼è‡´é”™è¯¯
    }

    var it = main();

    it.next();

    try {
      it.next(42); // x ä¸ºæ•°å­— 42
    } catch (err) {
      console.error(err); // TypeError
    }
  ```

  æˆ–è€…åœ¨ generator å‡½æ•°å†…éƒ¨å°±æå®šï¼š

  ```js
    function *main() {
      try {
        var x = yield 'Hello Generator';
        var y = yield x.toLowerCase();
      } catch (err) {
        console.error(err); // TypeError
      }
    }

    var it = main();
    it.next();
    it.next(42);
  ```

æ— è®ºæ˜¯æ‰‹åŠ¨è§¦å‘çš„é”™è¯¯ï¼Œè¿˜å·® generator å‡½æ•°è‡ªèº«çš„é”™è¯¯ï¼Œé€šè¿‡ `tryâ€¦catch` çš„æ•è·ï¼Œåœ¨ generator å†…éƒ¨ï¼Œå°±æœ‰å¤„ç†é”™è¯¯çš„æœºä¼šï¼›ä½†æ˜¯å½“å…¶å†…éƒ¨æ²¡æœ‰é”™è¯¯å¤„ç†çš„æ—¶å€™ï¼Œåœ¨ generator å‡½æ•°çš„å¤–éƒ¨ä¸€å®šè¦æå®šè¿™äº›ã€‚

åœ¨ generator ä¸­ï¼Œèƒ½å¤Ÿé€šè¿‡ `tryâ€¦catch` æ¥å®ç°åŒæ­¥çš„é”™è¯¯å¤„ç†ï¼Œåœ¨å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ä¸Šéƒ½æ˜¯ä¸€ä¸ªå·¨å¤§çš„èƒœåˆ©ã€‚

## Generators + Promises
åœ¨ä¹‹å‰çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° generator ç›¸å¯¹äºæ„å¤§åˆ©é¢æ¡å¼çš„å›è°ƒåœ°ç‹±ï¼Œåœ¨æŒ‰ç…§å¤§è„‘å·¥ä½œçš„å¿ƒæ™ºæ¨¡å‹ä¹‹ä¸Š â€”â€” æŒ‰é¡ºåºç†è§£ â€”â€” æœ‰äº†å·¨å¤§çš„è¿›æ­¥ï¼Œä½†ç›¸å¯¹ä¹‹å‰ Promise å¸¦æ¥çš„å¯ä¿¡ä»»å’Œå¯ç»„åˆçš„æå‡å´æŸæ‰‹æ— æªã€‚

æ˜¾ç„¶ï¼Œè‹¥æ˜¯å°† generator + Promise ç»„åˆ â€”â€” ç”¨åŒæ­¥æ¨¡å¼æ¥ä¹¦å†™å¼‚æ­¥ä»£ç  + å¯ä¿¡ä»»å’Œå¯ç»„åˆ â€”â€” æ˜¯å‹æ­» å›è°ƒå‡½æ•° çš„æœ€åä¸€æ ¹ç¨»è‰ã€‚

æ¯”å¦‚ä¹‹å‰ä½¿ç”¨ Promise æ¥å®è¡Œ Ajax è¯·æ±‚çš„ä»£ç ï¼š

```js
function foo (x, y) {
  return request("http://some.url.1/?x=" + x + "&y=" + y);
}

foo(11, 31)
  .then(
    function (txt) {
      console.log(txt);
    },
    function (err) {
      console.error(err);
    }
  );
```


ğŸ‘†è‹¥æ˜¯ç”¨ generator å¯¹å…¶è¿›è¡Œæ”¹é€ çš„è¯ï¼Œæ¯”å¦‚ç”¨ `yield` å…³é”®å­—å°† `foo(â€¦)` ä¸­åˆ›å»ºå¹¶è¿”å› Promise æ‹¿åˆ°ï¼Œé‚£ iterator è¿­ä»£å™¨å°±èƒ½æ‹¿åˆ°è¿™ä¸ª Promiseã€‚

ä½†æ˜¯ iterator åº”è¯¥å¯¹ Promise åšç‚¹å•¥å‘¢ï¼Ÿ

å½“ç„¶åº”è¯¥ç›‘å¬ Promise çš„ resolveï¼Œè€Œåç»§ç»­æ¢å¤ generator çš„æ‰§è¡Œï¼Œå¹¶ä¸”å°† fulfill æˆ– reject çš„ä¿¡æ¯è¿”å›å‡ºæ¥ã€‚

ç®€å•åœ°é‡å¤ä¸€éï¼Œ`yield` ä¸€ä¸ª Promise å¹¶ä¸”ç”¨ generator çš„è¿­ä»£å™¨å»æ§åˆ¶ Promiseï¼Œæ‰èƒ½å‘æŒ¥è¿™ä¸ªç»„åˆçš„æœ€å¤§æ½œèƒ½ã€‚

è¯•ä¸€ä¸‹ï¼š

```js
function foo (x, y) {
  return request("http://some.url.1/?x=" + x + "&y=" + y);
}

function *main () {
  try {
    var txt = yield foo(11, 31);
    console.log(txt);
  } catch (err) {
    console.error(err);
  }
}
```

`*main()` æœ€ç‰›é€¼çš„åœ°æ–¹åœ¨äºå¯¹äº `foo()` å†…éƒ¨çš„é€»è¾‘ **å•¥éƒ½ä¸ç”¨æ”¹** â€”â€” æ— è®º `yield` æ‹¿åˆ°æ˜¯ä½•å€¼ã€‚

ä¸è¿‡åç»­ä»£ç è¿˜éœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼š

```js
var it = main();

var p = it.next().value;

p.then(
  function (txt) { it.next(txt); },
  function (err) { it.throw(err); }
)
```

ğŸ‘†ä¸éœ€è¦ä½¿ç”¨ `error-first callback` æ¥ç‰¹åˆ«çš„åœ¨ generator ä¸­å¤„ç†å¼‚å¸¸ï¼Œå› ä¸º Promise å·²ç»æ¸…æ™°åœ°å°† fulfillment å’Œ rejection åˆ†å¼€äº†ã€‚

ä¸è¿‡åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸Šé¢çš„å®ç°ä¾æ—§æœ‰äº›é—®é¢˜éœ€è¦è§£å†³ï¼š

  1. å¦‚ä½•é«˜æ•ˆåœ°æ‰§è¡Œå¤šä¸ª Promise â€”â€” æˆ‘ä»¬è‚¯å®šä¸æƒ³è¦æ‰‹åŠ¨çš„ç®¡ç† Promise çš„é“¾å¼è°ƒç”¨ï¼Œæœ€å¥½èƒ½æœ‰ä¸€ä¸ªå·¥å…·å¸®æˆ‘ä»¬è‡ªåŠ¨çš„è°ƒç”¨ generator è¿”å›çš„è¿­ä»£å™¨ï¼›

  2. åœ¨æ‰§è¡Œ `it.next(â€¦)` æ—¶ï¼Œè‹¥å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿé€€å‡ºæ•´ä¸ª generator çš„æ‰§è¡Œï¼Ÿæˆ–æ˜¯æ•è·åˆ°é”™è¯¯è€Œåç›´æ¥ä½œä¸ºå€¼è¿”å›ï¼Ÿé‚£è¦æ˜¯åœ¨ generator å‡½æ•°ä¸­æ˜¾ç¤ºçš„è°ƒç”¨äº† `it.throw(â€¦)` å‘¢ï¼Ÿ

### ä¸€ä¸ªç”±Promiseå’ŒGeneratorç»“åˆè€Œæˆçš„Runner(Promise-Aware Generator Runner)
åœ¨è¶Šå‘æ·±å…¥çš„æ¢ç´¢ä¹‹åï¼Œæ˜¾ç„¶ä¸€ä¸ªèƒ½è‡ªåŠ¨å¸®ä½ æå®š Promise + Generator ç»„åˆçš„å·¥å…·ä¼šæ˜¾å¾—ååˆ†æœ‰å¿…è¦ã€‚

æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹çš„åº“æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä¸ºäº†å­¦ä¹ èµ·è§ï¼Œè¿˜æ˜¯è¦æ‰‹åŠ¨çš„å®šä¹‰ä¸€ä¸ªç®€å•çš„ `run(â€¦)` æ¥åšå±•ç¤ºï¼š

```js
function run (gen) {
  // å…¶ä»–å‚æ•°å¤„ç†
  var args = [].slice().call(arguments, 1);

  // è°ƒç”¨ generator è·å¾— iterator è¿­ä»£å™¨
  var it = gen.apply(this, args);

  // é¦–æ¬¡è°ƒç”¨ iterator å¹¶ä¸éœ€è¦å‚æ•°
  return Promise.resolve()
    .then(function handleNext(value) {
      var next = it.next(value);

      return (function handleResult(next) {
        if (next.done) {
          // è¿­ä»£ç»“æŸï¼Œç›´æ¥è¿”å›å€¼
          return next.value;
        } else {
          return Promise.resolve(next.value)
            .then(
              // é€’å½’è°ƒç”¨handleNextï¼Œå¹¶å°†å½“å‰å€¼ç›´æ¥ä¼ é€’è¿›å»
              handleNext,
              // è‹¥æ˜¯è¿”å›ä¸€ä¸ª rejected çš„ Promise
              // it.throw(err) ä¼šè¿›å…¥åˆ°è‡ªå®šä¹‰çš„é”™è¯¯å¤„ç†ä¸­ï¼Œå®ƒçš„è¿”å›å€¼
              function handleErr(err) {
                return Promise.resolve(it.throw(err)).then(handleResult);
              }
            )
        }
      })(next);
    });
}
```

ç”¨ `run(â€¦)` æ¥è¿è¡Œä¹‹å‰çš„ `*main()` çš„è¯ï¼Œå°±èƒ½å®ç°è‡ªåŠ¨å®Œæˆæ‰€æœ‰çš„è¿­ä»£å·¥ä½œï¼š

```js
run(main);
```

#### ES7: `async` and `await`
`run()` èƒ½å¤Ÿè‡ªåŠ¨çš„å®Œæˆä¸€äº›é‡å¤çç¢çš„å·¥ä½œï¼Œä¸è¿‡åœ¨ ES7 ä¸­è½åœ°çš„ `async` å’Œ `await` æ˜¯JSå†…ç½®çš„è¯­æ³•ç³–ï¼Œèƒ½å¤Ÿæ›´ä¸ºç®€ç»ƒçš„æå®šè¿™ä¸€åˆ‡ï¼š

```js
function foo (x, y) {
  return request("http://some.url.1/?x=" + x + "&y=" + y);
}

async function main() {
  try {
    var txt = await foo(11, 31);
    console.log(txt);
  } catch (err) {
    console.error(err);
  }
}

main();
```

Tip: JS çš„ `async`/`await` çš„è¯­æ³•ï¼Œå…¶å®æ˜¯å€Ÿé‰´äº† C# ä¸­çš„æ€æƒ³ï¼Œè€Œä¸”æœ¬è´¨ä¸Šæ¥çœ‹ä¹Ÿæ˜¯åœ¨è§£å†³ç›¸åŒçš„é—®é¢˜ã€‚

`main()` è™½ç„¶å’Œæ™®é€šçš„å‡½æ•°è°ƒç”¨æ²¡å•¥ä¸¤æ ·ï¼Œä½†åœ¨å…¶å†…éƒ¨çš„ `await` ä¼šé˜»å¡åé¢ä»£ç çš„æ‰§è¡Œï¼Œåªæœ‰åœ¨å®ƒåé¢çš„ Promise çš„çŠ¶æ€ç¡®å®šåï¼Œæ‰ä¼šæ¢å¤æ‰§è¡Œã€‚

### Promise åœ¨ Generator ä¸­çš„å¹¶å‘æ‰§è¡Œ(Promise Concurrency in Generator)
ä¹‹å‰æˆ‘ä»¬è®¨è®ºçš„éƒ½æ˜¯å•ä¸ªçš„å¼‚æ­¥ä»»åŠ¡ï¼Œä½†æ˜¯åœ¨ç°å®ä¸­ï¼Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡åœ¨ä¸€ä¸ªå‡½æ•°ä¸­æ‰§è¡Œæ˜¯åœ¨æ˜¯å¤ªå¸¸è§äº†ï¼Œè€Œä¸”è‹¥æ˜¯ä¸å½“å¿ƒçš„è¯ï¼Œå¾ˆå¯èƒ½ä½ ä¼šå¾—å†™å‡ºä¸€æ®µæ€§èƒ½å¾ˆå·®çš„ä»£ç  â€”â€” æ¯”å¦‚æœ‰ä¸ªåœºæ™¯è¦æ±‚ä½ å…ˆå‘é€ä¸¤ä¸ªå¼‚æ­¥çš„è¯·æ±‚è·å–åˆ°ä¸åŒçš„æ•°æ®ï¼Œè€Œåå°†å®ƒä»¬ç»„è£…åœ¨ä¸€èµ·ï¼Œå†å‘é€ç¬¬ä¸‰ä¸ªè¯·æ±‚æ‹¿åˆ°æœ€ç»ˆçš„æ•°æ®ï¼š

```js
function *foo (x, y) {
  var r1 = yield request("http://some.url.1");
  var r2 = yield request("http://some.url.2");

  var r3 = yield request("http://some.url.3/?" + r1 + r2);

  console.log(r3);
}

run(foo);
```

ğŸ‘†è¿™æ®µç”¨ Generator å®ç°çš„å¼‚æ­¥ä»£ç çš„é—®é¢˜å¾ˆæ˜æ˜¾ â€”â€” `r1` å’Œ `r2` æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå› æ­¤æ˜æ˜å¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œä½†åœ¨æœ€ç»ˆå´æ˜¯ä¸²è¡Œ â€”â€” `r2` è¦ç­‰åˆ° `r1` æ‰§è¡Œå®Œæ¯•åæ‰ä¼šç»§ç»­æ‰§è¡Œã€‚ä½†é—®é¢˜åœ¨äºè¯´ï¼Œ`yield` åªèƒ½æš‚åœä¸€ä¸ªç‚¹ï¼Œä¸èƒ½åŒæ—¶ä½œç”¨äºå¤šä¸ªç‚¹â€¦â€¦

ä¸€ä¸ªç®€å•çš„è§£å†³åŠæ³•æ˜¯ä½¿ç”¨ *æ—¶é—´ç‹¬ç«‹(time-independent)* çš„æ€è·¯ï¼š

```js
function *foo (x, y) {
  var p1 = request("http://some.url.1");
  var p2 = request("http://some.url.2");

  var r1 = yield p1;
  var r2 = yield p2;
  var r3 = yield request("http://some.url.3/?" + r1 + r2);

  console.log(r3);
}

run(foo);
```

ğŸ‘†æœ¬è´¨ä¸Šæ¥çœ‹ï¼Œå› ä¸ºå‘é€ä»»åŠ¡ `request(â€¦)` çš„è¿‡ç¨‹å¯ä»¥çœ‹åšæ˜¯å¹¶å‘çš„ï¼Œå› æ­¤åœ¨ä»…ä»…æ”¹å˜äº† `yield` çš„ä½œç”¨å¯¹è±¡çš„æ—¶æœºï¼Œå°±èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

äº‹å®ä¸Šï¼Œä½¿ç”¨ `Promise.all([â€¦])` åŒæ ·ä¹Ÿèƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

```js
function *foo (x, y) {
  var results = yield Promise.all([
    request("http://some.url.1"),
    request("http://some.url.2")
  ])

  var r1 = results[0];
  var r2 = results[1];
  var r3 = yield request("http://some.url.3/?" + r1 + r2);

  console.log(r3);
}

run(foo);
```

ğŸ‘†è¿™å…¶å®æ˜¯å°†åŸæœ¬å¤šä¸ªå¼‚æ­¥ä»»åŠ¡éƒ½æ”¾åˆ°ä¸€ä¸ªå¤§çš„å¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œè€Œåé€šè¿‡ `yield` æ•´ä¸ªå¤§çš„å¼‚æ­¥ä»»åŠ¡ï¼Œå°±å®Œæˆäº†å¹¶å‘çš„å¼‚æ­¥ä»»åŠ¡ã€‚

#### ç»†èŠ‚çš„éšè—(Promise, Hidden)
å±è”½ç»†èŠ‚ï¼Œç‰¹åˆ«æ˜¯åœ¨ Generator ä¸­çš„ Promise å®ç°ç›¸å…³çš„ç»†èŠ‚ï¼Œä»ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§éƒ½æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼š

```js
function bar(url1, url2) {
  return Promise.all([
    request(url1),
    request(url2)
  ]);
}

function *foo (x, y) {
  var results = yield bar("http://some.url.1", "http://some.url.2");

  var r1 = results[0];
  var r2 = results[1];
  var r3 = yield request("http://some.url.3/?" + r1 + r2);

  console.log(r3);
}

run(foo);
```

**æˆ‘ä»¬æŠŠå¼‚æ­¥çš„ä»£ç ï¼Œå³ Promise çš„éƒ¨åˆ†ï¼Œè§†ä¸ºå®ç°çš„ç»†èŠ‚ã€‚**

æ— è®º Promise ç›¸å…³çš„é€»è¾‘æœ‰å¤šä¹ˆå¤æ‚ï¼Œåœ¨ Generator ä¸­ä½ åªéœ€è¦å…³å¿ƒå¼‚æ­¥æ‰§è¡Œçš„æ­¥éª¤ â€”â€” å› ä¸ºå†™ä¸€æ®µä»£ç é™¤äº†è®©å…¶èƒ½å¤Ÿæ­£å¸¸çš„å·¥ä½œå¹¶ä¸”å…·æœ‰ä¸é”™çš„æ€§èƒ½ä¹‹å¤–ï¼Œè¿˜è¦è€ƒè™‘åˆ°ä»£ç çš„æ˜“è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

**Note**ï¼šå¯¹ä»£ç è¿›è¡Œæ›´é«˜ç»´åº¦çš„æŠ½è±¡ï¼Œä¸ä¸€å®šç™¾åˆ†ä¹‹ç™¾éƒ½æ˜¯å¥½äº‹ï¼Œå› ä¸ºè¿™æœ‰äº‹ä¹Ÿä¼šæå¤§çš„å¢åŠ ä»£ç çš„å¤æ‚ç¨‹åº¦ï¼Œé™ä½äº†ä»£ç çš„ç®€æ´æ€§ã€‚ä¸è¿‡è¿˜æ˜¯é‚£å¥è¯ï¼Œå‡¡æ˜¯éƒ½æ²¡é‚£ä¹ˆç»å¯¹ï¼Œæ ¹æ®è‡ªèº«å’Œå›¢é˜Ÿçš„çœŸå®æƒ…å†µæ¥åšå‡ºé€‰æ‹©ï¼Œæ˜¾ç„¶æ˜¯æ›´ä¸ºåˆç†çš„ã€‚

## Generator ä»£ç†(Generator Delegation)

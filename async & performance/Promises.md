# Promises
é€šè¿‡å‰é¢ä¸€èŠ‚çš„æ·±å…¥æ¢è®¨ï¼Œæˆ‘ä»¬å·²ç»å¾ˆæ¸…æ¥š å›è°ƒå‡½æ•° æ‰€é¢ä¸´çš„é—®é¢˜äº† â€”â€” ä¹¦å†™çš„åäººæ€§å’Œä¿¡ä»»é—®é¢˜ã€‚æ˜¾ç„¶æœ€ä¸ºå¤´ç–¼çš„æ˜¯ç”±äº *æ§åˆ¶åè½¬(inversion of control)* æ‰€å¸¦æ¥çš„ä¿¡ä»»é—®é¢˜ã€‚å¹¸å¥½åœ¨ ES6 ä¸­å·²ç»æä¾›äº†å†…ç½®çš„ API æ¥è§£å†³è¿™ä¸ªé—®é¢˜ â€”â€” Promiseã€‚

## Promiseæ˜¯ä»€ä¹ˆï¼Ÿ(What Is a Promise?)
è®¸å¤šå¼€å‘è€…å­¦ä¹ ä¸€ä¸ªæ–°æŠ€æœ¯çš„ç¬¬ä¸€æ­¥é€šå¸¸æ˜¯ç›´æ¥æ’¸ä»£ç ï¼Œæå‡ºä¸€ä¸ª â€œHello Worldâ€ ä»€ä¹ˆçš„ã€‚å½“ç„¶è¿™æ²¡ä»€ä¹ˆä¸å¥½ï¼Œä¸è¿‡æƒ³è¦æ·±å…¥ç†è§£ Promiseï¼Œä»¥åŠå®ƒèƒŒåæ‰€éšå«çš„ç†è®ºï¼Œä¸å¦¨å…ˆä»ä¸¤ä¸ªç±»æ¯”å¼€å§‹ï¼š

### æœªæ¥çš„å€¼(Future Value)
æƒ³è±¡ä¸€ä¸ªåœ¨ç°å®ä¸–ç•Œä¸­å¸¸è§çš„åœºæ™¯ï¼šå½“ä½ èµ°è¿›ä¸€å®¶å¿«é¤åº—(KFCå•¥çš„)çš„å‰å°ï¼Œå‡†å¤‡ä¹°ä¸€ä¸ªæ±‰å ¡å¥—é¤æ¥è§£å†³åˆé¥­æ—¶ï¼Œä½ é€šå¸¸æ˜¯å…ˆä»˜é’±ï¼Œè€Œåæ‹¿åˆ°ä¸€å¼ å°ç¥¨ï¼Œä¸Šé¢æœ‰ä¸€ä¸ªæ•°å­—ï¼Œä»£è¡¨çš„å°±æ˜¯â€œæˆ‘æ¬ ä½ ä¸€ä»½æ±‰å ¡å¥—é¤â€çš„ *æ‰¿è¯º(promise)* â€”â€” é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ æœ€ç»ˆä¼šå‡­æ­¤æ‹¿åˆ°ä¸€ä»½æ±‰å ¡å¥—é¤ã€‚

åœ¨ç­‰å¾…æ±‰å ¡å¥—é¤çš„æ—¶é—´é‡Œï¼Œä½ ä¼šå¹²ä»€ä¹ˆå‘¢ï¼Ÿæ‰“å¼€æ‰‹æœºç¿»ç¿»æœ‹å‹åœˆï¼Ÿç»™æŸäººå‘ä¸ªæ¶ˆæ¯è¯´å¾…ä¼šåƒå®Œä¸­é¥­å»æ‰¾ä»–èŠèŠå¤©ï¼Ÿæˆ–è€…æµè§ˆä¸‹æœ€æ–°çš„çƒ­ç‚¹æ–°é—»ï¼Ÿâ€¦â€¦åæ­£ä¸ä¼šçç­‰åœ¨é‚£é‡Œå°±å¯¹äº† â€”â€” è€Œåœ¨è¿™è‡ªä¿¡æ»¡æ»¡çš„ç­‰ç€çš„æ±‰å ¡å¥—é¤ï¼Œå°±æ˜¯æ‰€è°“çš„ **future value**ã€‚

æ—¶é—´æºœèµ°äº†ï¼Œå½“ â€œ113å·ï¼Œè¯·å–é¤â€ çš„å£°éŸ³å“èµ·ï¼Œä½ å……æ»¡æœŸå¾…çš„å»å‰å°å‡†å¤‡æ¥ä¸‹å»çš„å¤§å¿«æœµé¢æ—¶ï¼Œæ­¤æ—¶ä¼šæœ‰ä¸¤ä¸ªæƒ…å†µç­‰ç€ä½ ï¼Œç¬¬ä¸€ç§ä¼šæŒ‰ç…§ä½ çš„æœŸå¾…è¿›è¡Œï¼Œè‡ªä¸å¿…è¯´ï¼›å¦å¤–ä¸€ç§å°æ¦‚ç‡ä½†æœªå¿…ä¸ä¼šå‘ç”Ÿçš„äº‹ä»¶æ˜¯ï¼šâ€œå¾ˆæŠ±æ­‰ï¼Œæˆ‘ä»¬çš„æ±‰å ¡å–å®Œäº†ï¼Œæ‚¨çœ‹è¦ä¸æ¥ä»½ä¸‰æ˜æ²»æ€ä¹ˆæ ·ï¼Ÿâ€ â€”â€” æ¯æ¬¡å½“ä½ æƒ³ä¹°æ±‰å ¡å¥—é¤æ—¶ï¼Œä½ éƒ½å¾—åšå¥½å¤±è´¥çš„å‡†å¤‡ã€‚

**Note**ï¼šè¿™é‡Œçš„ç±»æ¯”æ˜¯ä¸ªç®€åŒ–çš„åœºæ™¯ï¼Œæ˜¾ç„¶åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œè¦è€ƒè™‘æ›´å¤šçš„äº‹æƒ…ï¼Œæ¯”å¦‚ä½ çš„å·ç ä¸€ç›´éƒ½æ²¡è¢«å«(å¾ˆæœ‰å¯èƒ½æ˜¯è¢«å¿˜è®°äº†)ï¼Œè¿™ä¸ä¹‹å¯¹åº”çš„å°±æ˜¯ä¸€ç›´ â€œæ‚¬è€Œæœªå†³â€ çš„çŠ¶æ€ã€‚

#### ç°åœ¨å’Œå°†æ¥çš„å€¼(Values Now and Later)
ç›´æ¥æ¥æ®µä»£ç ï¼š

```js
var x, y = 2;

console.log(x + y); // NaN
```

ğŸ‘† `x + y` æœ€ç»ˆäº§ç”Ÿçš„æ˜¯ä¸€ä¸ªä¸é¢„æœŸç»“æœä¸ç¬¦çš„ `NaN` â€”â€” éš¾é“ä½ è¿˜æŒ‡æœ› `+` å¸®ä½ ç›‘è§†ç€ `x` å’Œ `y` éƒ½å·²ç»æ˜¯ `number` ç±»å‹çš„å€¼äº†ï¼Œè€Œåå†å¸®ä½ å®ŒæˆåŠ æ³•è¿ç®—ï¼Ÿ

ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œä½ å¾—é è‡ªå·±ï¼Œæ¯”å¦‚ç”¨å›è°ƒå‡½æ•°ï¼š

```js
function add (getX, getY, cb) {
  var x, y;
  getX(function (xVal) {
     x = xVal;
     if (y != undefined) {
       cb(x + y);
     }
  }),
  getY(function (yVal) {
     y = yVal;
     if (x != undefined) {
       cb(x + y);
     }
  })
}

// `fetchX()` å’Œ `fetchY()` æ˜¯åŒæ­¥æˆ–å¼‚æ­¥çš„è·å–å¯¹åº” x å’Œ y å€¼çš„å‡½æ•°
add(fetchX, fetchY, function (sum) {
  console.log(sum);
})
```

ğŸ‘†å…ˆåˆ«ç®¡å®ƒæ˜¯å¦ä¼˜é›…ï¼Œè‡³å°‘å®ƒèƒ½è®©è¡Œä¸ºå¯æ§ï¼Œå³åœ¨`fetchX()` å’Œ `fetchY()` å·¥ä½œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œæ— è®ºå®ƒä»¬æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œ`x + y` éƒ½èƒ½æ­£ç¡®çš„è¿”å›å€¼æœŸå¾…çš„å€¼ï¼Œè€Œé `NaN`ã€‚

#### æ‰¿è¯ºçš„å€¼(Promise Value)
è‹¥æ˜¯æŠŠä¸Šé¢çš„ `add` ç”¨ Promise æ¥æ”¹å†™çš„è¯ï¼š

```js
function add (xPromise, yPromise) {
  return Promise.all([xPromise, yPromise])
    .then(function (values) {
      return values[0] + values[1];
    });
}

add(fetchX(), fetchY())
  .then(function (sum) {
    console.log(sum);
  });
```

ğŸ‘†`fetchX()` å’Œ `fetchY()` éƒ½è¿”å›äº† Promise å¯¹è±¡ï¼Œè€Œåè¢«ä½œä¸ºå‚æ•°ä¼ å…¥äº† `add(â€¦)` ä¸­ã€‚

åœ¨ `add(â€¦)` å†…éƒ¨ï¼Œ`Promise.all([â€¦])` æ¥æ”¶äº†å®ƒä»¬ï¼Œéšåå®ƒä¹Ÿè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè€Œååœ¨å…¶é“¾æ¥çš„ `then(â€¦)` æ–¹æ³•ä¸­ï¼Œå®Œæˆäº† `x + y`(`values[0] + values[1]`) çš„åŠ¨ä½œï¼Œå¹¶ä½œä¸ºç«‹å³ resolve çš„å€¼è¿”å›ã€‚

æœ€ç»ˆï¼Œåœ¨è°ƒç”¨ `add(â€¦)` è¿”å›çš„ Promise å¯¹è±¡åé¢ï¼Œé“¾æ¥ä¸Š `then(â€¦)` æ–¹æ³•ï¼Œå¹¶å°† `sum` è¾“å‡ºåˆ°äº†æ§åˆ¶å°ä¸Šã€‚

å…³é”®çš„åœ°æ–¹æ˜¯ Promise å¯¹è±¡æœ¬èº«åŒ…å«äº† `then` æ–¹æ³•ï¼Œè€Œè°ƒç”¨ `then(â€¦)` æ–¹æ³•æœ¬èº«åˆä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå› æ­¤è¿™ä¸ªé“¾å¯ä»¥æ— é™è¿›è¡Œä¸‹å»ã€‚

å’Œä¹°æ±‰å ¡å¥—é¤çš„ä¾‹å­ä¸€æ ·ï¼Œæˆ‘ä»¬å¾—å¯¹æ„å¤–çš„æƒ…å†µåšå¥½å‡†å¤‡ï¼Œåœ¨ Promise ä¸­ï¼Œå¯¹åº”çš„å°±æ˜¯ `then(â€¦)` æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼š

```js
add(fetchX(), fetchY())
  .then(
    function (sum) {
      console.log(sum);
    },
    function (err) {
      console.error(err);
    }
  );
```

å› ä¸º Promise æ˜¯ç‹¬ç«‹äºæ—¶é—´çš„ï¼Œå› æ­¤å®ƒå¯ä»¥å¾ˆå¥½çš„é¢„æµ‹å’Œç»„åˆå„ç§æƒ…å†µå’Œç»“æœã€‚å¹¶ä¸”æ›´é‡è¦çš„æ˜¯ï¼Œä¸€æ—¦ Promise çš„çŠ¶æ€ resolve æ‰äº†ï¼Œå°±ä¸èƒ½æ›´æ”¹äº† â€”â€” å°½ç®¡è¿™ä¸ªçŠ¶æ€çš„ç»“æœèƒ½å¤Ÿè¢«æ— é™æ¬¡çš„è®¿é—®ã€‚

**Note**ï¼šè¿™ç§ *ä¸å¯æ›´æ”¹(immutable)* çš„ç‰¹æ€§ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«ä»»æ„çš„ä¼ å…¥åˆ°å„ç§ç¬¬ä¸‰æ–¹çš„ä»£ç ä¸­ï¼Œè€Œä¸å¿…æ‹…å¿ƒè¢«æ— æ„æˆ–æ˜¯æ¶æ„çš„ç¯¡æ”¹ã€‚è€Œè¿™æ˜¯ Promise è®¾è®¡ä¹‹åˆï¼Œæ®šç²¾ç«­è™‘å®Œæˆçš„æœ€åŸºç¡€ã€æœ€é‡è¦çš„åŠŸèƒ½ã€‚

Promise æ˜¯ä¸€ç§èƒ½å¤Ÿå¾ˆå®¹æ˜“çš„å°è£…ã€ç»„åˆ *æœªæ¥çš„å€¼(fature value)* çš„æœºåˆ¶ã€‚

### å®Œæˆäº‹ä»¶(Completion Event)
é™¤äº†ä»£è¡¨ â€œæœªæ¥çš„å€¼â€ ä¹‹å¤–ï¼Œå¯¹ Promise çš„å¦ä¸€ä¸ªæ´è§æ˜¯æŠŠå®ƒè§†ä¸ºæ˜¯ä¸€ä¸ª â€œæµç¨‹æ§åˆ¶â€ çš„æœºåˆ¶ â€”â€” å°†å¼‚æ­¥çš„ä»»åŠ¡æ‹†è§£ä¸ºå¤šä¸ªæ­¥éª¤ç”¨æ¥æ‰§è¡Œã€‚

å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•° `foo` ä¼šæ‰§è¡Œä¸€äº›ä»»åŠ¡ï¼Œä½†æˆ‘ä»¬å¹¶ä¸çŸ¥é“å®ƒæ‰§è¡Œçš„ç»†èŠ‚ï¼Œä»¥åŠå®ƒåˆ°åº•æ˜¯ç«‹å³æ‰§è¡Œè¿˜æ˜¯å»¶è¿Ÿä¸€ä¼šåå†æ‰§è¡Œï¼Œæˆ‘ä»¬åªçŸ¥é“å®ƒä¼šé€šçŸ¥æˆ‘ä»¬å®ƒå·²ç»å®Œæˆï¼Œè€Œåæˆ‘ä»¬å¯ä»¥æ¥ä¸‹å»åšåç»­çš„ä»»åŠ¡ â€”â€” åœ¨ JS çš„ç¼–ç¨‹èŒƒå¼ä¸­ï¼Œä½ é€šå¸¸éœ€è¦ç›‘å¬è¿™äº› â€œé€šçŸ¥â€ï¼Œå°±å¥½åƒäº‹ä»¶è§¦å‘çš„æœºåˆ¶ä¸€æ ·ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡ªå®šä¹‰ä¸€äº›éœ€æ±‚ï¼Œæ‰“åŒ…æˆä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¹¶å°†å›è°ƒå‡½æ•°ä¼ é€’ç»™ `foo`ï¼›æœ€ç»ˆ `foo` ä¼šæ ¹æ®æƒ…å†µè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œä»¥æ­¤æ¥å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚

ä¸è¿‡åœ¨ Promise çš„æœºåˆ¶ä¸‹ï¼Œè¿™æ ·çš„å…³ç³»è¢«åè½¬äº† â€”â€” æˆ‘ä»¬çš„å›è°ƒå‡½æ•°ä¸å†æ˜¯è¢« `foo` è§¦å‘çš„ï¼Œè€Œæ˜¯é€šè¿‡ Promise è¿™ä¸ªä¸­é—´å±‚æ¥è§¦å‘ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¸€æ®µä¼ªä»£ç ï¼š

```js
foo(x) {
	// å¼‚æ­¥æ“ä½œâ€¦â€¦
}

foo(42)

on (foo, 'success') {
	// foo å®Œæˆäº†ï¼Œæ¥ç€åšä¸‹ä¸€æ­¥äº‹æƒ…
}

on (foo, 'error') {
	// foo å‘ç”Ÿäº†ç‚¹é—®é¢˜ï¼Œå¤„ç†ä¸€ä¸‹
}
```

`foo(â€¦)` ä¸å¿…å…³å¿ƒï¼Œä¹Ÿä¸ç”¨è¦å¤„ç†ä¸€äº›è®¢é˜…å®ƒçš„äº‹ä»¶ï¼Œè¿™äº›éƒ½äº¤ç»™äº† `on(â€¦)`ï¼Œè¿™æ˜¯ä¸€ç§å¾ˆå¥½çš„ "è´£ä»»åˆ†ç¦»(separation of concerns)" çš„å®ç°ã€‚

ä½†åœ¨ Promise å‡ºæ¥ä¹‹å‰ï¼Œåœ¨ JS ä¸­æƒ³è¦å®ç°è¿™æ ·çš„æ•ˆæœï¼Œåªèƒ½ â€œé­”æ”¹â€ ä¸€æŠŠï¼š

```js
function foo(x) {
	// å¼‚æ­¥æ“ä½œâ€¦â€¦

	// è¿”å›ä¸€ä¸ª listener å¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ª `on` æ–¹æ³•ï¼Œèƒ½å¤Ÿå®ç°äº‹ä»¶çš„ç»‘å®š
	return listener;
}

const evt = foo(42);

evt.on('success', function(){
	// foo å®Œæˆäº†ï¼Œæ¥ç€åšä¸‹ä¸€æ­¥äº‹æƒ…
});

evt.on('error', function(err){
  // foo å‘ç”Ÿäº†ç‚¹é—®é¢˜ï¼Œå¤„ç†ä¸€ä¸‹
});
```

ğŸ‘† `foo(â€¦)` è¿”å›äº†ä¸€ä¸ªå¯¹è±¡èƒ½å¤Ÿå¤„ç†äº‹ä»¶çš„è®¢é˜…ï¼Œå¦‚æ­¤ä¸€æ¥æˆ‘ä»¬å°±èƒ½åƒäº‹ä»¶æœºåˆ¶ä¸€æ ·æ¥å®Œæˆå¯¹ `foo` åç»­ä»»åŠ¡çš„å¤„ç†ã€‚ä½†è¯´åˆ°åº•ï¼Œ`listener` ä¾ç„¶æ˜¯ç”± `foo` å†…éƒ¨å®ç°ï¼Œå¹¶æ²¡æœ‰é¢ è¦† â€œæ§åˆ¶åè½¬â€ çš„åº•å±‚é€»è¾‘ã€‚

å½“ç„¶ï¼Œä½ è¿˜èƒ½å°†ç›‘å¬ `foo` çš„ `success` å’Œ `error` äº‹ä»¶åˆ†å¼€ï¼Œå•ç‹¬å°è£…æˆ `bar` å’Œ `baz`ï¼š

```js
// `bar` ç›‘å¬ `foo` çš„ success
bar(evt);

// `baz` ç›‘å¬ `foo` çš„ error
baz(evt);
```

è‹¥æ˜¯ `evt` æˆ–è€…è¯´ `listener` æ˜¯ç”±ä¸€ä¸ªå¯é çš„ç¬¬ä¸‰æ–¹æœºåˆ¶æ¥ç”Ÿæˆçš„è¯ï¼Œé‚£çš„çš„ç¡®ç¡®å®ç°äº† â€œåæ§åˆ¶åè½¬(Uninversion of control)â€ï¼Œå¹¶ä¸”åŠ ä¸Š â€œè´£ä»»åˆ†ç¦»â€ çš„æ•ˆæœï¼Œçœ‹ä¸Šå»çœŸçš„å¾ˆ niceã€‚

#### Promiseâ€œäº‹ä»¶â€(Promise "Events")
å…¶å® `evt` å°±æ˜¯å¯¹ Promise çš„ä¸€ä¸ªç±»æ¯”ï¼Œåœ¨ Promise çš„æœºåˆ¶ä¸‹ï¼Œ`foo(â€¦)` ä¼šè¿”å›ä¸€ä¸ª Promise çš„å®ä¾‹ï¼Œè€Œåè¿™ä¸ªå®ä¾‹ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™ `bar(â€¦)` å’Œ `baz(â€¦)`ã€‚

**Note**ï¼šéœ€è¦æ³¨æ„çš„æ˜¯ä¹‹å‰å¯¹äºäº‹ä»¶çš„æªè¾ï¼Œä¸¥æ ¼æ¥è®²ï¼ŒPromise çš„å®ç°å¹¶ä¸æ˜¯é€šè¿‡äº‹ä»¶æœºåˆ¶ï¼Œæ›´æ²¡æœ‰ `success` å’Œ `error` ä¹‹ç±»çš„äº‹ä»¶ç›‘å¬ï¼›ä¸è¿‡ä½ ä¹Ÿèƒ½å°†è°ƒç”¨å…¶å®ä¾‹ä¸Šçš„ `then(â€¦)` å’Œ `catch(â€¦)` æ–¹æ³•ï¼Œç†è§£æˆæ³¨å†Œäº† `fulfillment` æˆ– `rejection` äº‹ä»¶ â€”â€” è™½ç„¶æˆ‘ä»¬ä¸ä¼šåœ¨çœŸå®çš„ä»£ç ä¸­å±•ç¤ºå‡ºæ¥ï¼š

```js
function bar (fooPromise) {
	fooPromise.then(
		function(){
			// resolve ç›‘å¬
		},
		function(){
			// reject ç›‘å¬
		}
	);
}

// baz åŒä¸Š

function foo(x) {
	// å¼‚æ­¥æ“ä½œâ€¦â€¦

	// è¿”å›ä¸€ä¸ª Promise çš„å®ä¾‹
	return new Promise(function(resolve, reject){
		// å†…éƒ¨è°ƒç”¨ `resolve` æˆ–åˆ™ `reject`ï¼Œæœ€ç»ˆä¼šè§¦å‘ç»‘å®šçš„å›è°ƒ
	});
}

var p = foo(42);

bar(p);

baz(p);
```

ğŸ‘† `new Promise(function (resolve, reject) {})` è¿™ç§æ¨¡å¼è¢«ç§°ä¸º [revealing constructor](https://blog.domenic.me/the-revealing-constructor-pattern/) â€”â€” è¢«ä¼ å…¥ Promise æ„é€ å‡½æ•°çš„å‡½æ•°ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œå¹¶æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ `resolve`ï¼Œè°ƒç”¨å®ƒä¼šäº§ç”Ÿ fulfillment çš„çŠ¶æ€ï¼›å¦ä¸€ä¸ªæ˜¯ `reject`ï¼Œè°ƒç”¨å®ƒä¼šäº§ç”Ÿ rejection çš„çŠ¶æ€ã€‚

å¦ä¸€ç§æ›´ä¼˜é›…å®ç°çš„æ–¹å¼ï¼Œå°†æ“ä½œ `resolve` å’Œ `reject` çš„ä»£ç åˆ†ç¦»ï¼Œè€Œä¸æ˜¯è€¦åˆåœ¨ä¸€èµ·ï¼š

```js
function bar() {
	// resolve ç›‘å¬
}

function oopsBar() {
	// reject ç›‘å¬
}

// `baz()` å’Œ `oopsBaz()` åŒä¸Š

var p = foo(42);

p.then(bar, oopsBar);

p.then(baz, oopsBaz);
```

**Note**ï¼š`p.then(â€¦).then(â€¦)` å’Œ `p.then(â€¦);p.then(â€¦)` æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸ä¸€æ ·çš„ä»£ç ï¼Œå‰è€…çš„é“¾å¼è°ƒç”¨ä¸­ï¼Œå‰åä¸¤ä¸ª `then(â€¦)` æ˜¯ä¸åŒçš„ Promise å®ä¾‹ä¸Šçš„æ–¹æ³•ï¼›åè€…åˆ™éƒ½æ˜¯å‡ºè‡ªåŒä¸€ä¸ª Promise å®ä¾‹çš„ `then(â€¦)` æ–¹æ³•ï¼Œå¹¶ä¸”å®ƒçš„çŠ¶æ€ä¸€æ—¦ç¡®å®šï¼Œå°±æ— æ³•è¢«æ”¹å˜äº†ã€‚


## Thençš„é¸­å¼ç±»å‹(Thenable Duck Typing)
ä½¿ç”¨ Promise é¢ä¸´çš„æœ€å¤´ç–¼çš„é—®é¢˜æ˜¯å¦‚ä½•ç¡®å®šæŸä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯çœŸæ­£çš„ Promiseã€‚

`p instanceof Promise` è¿™æ ·çš„æ£€æµ‹æ–¹å¼æ²¡åŠæ³•å®Œå…¨æ»¡è¶³éœ€æ±‚çš„ä¸»è¦åŸå› æ˜¯ï¼Œæµè§ˆå™¨çª—å£ä¹‹é—´(iframe)çš„äº¤äº’ï¼Œè‹¥æ˜¯å®ƒä»¬ä½¿ç”¨çš„ Promiseå®ä¾‹ æ˜¯ä¸åŒçš„æ„é€ å‡½æ•°åˆ›å»ºçš„ï¼Œé‚£è¿™æ ·çš„æ£€æµ‹å°±ä¼šå¤±è´¥ã€‚

å†è€…ï¼Œè‹¥æ˜¯ä½ ä½¿ç”¨äº†æŸä¸ªä¸‰æ–¹çš„åº“ï¼Œå®ƒçš„ Promise å¹¶éæ˜¯åŸºäºåŸç”Ÿçš„ Promise æ¥å®ç°ï¼Œé‚£ä¹ˆä¹Ÿæ— æ³•æ»¡è¶³éœ€æ±‚ã€‚

å› æ­¤ï¼Œç¤¾åŒºå†…å¹¿æ³›æµè¡Œçš„ä¸€ç§ ç±»å‹æ£€æµ‹ æœºåˆ¶æ˜¯åŸºäº â€œé¸­å¼ç±»å‹(duck typing)â€ â€”â€” å¦‚æœå®ƒé•¿å¾—åƒé¸­å­ï¼Œå¹¶ä¸”èƒ½åƒé¸­å­ä¸€æ ·å‘±å‘±çš„å«ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯é¸­å­ã€‚è¿™ç§åŸºäº â€œå€¼çš„å½¢çŠ¶â€ çš„æ£€æŸ¥ï¼Œè¢«ç”¨äº â€œPromiseçš„çœŸå‡ç¾çŒ´ç‹â€ ä¹‹ä¸­ï¼Œå³æ‰€è°“çš„ thenableï¼š

```js
function isPromise (p) {
  if (p !== null && (typeof p === 'object' || typeof p === 'function') && typeof p.then === 'function') {
    // thenable!
    return true;
  }
  return false;
}
```

å¥½åƒè¿˜è¡Œï¼Ÿç«‹é©¬éœ²é¦…ï¼š

```js
var o = { then: function() {} };

var v = Object.create(o);

v.hasOwnProperty('then'); // false

isPromise(v); // true
```

è€Œè‹¥æ˜¯æœ‰äºº æ— æ„/æ•…æ„/æ¶æ„ åœ¨ä¸€äº›å†…ç½®çš„ç±»çš„åŸå‹å¯¹è±¡ä¸Šé¢æ·»åŠ äº† `then` æ–¹æ³•çš„è¯ï¼š

```js
Object.prototype.then = function(){};
Array.prototype.then = function(){};

var v1 = { hello: 'world' };
var v2 = [ 'Hello', 'World' ];

isPromise(v1); // true
isPromise(v2); // true
```

ğŸ‘†è¦æ˜¯ä½ æŠŠè¿™äº›å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¹‹å‰çš„ `baz`ã€`bar` çš„è¯ï¼Œé‚£å®ƒä»¬ä¼šè¢«æ°¸è¿œçš„æŒ‚èµ·â€¦â€¦

ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œè¿™æ˜¯å±è¨€è€¸å¬å§ï¼Ÿï¼é‡åˆ°è¿™ç§æƒ…å†µçš„æ¦‚ç‡å®åœ¨æ˜¯å¤ªå°äº†ã€‚ä½†ä½ ä¸å¾—ä¸é˜²çš„æ˜¯æœ‰ä¸€äº›ä½ ä¾èµ–çš„ç¬¬ä¸‰æ–¹çš„åº“ï¼Œå®ƒä»¬å¾ˆå¯èƒ½æ˜¯åœ¨ ES6 ä¹‹å‰çš„äº§ç‰©ï¼Œå¹¶ä¸”æœ‰ `then` æ–¹æ³•æŒ‚è½½åœ¨å®ƒçš„æŸä¸ªå¯¹è±¡ä¸Šã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œ`isPromise` å°±ä¸å¥½ä½¿äº†ã€‚

## Promise å’Œ ä¿¡ä»»é—®é¢˜(Promise Trust)
è™½ç„¶å‰é¢æˆ‘ä»¬å·²ç»é€šè¿‡ä¸¤ä¸ªå¾ˆå½¢è±¡çš„ç±»æ¯”(â€œæœªæ¥çš„å€¼â€å’Œâ€œå®Œæˆçš„äº‹ä»¶â€)ï¼Œäº†è§£åˆ° Promise å¦‚ä½•åœ¨å¼‚æ­¥é¢†åŸŸå¤§æ”¾å…‰å½©çš„ï¼Œä½†å¦‚æœä»…ä»…åˆ°è¿™é‡Œï¼Œä¸ç»§ç»­æ·±å…¥çš„è¯ï¼Œé‚£å°±å¤±å»äº†è®©æˆ‘ä»¬äº†è§£å…¶æœ€é‡è¦çš„æ ¸å¿ƒç‰¹å¾(ä¹Ÿæ˜¯Promise ä¹‹æ‰€ä»¥å­˜åœ¨çš„æ ¹æœ¬åŸå› )çš„æœºä¼š â€”â€” ä¿¡ä»»(Trust)ã€‚

å›é¡¾ä¸‹åŸºäº å›è°ƒå‡½æ•° çš„å¼‚æ­¥ä»£ç ç”±äºå…¶ æ§åˆ¶åè½¬ è€Œå¸¦æ¥çš„å„ç§ â€œä¿¡ä»»â€ é—®é¢˜ï¼š

  - è¿‡æ—©çš„è°ƒç”¨å›è°ƒå‡½æ•°

  - è¿‡è¿Ÿçš„è°ƒç”¨å›è°ƒå‡½æ•°

  - å¤ªå°‘/å¤ªå¤š åœ°è°ƒç”¨äº†å›è°ƒå‡½æ•°

  - è°ƒç”¨å›è°ƒå‡½æ•°æ—¶ï¼Œç¼ºå°‘å¿…é¡»çš„å‚æ•°

  - æŠŠå„ç§å¼‚å¸¸å’Œé”™è¯¯éƒ½ â€œåæ‰äº†â€ 

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬ä¸€ä¸ªä¸ªçš„æ¥çœ‹ Promise åˆ°åº•æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ï¼š

### è¿‡æ—©çš„è°ƒç”¨(Calling Too Early)
å›è°ƒå‡½æ•°å¯èƒ½æ˜¯åŒæ­¥ï¼Œä¹Ÿå¯èƒ½æ˜¯å¼‚æ­¥è¢«è°ƒç”¨ï¼Œè€Œæ²¡æœ‰ä¸€ä¸ªå†…ç½®çš„æœºåˆ¶ç¡®ä¿å…¶ä¸€å®šæ˜¯å¼‚æ­¥çš„ï¼Œé™¤éæ‰‹åŠ¨çš„ä½¿ç”¨ `setTimeout(â€¦)`ã€‚

è€Œåœ¨ Promise çš„æœºåˆ¶ä¸­ï¼Œä»»ä½•æ”¾åˆ° `then(â€¦)` ä¸­çš„å›è°ƒå‡½æ•°ï¼Œèƒ½å¤Ÿè¢«ç¡®ä¿æ€»ä¼šæ˜¯å¼‚æ­¥è¢«è°ƒç”¨çš„(å‡†ç¡®æ¥è®²æ˜¯é€šè¿‡ *ä»»åŠ¡é˜Ÿåˆ—* çš„æœºåˆ¶æ¥å®ç°çš„)ã€‚

### è¿‡è¿Ÿçš„è°ƒç”¨(Calling Too Late)
ğŸ‘† å’Œä¸Šé¢çš„ä¸€æ ·ï¼Œä»»ä½•æ”¾åˆ° `then(â€¦)` ä¸­çš„å›è°ƒå‡½æ•°ï¼Œåœ¨ è°ƒç”¨äº†ç”± Promise æä¾›çš„ `resolve(â€¦)` æˆ– `reject(â€¦)` åï¼Œèƒ½å¤Ÿç¡®ä¿æ€»ä¼šåœ¨æ¥ä¸‹å»çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­è¢«è°ƒç”¨ â€”â€” ä½ ä¸å¯èƒ½åœ¨åŒæ­¥çš„ä»»åŠ¡ä¸­è§‚å¯Ÿåˆ°å®ƒè¢«æ‰§è¡Œã€‚å› æ­¤ï¼Œå½“ä¸€ä¸ª Promise å®ä¾‹çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæ‰€æœ‰æ³¨å†Œåœ¨å®ƒçš„ `then(â€¦)` æ–¹æ³•ä¸Šçš„å›è°ƒå‡½æ•°éƒ½ä¼šæŒ‰ç…§æ³¨å†Œçš„é¡ºåºè¢«è°ƒç”¨ï¼Œå³ä¾¿æ˜¯åœ¨è¿™äº›å›è°ƒå‡½æ•°çš„å†…éƒ¨ï¼Œä¹Ÿæ²¡åŠæ³•å½±å“(å»¶è¿Ÿ)å…¶ä»–çš„å›è°ƒå‡½æ•°ï¼š

```js
const p = new Promise((resolve, reject) => {
  resolve('some data');
});

p.then(function () {
  p.then(function () {
    console.info('C');
  });
  console.info('A');
});

p.then(function () {
  console.info('B');
});

// A B C
```

ğŸ‘† `'C'` æ— æ³•é˜»æ­¢æˆ–æ”¹å˜ `'B'` çš„æ‰§è¡Œ(é¡ºåº)ï¼Œè€Œè¿™ä¹Ÿæ˜¯ Promise çš„ä¼˜åŠ¿ä¹‹ä¸€ã€‚

#### Promise é¡ºåºçš„æ€ªç™–(Promise Scheduling Quirks)
éœ€è¦æ ¼å¤–æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸¤ä¸ªåˆ†å¼€çš„ Promise é“¾å¼ä»£ç é‡Œçš„å›è°ƒå‡½æ•°ï¼Œä½ æ˜¯æ²¡æœ‰åŠæ³•ç¡®ä¿å®ƒä»¬çš„æ‰§è¡Œé¡ºåºçš„ã€‚æ¯”å¦‚ï¼Œä¸¤ä¸ª Promise çš„å®ä¾‹ `p1` å’Œ `p2` åŒæ—¶å˜åˆ°äº† resolved çš„çŠ¶æ€ï¼Œ`p1.then(â€¦)` å’Œ `p2.then(â€¦)` ä¹¦å†™çš„å…ˆåé¡ºåºé€šå¸¸æ˜¯å…¶å†…éƒ¨å›è°ƒå‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Œä½†è‹¥æ˜¯æ”¹å˜ä¸€äº›ç»†èŠ‚ï¼š

```js
const p3 = new Promise((resolve, reject) => {
  resolve('B');
});

const p1 = new Promise((resolve, reject) => {
  resolve(p3);
});

const p2 = new Promise((resolve, reject) => {
  resolve('A');
});

p1.then(function (v) {
  console.info(v);
});

p2.then(function (v) {
  console.info(v);
});

// A B
```


![Promise Scheduling Quirks](./assets/promise_schedule_quirks.jpg)


ğŸ‘†å¹¶éæŒ‰ç…§è®¾æƒ³çš„æ‰“å°å‡ºäº† `B A`ï¼Œè¿™æ˜¯å› ä¸º `p1` ä¸­çš„ `resolve(p3);` å…¶å®æ˜¯ resolve äº†å¦ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œè€Œ `p2` åˆ™ resolve çš„ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼Œå› æ­¤åœ¨è¿™ä¸ªç»´åº¦çœ‹ï¼Œ`p2` resolve çš„ç»“æœè¦æ—©äº `p1` çš„ç»“æœã€‚ä¸è¿‡è¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨åŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå³ **å®ƒä»¬resolveçš„ç»“æœ** å¹¶æ²¡æœ‰åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«ã€‚

### æ²¡æœ‰è°ƒç”¨å›è°ƒå‡½æ•°(Never Calling the Callback)
è¿™ä¸ªé—®é¢˜åœ¨ Promise ä¸­å¾ˆå¥½æå®šï¼šåªè¦ä½ æ³¨å†Œäº† fulfillment å’Œ rejection çš„å›è°ƒå‡½æ•°ï¼Œä¸€æ—¦ Promise çš„çŠ¶æ€æ”¹å˜ï¼Œå°±å¿…ç„¶ä¼šè°ƒç”¨å…¶ä¸­çš„æŸä¸€ä¸ªå›è°ƒã€‚è‡³äºæ‰€è°“çš„ä¼šè¢« â€œæ°¸è¿œåœ°æŒ‚èµ·â€ï¼Œå³çŠ¶æ€æ°¸è¿œæ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Ÿå…¶å®å¾ˆå¥½è§£å†³ï¼š

```js
function timeoutPromise (delay) {
  return new Promise(function (resolve, reject) {
    setTimeout(function () {
      reject('timeout');
    }, delay);
  })
}

Promise.race([
  foo(),
  timeoutPromise(3000)
])
.then(
  function () {},
  function (err) {}
);
```

ä¸€æ—¦ `3000` æ¯«ç§’è¿‡äº†ï¼Œ`foo()` è¿”å›çš„ Promise å®ä¾‹è¿˜æ²¡ç¡®å®šçŠ¶æ€çš„è¯ï¼Œå°±ä¼šèµ°åˆ°è¶…æ—¶çš„é€»è¾‘ä¸­ï¼Œå› æ­¤ä½ ä¹Ÿä¸ç”¨æ‹…å¿ƒä½ çš„ç¨‹åºä¼šè¢« â€œæ°¸è¿œåœ°æŒ‚èµ·â€ã€‚

### å¤ªå°‘/å¤ªå¤š çš„è°ƒç”¨(Calling Too Few or Too Many Times)
ç†æƒ³çš„å›è°ƒå‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•°è‚¯å®šæ˜¯ one â€”â€” è¿™æ²¡æœ‰ç–‘è®®å§ï¼Ÿï¼é‚£ä¹ˆ â€œå¤ªå°‘â€ å°±æ˜¯æ²¡æœ‰è¢«è°ƒç”¨ï¼Œé‚£å°±å›åˆ°ğŸ‘†ä¸Šé¢æåˆ°çš„éƒ¨åˆ†ã€‚

â€œå¤ªå¤šâ€ çš„ç–‘è™‘ä¹Ÿå¾ˆå®¹æ˜“è¢«è§£å†³ â€”â€” ä¸€æ—¦ Promise çŠ¶æ€ç¡®å®šäº†ï¼Œé‚£ä¹‹åå°±æ— æ³•å†æ¬¡æ”¹å˜ï¼Œå³ä¾¿ä½ åå¤çš„è°ƒç”¨å®ä¾‹åŒ–æ—¶ï¼Œæä¾›ç»™ä½ çš„ `resolve(â€¦)` å’Œ `reject(â€¦)`ï¼ŒPromise å®ä¾‹åªä¼šæ¥å—ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„ï¼Œå…¶ä»–çš„éƒ½ä¼šè¢«å¿½è§†ã€‚

å› æ­¤ï¼Œä»»ä½•æ³¨å†Œåœ¨ `then(â€¦)` ä¸­çš„å›è°ƒï¼Œåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚å½“ç„¶ï¼Œä½ èƒ½å¤Ÿæ— é™åˆ¶çš„åœ¨ç›¸åŒçš„ Promise å®ä¾‹ä¸­æ³¨å†Œç›¸åŒçš„å›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚ `p.then(f); p.then(f);`ï¼Œé‚£å®ƒä»¬ä¼šè¢«ä¸ä¹‹å¯¹åº”çš„æ¬¡æ•°â€¦ â€”â€” ä¸è¿‡é‚£æ˜¯ä½ è‡ªå·±çš„éå¾—è¦æ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„šï¼Œä½ æ€ªè°ï¼Ÿï¼

### ç¼ºå°‘æ‰€éœ€çš„å‚æ•°(Failing to Pass Along Any Parameters/Environment)

`resolve(â€¦)` å’Œ `reject(â€¦)` éƒ½èƒ½æ¥æ”¶ **ä¸€ä¸ª** ä»»ä½•ç±»å‹çš„å‚æ•°ï¼Œå®ƒä»¬ä¼šè¢«ä¼ é€’ç»™æ‰€æœ‰æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚

è‹¥æ˜¯è¶…è¿‡äº†ä¸€ä¸ªå‚æ•°ï¼Ÿé™¤äº†ç¬¬ä¸€ä¸ªï¼Œå…¶ä»–éƒ½ä¼šè¢« â€œæ— æƒ…çš„æŠ›å¼ƒâ€ã€‚åƒä¸‡åˆ«å¹»æƒ³ç”¨ `resolve(â€¦);resolve(â€¦);resolve(â€¦);â€¦â€¦` æ¥å®ç°å¤šä¸ªå‚æ•°çš„ä¼ é€’ â€”â€” è¿˜æ˜¯è€è€å®å®çš„ç”¨ `object` æˆ–è€… `array` æ¥åŒ…è£¹å¤šä¸ªå‚æ•°æ¯”è¾ƒç°å®ã€‚

å¦å¤–ï¼Œä»»ä½•æ³¨å†Œåˆ° `then(â€¦)` ä¸­çš„å›è°ƒå‡½æ•°ï¼Œéƒ½ä¿å­˜äº†å®šä¹‰å®ƒæ—¶çš„ä¸Šä¸‹æ–‡ï¼Œå³ â€œé—­åŒ…â€ è¿™ä¸ªèƒ½åŠ›ä¾ç„¶æœ‰æ•ˆã€‚

### â€œåæ‰äº†â€å„ç§å¼‚å¸¸å’Œé”™è¯¯(Swallowing Any Errors/Exceptions)

```js
const p = new Promise(function (resolve, reject) {
	foo.bar();
	resolve(42);
});

p.then(
	function fulfilled () {
    // æ°¸è¿œåˆ°ä¸äº†è¿™å„¿
  },
	function rejected (err) {
    // TypeError
  }
);
```

ğŸ‘† `foo.bar();` æ˜¯äº§ç”Ÿé”™è¯¯çš„æºå¤´ï¼Œè€Œä¸”å³ä¾¿æ˜¯è¿™ä¸ªå¼‚å¸¸æ˜¯å‘ç”Ÿåœ¨ Promise çš„å®ä¾‹åŒ–è¿‡ç¨‹ä¸­(åŒæ­¥)ï¼Œä¹Ÿä¼šè®©è¿™ä¸ªå¼‚å¸¸åœ¨å¼‚æ­¥çš„è¡Œä¸ºä¸­è¢«æ•è· â€”â€” è¿™ä¸€ç‚¹éå¸¸ç‰›é€¼ï¼Œèƒ½å¤Ÿè®©ä½ æ— æ„Ÿçš„å°±è§£å†³äº†ä¹‹å‰æåˆ°çš„ race condition çš„é—®é¢˜ï¼Œæ— è®ºè¿™æ®µä»£ç å¦äº§ç”Ÿäº†å¼‚å¸¸ã€‚

é‚£è‹¥æ˜¯å¼‚å¸¸å‘ç”Ÿåœ¨ `fulfilled` çš„å›è°ƒå‡½æ•°ä¸­å‘¢ï¼Ÿ

```js
const p = new Promise(function (resolve, reject) {
	resolve(42);
});

p.then(
	function fulfilled (val) {
    foo.bar();
    console.info(val);
  },
	function rejected (err) {
    // æ°¸è¿œåˆ°ä¸äº†è¿™å„¿
  }
);
```

å¥½åƒæŠŠå¼‚å¸¸â€œåæ‰äº†â€ï¼Ÿé‚£åªæ˜¯å¹»è§‰ â€”â€” `p.then(â€¦)` å…¶å®ä¼šè¿”å›å¦ä¸€ä¸ª Promise çš„å®ä¾‹ï¼Œè€Œè¿™ä¸ªå®ä¾‹åˆ™ä¼šè¿›å…¥åˆ°å¼‚å¸¸æ•è·çš„çŠ¶æ€ã€‚

ä½ å¯èƒ½ä¼šæƒ³ï¼Œä¸ºå•¥ä¸ç›´æ¥è¿›å…¥åˆ°å½“å‰è¿™ä¸ª Promise å®ä¾‹çš„å¼‚å¸¸æ•è·å®Œäº‹ï¼Ÿå½“ç„¶ä¸èƒ½ï¼Œå› ä¸ºè¿™è¿èƒŒäº† Promise æœ€é‡è¦çš„åŸåˆ™ â€”â€” ä¸€æ—¦çŠ¶æ€ç¡®å®šå°±ä¸èƒ½æ”¹å˜ã€‚å³ `p` æ€»æ˜¯ å€¼ä¸º `42` çš„ fulfilled çš„çŠ¶æ€ã€‚è€Œè‹¥æ˜¯è¿èƒŒäº†è¿™ä¸€åŸåˆ™ï¼Œè¯•æƒ³ä¸‹ï¼Œå½“ä½ åœ¨åŒä¸€ä¸ª Promise çš„å®ä¾‹ä¸Šï¼Œæ³¨å†Œäº†å¤šä¸ªå›è°ƒçš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°æœ‰çš„ç»“æœæ˜¯è¿™æ ·ï¼Œæœ‰çš„ç»“æœæ˜¯é‚£æ ·â€¦â€¦

### èƒ½è¢«ä¿¡ä»»çš„Promise?(Trustable promise?)
åœ¨æˆ‘ä»¬å®Œå…¨ä¿¡ä»» Promise ä¹‹å‰ï¼Œè¿˜æœ‰æœ€åä¸€ä¸ªé—®é¢˜éœ€è¦ä»”ç»†çš„æ¢è®¨ä¸‹ â€”â€” Promise å¹¶æ²¡æœ‰æ‘†è„±æ‰å›è°ƒå‡½æ•°ï¼Œè€Œä»…ä»…æ˜¯æ”¹å˜äº†å›è°ƒå‡½æ•°ä¼ é€’çš„ä½ç½® â€”â€” ä¸å†æ˜¯æŠŠå›è°ƒå‡½æ•°ä¼ åˆ° `foo` é‡Œé¢å»ï¼Œè€Œæ˜¯å°†å›è°ƒå‡½æ•°ä¼ å…¥ `foo(â€¦)` çš„è¿”å›å€¼ä¸­ã€‚ä½†ä¸ºä»€ä¹ˆè¿™ç§æ¨¡å¼å°±å€¼å¾—ä¿¡ä»»å‘¢ï¼Ÿéš¾é“ä»…ä»…æ˜¯å› ä¸ºå®ƒå·²è¢«ä¿¡ä»»äº†ï¼Œæ‰€ä»¥å°±ä¿¡ä»»äº†ä¹ˆï¼Ÿï¼

å¯¹äºå†…ç½®çš„é™æ€æ–¹æ³• `Promise.resolve(â€¦)`ï¼Œè‹¥æ˜¯ä½ ä¼ å…¥çš„æ˜¯ä¸€ä¸ªéå¼‚æ­¥ã€éPromiseã€éthenableçš„å€¼ï¼Œé‚£ä½ ä¼šå¾—åˆ°ä¸€ä¸ª `fulfilled` çš„å€¼ï¼Œæ¯”å¦‚ğŸ‘‡ä¸‹é¢ä¸¤ä¸ª Promise å…¶å®æ˜¯æ²¡å•¥åŒºåˆ«çš„ï¼š

```js
var p1 = new Promise((resolve, reject) => {
  resolve(42);
});

var p2 = Promise.resolve(42);
```

ä½†è‹¥æ˜¯ä½ ä¼ å…¥çš„æ˜¯ä¸€ä¸ª Promise çš„å€¼ï¼Œé‚£åˆ™ä¼šåŸå°ä¸åŠ¨çš„å°†å…¶è¿”å›ï¼š

```js
var p1 = Promise.resolve(42);

var p2 = Promise.resolve(p1);

p1 === p2; // true
```

![promise_resolve](./assets/promise_trusable_promise.png)

æ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œå¯¹äºéšæ„ä½¿ç”¨ éPromiseçš„thenable å¯¼è‡´çš„æ„å¤–çš„åæœï¼š

```js
var p = {
	then: function(cb, errcb) {
		cb(42);
		errcb('evil laugh!');
	}
};

p
.then(
  function fulfilled (val) { console.log(val); },
  function rejected (err) { console.error(err); }
);
```

![thenable](./assets/promise_trusable_promise_thenable.png)

ğŸ‘† `p` æ˜¯ä¸€ä¸ª `thenable` ä½†å¹¶éæ˜¯ä¸¥æ ¼æŒ‰ç…§ promise çš„è§„èŒƒæ¥è®¾è®¡çš„ï¼Œå®ƒä¸èƒ½è¢«ä¿¡ä»»ã€‚ä¸è¿‡å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä½œä¸ºå€¼ï¼Œä¼ å…¥åˆ° `promise.resolve(â€¦)` ä¸­ï¼Œæ¥è§£å†³ä¿¡ä»»é—®é¢˜ï¼š

```js
Promise.resolve(p)
.then(
  function fulfilled (val) { console.log(val); },
  function rejected (err) { console.error(err); }
);
```

![thenable_resolved](./assets/promise_trusable_promise_thenable_resolve.png)

å› æ­¤ï¼Œè‹¥æ˜¯å½“æˆ‘ä»¬è¦ä½¿ç”¨æŸä¸ªç¬¬ä¸‰æ–¹çš„ thenable çš„å·¥å…·å‡½æ•° `foo(â€¦)` æ—¶ï¼Œ`Promise.resolve(â€¦)` èƒ½ç¡®ä¿å…¶è¿”å›çš„å€¼ä¸€å®šæ˜¯å¯ä¿¡ä»»çš„ Promiseï¼š

```js
Promise.resolve(foo(42))
.then(function (v) {
	console.log(v);
});
```

é™¤æ­¤ä¹‹å¤–ï¼Œ`Promise.resolve(â€¦)` è¿˜æœ‰ä¸ªå¥½å¤„å®ƒèƒ½ â€œæ ¼å¼åŒ–â€ ä¼ å…¥çš„å€¼ â€”â€” æ— è®ºä¼ å…¥çš„å€¼æ˜¯ç«‹å³æ‰§è¡Œçš„åŒæ­¥ä»£ç ï¼Œè¿˜æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„å¼‚æ­¥ä»£ç ï¼Œæœ€ç»ˆå®ƒè¿”å›çš„å€¼éƒ½æ˜¯å¼‚æ­¥çš„ã€‚

### ä¿¡ä»»çš„å»ºç«‹(Trust Built)
å›åˆ°å¤šå¹´å‰ï¼Œå½“ JS çš„æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡åªèƒ½ç”¨å›è°ƒå‡½æ•°è§£å†³çš„æ—¶å€™ï¼Œä¿¡ä»»é—®é¢˜æœ‰æ˜¾å¾—é‚£ä¹ˆé‡è¦ä¹ˆï¼Ÿä¸ä¸€å®šå§ï¼ï¼Ÿä½†æ˜¯æ—¶è‡³ä»Šæ—¥ï¼Œå½“ä½ ä¸€æ—¦æ¥è§¦è€Œåä½¿ç”¨è¿‡äº† Promiseï¼Œå†å›å¤´çœ‹çœ‹ä»¥å‰çš„ï¼Œä»…ä»…ç”±å›è°ƒå‡½æ•°æ„æˆçš„æ‘‡æ‘‡æ¬²å çš„å¼‚æ­¥ä»£ç æ—¶ï¼Œä½ å‘ç°ä½ å†ä¹Ÿå›ä¸å»äº†â€¦â€¦

Promise é€šè¿‡é¢ è¦†æ§åˆ¶åè½¬ï¼Œå¸¦æ¥çš„ä¸ä»…ä»…æ˜¯å¯ä¿¡ä»»çš„ä»£ç å’Œæ‰§è¡Œæœºåˆ¶ï¼Œæ›´ä¸ºé‡è¦çš„æ˜¯å®ƒè§£æ”¾äº†æˆ‘ä»¬çš„å¿ƒæ™ºï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿæ›´ä¸“æ³¨äºå…¶ä»–ä»»åŠ¡ã€‚

## é“¾å¼æµ(Chain Flow)
å‰é¢æˆ‘ä»¬å·²ç»çœ‹è¿‡ä¸æ­¢ä¸€éäº†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€è¿ä¸² *this-then-that* çš„æ“ä½œï¼Œå°†è®¸å¤šä¸ª Promise ä¸²è”èµ·æ¥ï¼Œç»„æˆä¸€ä¸ªæœ‰åºçš„å¼‚æ­¥é“¾å¼ä»£ç å—ã€‚

è€Œè®©è¿™ä¸€åˆ‡èµ·ä½œç”¨çš„æ ¸å¿ƒï¼Œæºè‡ªäº Promise çš„ä¸¤ä¸ªå†…ç½®çš„è¡Œä¸ºæ¨¡å¼ï¼š

- æ¯æ¬¡è°ƒç”¨ Promise çš„ `then(â€¦)` æ–¹æ³•åï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¸€ç›´é“¾æ¥ä¸‹å»ï¼›

- æ— è®º `then(â€¦)` çš„ fulfillment å›è°ƒå‡½æ•°(å³ `then` çš„ç¬¬ä¸€ä¸ªå‚æ•°) return ä»»ä½•å€¼ï¼Œå®ƒéƒ½ä¼šè¢«è‡ªåŠ¨çš„è®¾ç½®ä¸º Promise é“¾ä¸­çš„ fulfillment çŠ¶æ€ã€‚

```js
var p = Promise.resolve(22);

var p2 = p.then(res => {
  console.log(res); // 22
  return res * 2;
});

p2.then(res => console.log(res)); // 44
```

return çš„ `res * 2` å°±æ˜¯ç¬¬ä¸€ä¸ª `then(â€¦)` æ–¹æ³•çš„ fulfillment å›è°ƒå‡½æ•°è¿”å›çš„å€¼ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨è®¾ç½®ä¸º `p2` çš„ `then(â€¦)` æ–¹æ³•çš„ fulfillment å›è°ƒå‡½æ•°æ¥æ”¶åˆ°çš„å€¼ã€‚è€Œåä½ å¯ä»¥å°† `p2.then(â€¦)` è¿”å›çš„å€¼å‚¨å­˜åˆ°å¦ä¸€ä¸ªå˜é‡ `p3` ä¸­ï¼Œå¹¶æ“ä½œå®ƒçš„ `then(â€¦)` æ–¹æ³•â€¦â€¦

å¯å³ä¾¿æ˜¯å°† Promise å‚¨å­˜äº `p2` ä¹Ÿæ˜¾å¾—æœ‰äº›å¤šä½™ï¼Œç›´æ¥ â€œä¸²â€ èµ·æ¥å…¶å®å°±å¯ä»¥äº†ï¼š

```js
var p = Promise.resolve(22);

p
.then(res => {
  console.log(res); // 22
  return res * 2;
})
.then(res => console.log(res));
```

ğŸ‘†æ— è®ºä½ æƒ³ â€œä¸²â€ èµ·å¤šå°‘ä¸ª `then(â€¦)` éƒ½æ˜¯å¯ä»¥çš„ï¼Œè¿™æºäºæ¯ä¸ª `then(â€¦)` éƒ½ä¼šè‡ªåŠ¨çš„è¿”å›ä¸€ä¸ªæ–°çš„ Promise çš„æœ¬è´¨æ‰€åœ¨ã€‚

åˆ°è¿™é‡Œï¼Œâ€œè¿™é“èœâ€ ä¼¼ä¹ä¸€åˆ‡éƒ½å¾ˆå®Œç¾ï¼Œä½†è¿˜æ˜¯æ„Ÿè§‰ç¼ºç‚¹è°ƒæ–™ â€”â€” è‹¥æ˜¯æƒ³åœ¨ `then(â€¦)` ä¸­å¤„ç†ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶ï¼Œå‘èµ·ä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„è¯ï¼Œè¦æ€ä¹ˆåšå‘¢ï¼Ÿå…³é”®ä¾ç„¶åœ¨ `then(â€¦)` çš„è¿”å›å€¼ä¸Šï¼š

```js
var p = Promise.resolve(22);

p
.then(res => {
  console.log(res); // 22
  return new Promise((resolve, reject) => {
    resolve(res * 2); // å°† Promise çš„çŠ¶æ€è®¾ç½®ä¸º fulfillï¼Œä»¥ä¾¿èƒ½åœ¨ä¸‹ä¸€ä¸ª then(â€¦) ä¸­çš„ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°ä¸­æ‹¿åˆ°ç›¸åº”çš„å€¼
  });
})
.then(res => console.log(res));
```

ğŸ‘†çœ‹è§äº†ä¹ˆï¼Ÿå…³é”®æ˜¯ return ä¸€ä¸ª thenable æˆ– Promiseï¼Œè€Œååœ¨ä¸‹ä¸€ä¸ª `then(â€¦)` æ–¹æ³•é‡Œçš„å›è°ƒå‡½æ•°è¢«è°ƒç”¨å‰ï¼Œä¼šä¸€å±‚å±‚åœ°é€’å½’æ‹†è§£(unwrapping)è¿™ä¸ªè¿”å›çš„ thenable æˆ– Promiseï¼Œç›´åˆ°å®ƒçš„æœ€åçŠ¶æ€è¢«ç¡®å®šä¸‹æ¥(resolution)ä¸ºæ­¢ã€‚

å› æ­¤ï¼Œæƒ³è¦åœ¨è¿™ä¸€ä¸²é“¾å¼ä¸­å®ç°å¼‚æ­¥æ“ä½œï¼š

```js
var p = Promise.resolve(22);

p
.then(res => {
  console.log(res); // 22
  return new Promise((resolve, reject) => {
    // 1000 æ¯«ç§’åçš„å¼‚æ­¥æ“ä½œ
    console.time();
    setTimeout(() => resolve(res * 2), 1000);
  });
})
.then(res => {
  console.timeEnd();
  console.log(res);
}); // logä¼šå‘ç”Ÿåœ¨ 1000 æ¯«ç§’å
```

![promise_async](./assets/promise_chain_flow_async.png)

ğŸ‘†è¿™ä¹Ÿæ„å‘³ç€ï¼Œæ¯ä¸€æ­¥éƒ½èƒ½ä½¿ç”¨å¼‚æ­¥ï¼Œç²¾å‡†åœ°æ§åˆ¶ä½•æ—¶è§¦å‘ä¸‹ä¸€æ­¥çš„å›è°ƒå‡½æ•°ï¼Œå½¢æˆä¸€æ¡å®Œæ•´çš„å¼‚æ­¥æµï¼š

```js
function delay (time, data) {
  return new Promise(function (resolve, reject) {
    setTimeout(() => resolve(data), time)
  });
};

delay(100)
.then(function step2() {
  console.log('step 2 after 100ms');
  return delay(200);
})
.then(function step3() {
  console.log('step 3 after 200ms');
})
.then(function step4() {
  console.log('step 4 next job');
  return delay(50);
})
.then(function step5() {
  console.log('step 5 after 50ms');
})
```

è‹¥æ˜¯æ²¡æœ‰æŒ‡å®š return å€¼ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å› `undefined`ï¼Œä½†è¿™å¹¶ä¸ä¼šå½±å“åˆ° Promise çš„é“¾å¼æµã€‚ä½†è¯´å¥å®è¯ï¼Œç®€å•çš„ä½¿ç”¨ `setTimeout` æ¥å»¶è¿Ÿä»£ç æ‰§è¡Œçš„æ—¶é—´ï¼Œåœ¨å®é™…çš„å¼€å‘ä¸­å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼ŒğŸ‘‡ä»¥ä¸‹æ˜¯æ›´è´´è¿‘å®é™…å¼€å‘çš„ä¾‹å­ï¼š

```js
function request (url) {
  return new Promise((resolve, reject) => {
    ajax(url, resolve);
  });
}

request('http://some.url.1/')
.then(response1 => request(`http://some.url.2/?v=${response1}`))
.then(response2 => console.log(response2));
```

ä¸¤ä¸ªä¸²è¡Œçš„ç½‘ç»œè¯·æ±‚ï¼Œç¬¬äºŒä¸ªè¯·æ±‚ä¾èµ–äºç¬¬ä¸€ä¸ªè¯·æ±‚è¿”å›çš„å€¼ï¼Œè¿™æ ·çš„åœºæ™¯åœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¸¸è§ã€‚æ­¤æ—¶ Promise çš„é“¾å¼ç»“æ„ä¸ä»…å®ç°äº†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡æŒ‰ç…§é¡ºåºä¸²è¡Œè¿›è¡Œï¼Œè€Œä¸”è¿˜èƒ½å¤Ÿåœ¨æ¯ä¸ªæ­¥éª¤é—´å®ç°æ¶ˆæ¯çš„ä¼ é€’ã€‚

ä¸è¿‡ï¼Œä»»ä½•ç¨‹åºéƒ½å¯èƒ½ä¼šå‘ç”Ÿå¼‚å¸¸æƒ…å†µï¼Œåœ¨ Promise ä¸­å½“ç„¶ä¹Ÿå†…ç½®äº†å¯¹å¼‚å¸¸çš„å¤„ç†é€»è¾‘ï¼š

```js
request('http://some.url.1/')
.then(response1 => {
  foo.bar(); // error!
  request(`http://some.url.2/?v=${response1}`);
})
.then(
  response2 => console.log(response2),
  err => {
    console.log(err);
    return 42;
  }
)
.then(msg => console.log(msg)); // 42
```

`then(â€¦)` çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œè¢«è°ƒç”¨çš„ rejection å›è°ƒå‡½æ•°ã€‚æ— è®ºæ˜¯ `reject`ã€`throw new Error(â€¦)`ã€æˆ–è€…æ˜¯ä¸Šé¢çœ‹åˆ°é”™è¯¯ä»£ç  `foo.bar();`ï¼Œéƒ½ä¼šæ¿€æ´» rejection å›è°ƒå‡½æ•°ã€‚

æ— è®ºæ˜¯å¿½ç•¥ fulfillment è¿˜æ˜¯ rejection çš„å›è°ƒå‡½æ•°ï¼Œä¸€æ—¦ Promise çš„çŠ¶æ€è¢«ç¡®å®šåï¼Œéƒ½ä¼šç»§ç»­æ²¿ç€ Promise é“¾å†’æ³¡ï¼Œç›´åˆ°é‡è§å¤„ç†å®ƒçš„å›è°ƒå‡½æ•°ä¸ºæ­¢ï¼š

```js
var p = Promise.reject('reject msg!');

p
.then(
  res => console.log('fulfillment handler: ', res)
)
.then(
  null,
  err => console.log('rejection handler: ', err)
);
```

![rejection_handler](./assets/promise_chain_flow_rejection.png)

**Note**ï¼šæœ¬è´¨ä¸Šæ¥çœ‹ï¼Œ`then(null, function (err) { //... })` çš„æ¨¡å¼å’Œ `catch(function (err) { //... })` è¡Œä¸ºä¸€è‡´ã€‚

æ— è®ºé“¾å¼æµå¤šä¹ˆæœ‰ç”¨ï¼Œéƒ½ä¸è¯¥æŠŠå®ƒè§†ä¸ºæ˜¯ Promise çš„æœ€æ ¸å¿ƒçš„æ„ä¹‰æ‰€åœ¨ï¼Œé¡¶å¤šç®—ä½œæ˜¯ä¸€ä¸ªå‰¯äº§å“ã€‚è€Œ *æ ‡å‡†åŒ–å¼‚æ­¥æ“ä½œæµç¨‹* å’Œ *å°†æ—¶é—´å’ŒçŠ¶æ€éƒ½å°è£…åˆ°å€¼çš„ä¾èµ–ä¸­*ï¼Œæ˜¯è®©æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶é“¾æ¥èµ·æ¥çš„å…³é”®æ‰€åœ¨ã€‚

ä¸è¿‡ï¼Œé“¾å¼è°ƒç”¨çš„ *this-then-this-then-this...* çš„æ¨¡å¼ä¾ç„¶æœ‰å¤ªå¤šçš„ â€œå…«è‚¡(boilerplate)â€ éœ€è¦ä¸€æ¬¡åˆä¸€æ¬¡çš„è¢«å®ç°å‡ºæ¥ï¼Œè€Œè§£å†³è¿™ä¸ªé—®é¢˜æ˜¯éœ€è¦ä¸€ä¸ªæ›´ä¸ºä¼˜é›…çš„å¼‚æ­¥æµç¨‹æ§åˆ¶æ¨¡å¼ â€”â€” generatorã€‚

### æœ¯è¯­ï¼šResolve, Fulfill å’Œ Reject(Terminology: Resolve, Fulfill, and Reject)
å¯¹äº "resolve"ã€"fulfill"ã€"reject" è¿™äº›æœ¯è¯­ï¼Œå¥½åƒå¤§è‡´èƒ½åŒºåˆ«å®ƒä»¬ï¼Œä½†å§‹ç»ˆæœ‰ä¸€äº›å›°æƒ‘ï¼Œä¸æ˜ç™½å®ƒä»¬ä¹‹é—´åˆ°åº•æœ‰å•¥ä¸ä¸€æ ·ã€‚å…ˆåˆ«æ€¥ï¼Œæ¥çœ‹ä¸€æ®µä»£ç ï¼š

```js
var p = new Promise(function (x, y) {
  // x() -> fulfillment
  // y() -> rejection
});
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ä¾‹åŒ– Promise çš„å›è°ƒå‡½æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°çš„è°ƒç”¨ `x()` æ ‡å¿—ç€ Promise è¢«å®šä¸º fulfill çš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™ä»£è¡¨ Promise è¢«å®šä¸º reject çš„çŠ¶æ€ã€‚ä½†è¯·æ³¨æ„è¿™ä¸ªç»†èŠ‚ â€”â€” â€œé€šå¸¸â€ã€‚

æœ¬è´¨ä¸Šæ¥çœ‹ï¼Œä½ å†™çš„ä»£ç  `function (x, y) { //â€¦ }` å¯¹äº JSå¼•æ“ æ¥è¯´éƒ½æ˜¯ä¸€æ ·çš„ â€”â€” æ— è®ºæ˜¯ `x` è¿˜æ˜¯ `y` å¯¹å®ƒæ¥è®²éƒ½åªä¸è¿‡æ˜¯ç›¸åŒçš„å‡½æ•°ä½“ï¼Œä½†æ˜¯å‡½æ•°çš„åå­—ï¼Œä¸ä»…ä»…å…³ä¹ä½ è‡ªå·±å¯¹äºä»£ç çš„ç†è§£ï¼Œæ›´ä¸ºå…³é”®çš„æ˜¯ä½ å›¢é˜Ÿçš„å…¶ä»–å¼€å‘è€…å¦‚ä½•ç†è§£ä½ çš„ä»£ç ã€‚ä¸€æ®µå³ä¾¿æ˜¯ç²¾å¿ƒç¼–æ’è®¾è®¡ï¼Œä½†æ€è€ƒé”™è¯¯çš„å¼‚æ­¥ä»£ç å¸¦æ¥çš„å±å®³ï¼Œè¿œæ¯”æ„å¤§åˆ©é¢æ¡èˆ¬çš„å›è°ƒåœ°ç‹±(spaghetti-callback)å¼‚æ­¥ä»£ç å±å®³æ›´å¤§ï¼Œå› æ­¤å¦‚ä½•ç»™ `x` å’Œ `y` ä¸€ä¸ªå‡†ç¡®çš„å‘½åæ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚

ğŸ‘†ä½¿ç”¨ `reject(â€¦)` æ¥å‘½åå®ä¾‹åŒ– Promise å›è°ƒçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ­£ç¡®çš„é€‰æ‹©ã€‚è€Œå¯¹äºç¬¬ä¸€ä¸ªå‚æ•°çš„ç§°è°“ï¼Œå³ä¾¿æ˜¯å®˜æ–¹æ¨èä½¿ç”¨çš„ `resolve(â€¦)`ï¼Œå´ä¹Ÿæ€»æ˜¯ä¼šè®©äººè”æƒ³åˆ° "resolution(å†³å®š)" çš„æ„æ€ â€”â€” è¿™ä¸ªå«ä¹‰é€šå¸¸ä¼šè¢«ç†è§£ä¸º â€œç¡®å®š Promise æœ€ç»ˆçš„å€¼/çŠ¶æ€â€ã€‚

è‹¥æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°è¢«æŒ‡å®šä¸º Promise çš„ fulfill çŠ¶æ€çš„è¯ï¼Œé‚£ä¸ºä½•æˆ‘ä»¬ä¸ç”¨ `fulfill(â€¦)` å–ä»£ `resolve(â€¦)` å‘¢ï¼Ÿè¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œè¿˜å¾—ä»”ç»†çœ‹çœ‹ä¸¤ä¸ª Promise çš„ APIï¼š

```js
var fulfilledPr = Promise.resolve(42);
var rejectedPr = Promise.reject('err');
```

`Promise.resolve(â€¦);` è¿™ä¸ª API å°†æ•°å­— `42` å®šä¸º Promise çš„æœ€ç»ˆå€¼ï¼ŒçŠ¶æ€ä¸º fulfilledï¼›è€Œ `Promise.reject('err');` æ˜¾ç„¶æ˜¯åˆ›å»ºä¸€ä¸ªçŠ¶æ€ä¸º rejected çš„ Promiseï¼Œç†ç”±(å€¼)æ˜¯ `err`ã€‚

ğŸ‘†è¿™å¥½åƒå¹¶æ²¡æœ‰è¯´æ˜ä¸ºå•¥ `resolve(â€¦)` ä¸ç”¨ `fulfill(â€¦)` çš„é—®é¢˜ï¼Ÿå…ˆåˆ«æ€¥ï¼Œçœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼š

```js
var rejectedTh = {
  then: function (resolved, rejected) {
    rejected('err msg');
  }
};

var rejectedPr = Promise.resolve(rejectedTh);
```

è¿˜è®°å¾—å—ï¼Ÿ`Promise.resolve(â€¦)` ä¼šå°†ä¼ å…¥å…¶ä¸­çš„ thenable æˆ–è€… Promise è§£æå¹¶å±•å¼€ï¼Œå°±ä¸Šé¢çš„ä¾‹å­è€Œè¨€ï¼Œ`Promise.resolve(â€¦)` ä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€æ˜¯ rejected çš„ Promiseã€‚å› æ­¤ï¼Œè¿™ä¸ªæ—¶å€™è‹¥æ˜¯ç”¨ `fulfill(â€¦)` ä½œä¸ºæ–¹æ³•åå°±æ˜¾å¾—å¾ˆä¸åˆæ—¶å®œäº†ï¼Œç›¸æ¯”è¾ƒè€Œè¨€ï¼Œ`resolve(â€¦)` æ˜¾ç„¶æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

è€Œå³ä¾¿æ˜¯åœ¨å®ä¾‹åŒ– Promise çš„å›è°ƒå‡½æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åŒæ ·å’Œ `Promise.resolve(â€¦)` ä¸€æ ·ï¼Œä¼šè§£æä¼ å…¥å…¶ä¸­çš„ thenable æˆ–è€… Promiseï¼š

```js
var rejectedPr = new Promise(function (resolve, reject) {
  resolve(Promise.reject('err msg'));
});

rejectedPr.then(
  function fulfilled () {
    // never gets here
  },
  function rejected (err) {
    console.log(err); // "err msg"
  }
);
```

æ‰€ä»¥ï¼Œ`resolve(â€¦)` æ˜¾ç„¶ä¹Ÿæ˜¯å®ä¾‹åŒ– Promise çš„å›è°ƒå‡½æ•°ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°æ›´ä¸ºå‡†ç¡®çš„åç§°ã€‚

**Note**ï¼šğŸ‘† `resolve(Promise.reject('err msg'));` å¹¶ä¸ä¼šæŠŠ `Promise.reject('err msg')` çš„ `'err msg'` è§£æå‡ºæ¥ï¼Œåšè¿™ä»¶äº‹æƒ…çš„æ˜¯ `then(â€¦)` ä¸­çš„ `rejected` å›è°ƒå‡½æ•°ã€‚

è€Œå¯¹äºåœ¨ `then(â€¦)` æ–¹æ³•ä¸­å®šä¹‰çš„ä¸¤ä¸ªå›è°ƒå‡½æ•°å‘¢ï¼Ÿ`fulfilled(â€¦)` å’Œ `rejected(â€¦)` æ˜¾ç„¶æ›´ä¸ºå‡†ç¡®ï¼š

```js
function fulfilled (res) {
  console.log(res);
}

function rejected (err) {
  console.error(err);
}

p.then(
  fulfilled,
  rejected
);
```

åœ¨ ES6 çš„è¯´æ˜æ–‡æ¡£é‡Œé¢ç”¨çš„æ˜¯ `onFulfilled(â€¦)` å’Œ `onRejected(â€¦)`ï¼Œè€Œå®é™…ä¸Šä¹Ÿçš„ç¡®å¦‚æ­¤ï¼Œç¬¬ä¸€ä¸ªå›è°ƒçš„è§¦å‘æ˜¯ Promise è¢«ç¡®å®šä¸º fulfill çŠ¶æ€ï¼›è€Œç¬¬äºŒä¸ªå›è°ƒçš„è§¦å‘æ˜¯ Promise è¢«ç¡®å®šä¸º reject çŠ¶æ€ã€‚


## é”™è¯¯å¤„ç†(Error Handling)
åŒæ­¥çš„ `tryâ€¦catch` æ˜¯å¤§å¤šæ•°JSå¼€å‘è€…é€‰æ‹©çš„å¼‚å¸¸å¤„ç†æ–¹å¼ã€‚ä½†æ˜¯åœ¨å¼‚æ­¥ä»£ç ä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œè¿™ä¸ªæ–¹æ¡ˆæ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼š

```js
function foo () {
  setTimeout(function () {
    baz.bar();
  }, 1000);
}

try {
  foo();
}
catch (err) {
  console.error('try catch æ•è·çš„å¼‚å¸¸ï¼š', err);
}
```

é™¤éé€šè¿‡ä¸€äº›ç‰¹æ®Šçš„æ‰‹æ®µï¼Œå¦åˆ™ `tryâ€¦catch` æ²¡åŠæ³•æå®šå¼‚æ­¥ä»£ç çš„å¼‚å¸¸å¤„ç†ã€‚

è‹¥æ˜¯ä¼ ç»Ÿçš„å›è°ƒå¼‚æ­¥ï¼Œå¼‚å¸¸çš„å¤„ç†ä¸€èˆ¬æ˜¯é€šè¿‡æ‰€è°“çš„ â€œé”™è¯¯ä¼˜å…ˆ(error-first callback style)â€ æ¨¡å¼ï¼š

```js
function foo (cb) {
  setTimeout(function () {
    try {
      var x = baz.bar();
      cb(null, x);
    }
    catch (err) {
      cb(err);
    }
  }, 1000);
}

foo(function (err, val) {
  if (err) {
    console.error('error-first callback: ', err);
  } else {
    console.log(val);
  }
});
```

ä¼ å…¥ `foo(â€¦)` çš„å›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè‹¥æ˜¯é falsy çš„å€¼ï¼Œå°±ä¼šè¢«è®¤ä¸ºå¼‚å¸¸å‘ç”Ÿäº†ï¼›å¦åˆ™çš„è¯ï¼Œå°±æ˜¯æˆåŠŸäº†ã€‚è™½ç„¶è¿™ç§å¼‚æ­¥çš„é”™è¯¯å¤„ç†åœ¨æŠ€æœ¯ä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å’Œå›è°ƒåœ°ç‹±çš„é—®é¢˜ä¸€æ ·ï¼Œè‹¥æ˜¯æœ‰å¤šä¸ª `ifâ€¦elseâ€¦` çš„é¢æ¡ä»£ç ï¼Œç»•ä¹Ÿèƒ½æŠŠä½ ç»•æ™•ã€‚

Promise é‡‡ç”¨çš„å¼‚å¸¸å¤„ç†ç­–ç•¥æ˜¯ â€œåˆ†è€Œæ²»ä¹‹â€ï¼Œå³å°†å¼‚å¸¸å¤„ç†çš„å›è°ƒå‡½æ•°æ‹†åˆ†å¼€ï¼š

```js
var p = Promise.reject('err msg');

p.then(
  function fulfilled () {
    // â€¦
  },
  function rejected (err) {
    console.error(err);
  }
);
```

è¿™ç§æ¨¡å¼çœ‹ä¸Šå»å¥½åƒæŒºå¥½çš„ï¼Œä½†å…¶å®å‘¢ï¼Œä¹Ÿæ˜¯æœ‰éšå«çš„é—®é¢˜å­˜åœ¨çš„ï¼š

```js
var p = Promise.resolve(42);

p.then(
  function fulfilled (res) {
    // number æ²¡æœ‰ toLowerCase æ–¹æ³•
    // å› æ­¤ä¼šæŠ›å‡ºå¼‚å¸¸
    console.log(res.toLowerCase());
  },
  function rejected (err) {
    // â€¦
  }
);
```

ğŸ‘†ä¹‹å‰æˆ‘ä»¬[è®¨è®ºè¿‡](https://github.com/BobbyLH/ReadingNotes---You-Dont-Know-JS/blob/master/async%20%26%20performance/Promises.md#%E5%90%9E%E6%8E%89%E4%BA%86%E5%90%84%E7%A7%8D%E5%BC%82%E5%B8%B8%E5%92%8C%E9%94%99%E8%AF%AFswallowing-any-errorsexceptions)ä¸ºä»€ä¹ˆ `function rejected (err) { // â€¦ }` æ²¡åŠæ³•æ•è·åˆ°å¼‚å¸¸ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

è¿™å¾ˆå¥½çš„è§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨ Promise ä¸­å¤„ç†å¼‚å¸¸å¾ˆå®¹æ˜“å‡ºé—®é¢˜ã€‚

**è­¦å‘Š**ï¼šè‹¥æ˜¯ä½ åœ¨åˆ›å»º Promise çš„è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰æŒ‰ç…§è§„èŒƒæ¥(æ¯”å¦‚ `new Promise(null)`ã€`Promise.all()`ã€`Promise.race(42)`)ï¼Œé‚£è¿™ä¸ªå¼‚å¸¸ä¼šç«‹åˆ»è¢«æŠ›å‡ºï¼Œè€Œä¸æ˜¯è¢«è§£æä¸º rejected çŠ¶æ€åï¼Œç”± reject çš„å›è°ƒå‡½æ•°æ¥å¤„ç†ã€‚

### ç»æœ›ä¹‹å‘(Pit of Despair)
Jeff Atwood å¤šå¹´å‰çš„ä¸€ç¯‡åšå®¢ [ç»æœ›ä¹‹å‘](https://blog.codinghorror.com/falling-into-the-pit-of-success/) æ˜¯è¿™ä¸€èŠ‚æ ‡é¢˜çš„èµ·æºã€‚

è€Œ Promise ä¹Ÿæœ‰æ‰€è°“çš„ â€œç»æœ›ä¹‹å‘â€ â€”â€” å¯¹é”™è¯¯å¤„ç† â€”â€” ä¸€æ—¦ä½ å¿˜è®°å»ç›‘å¬å®ƒçš„é”™è¯¯äº‹ä»¶ï¼Œé‚£å®ƒé»˜è®¤å°±ä¼šåå™¬æ‰æ‰€æœ‰çš„é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ˜¾ç„¶éš¾ä»¥è®©äººæ¥å—ã€‚

é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œç¤¾åŒºä¸­æå‡ºçš„é¿å…çš„åŠæ³•æ˜¯ï¼šæ— è®ºå¦‚ä½•ï¼Œä¸€å®šè¦åœ¨ä½ çš„ Promise ä»£ç ååŠ ä¸Š `catch(â€¦)`ï¼Œä»¥æ­¤æ¥ä¿è¯é”™è¯¯ä¿¡æ¯èƒ½è¢«æ•è·ï¼š

```js
const p = Promise.resolve(42);

p
  .then(msg => console.log(msg.toLowerCase()))
  .catch(handleErrors);
```

ğŸ‘†åœ¨ `then(â€¦)` æ–¹æ³•ä¸­çš„ `msg.toLowerCase()` æ˜¾ç„¶ä¼šå¯¼è‡´é”™è¯¯çš„å‘ç”Ÿï¼Œå› ä¸º `p` resolve çš„å€¼ä¸ºæ•°å­—ç±»å‹çš„ `42`ï¼Œè€Œç´§éšå…¶åçš„ `catch(â€¦)` åœ¨è¿™ä¸ªä¾‹å­ä¸­èƒ½å¤Ÿå¾ˆå¥½çš„æ•è·åˆ°é”™è¯¯çš„ä¿¡æ¯ã€‚

æ‰€ä»¥ï¼Œæå®šäº†ï¼Ÿæ²¡é‚£ä¹ˆç®€å• â€”â€” è‹¥æ˜¯ `handleErrors(â€¦)` è‡ªå·±æœ¬èº«å‘ç”Ÿäº†é”™è¯¯å‘¢ï¼Ÿè¿™å°±å¥½åƒç›‘ç®¡è€…è‡ªå·±ä¸éµå®ˆè§„åˆ™ï¼Œä»è€Œç›‘å®ˆè‡ªç›—ä¸€æ ·ï¼Œè€Œä½ ä¹Ÿæ²¡åŠæ³•é€šè¿‡å†åŠ ä¸€ä¸ª `catch(â€¦)` æ¥è§£å†³é—®é¢˜ï¼Œå› ä¸ºï¼Œè¿™ä¸ªç›‘æ§ç¨‹åºä¾ç„¶å¯èƒ½å‘ç”Ÿé”™è¯¯ â€”â€” å¥½åƒè¿›å…¥äº†æ­»èƒ¡åŒï¼Ÿ

### æœªæ•è·çš„å¼‚å¸¸(Uncaught Handling)
ç›®å‰ä¸ºæ­¢ï¼Œè¿˜æ²¡æœ‰åŠæ³•èƒ½å¤Ÿå½»åº•è§£å†³ä¸Šé¢çš„é—®é¢˜ï¼Œä½†ä¸æ’é™¤çš„ç¡®æœ‰åŠæ³•èƒ½å¤Ÿå¤„ç†çš„æ›´ä¼˜é›…ä¸€äº›ã€‚

æœ‰ä¸€äº› Promise çš„ç¬¬ä¸‰æ–¹åº“å®ç°äº†ä¸€ä¸ª â€œå…¨å±€æœªæ•è·å¼‚å¸¸(global unhandled reject)â€ çš„å¤„ç†é€»è¾‘ â€”â€” æ¯”æ–¹è¯´å½“ç›‘æµ‹åˆ° Promise çš„çŠ¶æ€å˜æˆäº† rejectedï¼Œæ­¤æ—¶å¼€å¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨ 3 ç§’åè‹¥æ²¡æœ‰ä»»ä½•çš„å¼‚å¸¸å¤„ç†ç¨‹åºè¢«è§¦å‘ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå‡å®šè¯´è¿™ä¸ª Promise æœ‰ä¸€ä¸ª `uncaught` çš„å¼‚å¸¸ã€‚

ä½†ï¼Œé€šè¿‡ 3 ç§’æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº† â€œæœªæ•è·çš„å¼‚å¸¸â€ æ˜¾ç„¶å¤ªè¿‡æ­¦æ–­äº†ï¼Œå³ä¾¿æ˜¯è¿™æ•°å€¼(3ç§’)é€šè¿‡äº†å¤§é‡çš„å®éªŒéªŒè¯ï¼Œæ¯”å¦‚ä¾ç„¶ä¼šæœ‰è¿™æ ·çš„æƒ…å†µå­˜åœ¨ï¼šåœ¨æŸä¸ªåœºæ™¯ä¸‹å‘ç”Ÿçš„é”™è¯¯ï¼Œå°±æ˜¯éœ€è¦ä½ å»¶æ—¶å¤„ç†ï¼Œè¿™ä¸ªæ—¶å€™ä½ å¸Œæœ›çš„æ˜¯ Promise èƒ½ hold ä½è¿™äº›é”™è¯¯ï¼Œè€Œä¸æ˜¯æŠ¥ä¸€ä¸ª uncaught errorsã€‚

å¦å¤–çš„ä¸€ç§å‘¼å£°æ˜¯åœ¨ Promise ä¸­æ·»åŠ  `done(â€¦)` æ–¹æ³•ï¼šåœ¨è¿™ä¸ªæ–¹æ³•æ‰§è¡Œå®Œåï¼Œå®ƒä¸ä¼šåƒå…¶ä»–æ–¹æ³•ä¸€æ ·è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œè¿™å°±ä¼šç»“æŸåˆ°æ— ä¼‘æ­¢çš„é“¾å¼ä»£ç ï¼Œå› æ­¤ç”±é“¾å¼è°ƒç”¨å¯èƒ½å¯¼è‡´çš„æ— ç©·å°½çš„é”™è¯¯å°±èƒ½å¤Ÿè¢«é¿å…ã€‚

è€Œè¿™æœ€ç»ˆä¼šå¯¼è‡´åœ¨ `done(â€¦)` ä¸­äº§ç”Ÿçš„é”™è¯¯è¢«æŠ›åˆ°å…¨å±€ï¼š

```js
const p = Promise.resolve(42);

p
  .then(msg => console.log(msg.toLowerCase()))
  .done(null, handleErrors);
```

ğŸ‘†è¿™æ¯”èµ·ä¹‹å‰çš„æ³•å­ï¼Œç¡®å®æ›´ä¼˜é›…äº†ã€‚ä½†é—®é¢˜æ˜¯ï¼Œè¿™ä¸ªæ–¹æ¡ˆå¹¶æ²¡æœ‰åœ¨ ES6 ä¸­è¢«æ ‡å‡†åŒ–ï¼Œå› æ­¤æœ€å¥½çš„å‡ºè·¯æ˜¯æ‰¾åˆ°ä¸€ä¸ªå¯é çš„ä¸”é€šç”¨çš„è§£å†³æ–¹æ¡ˆã€‚

è¿˜æœ‰ä¸€ç§æ–¹æ¡ˆï¼Œå€ŸåŠ©æµè§ˆå™¨çš„åº•å±‚èƒ½åŠ›ï¼šæµè§ˆå™¨æ‹¥æœ‰çš„åº•å±‚èƒ½åŠ›ï¼Œæ¯”èµ·æˆ‘ä»¬èƒ½é€šè¿‡JSä»£ç æ˜¯ç°å®çš„ï¼Œè¦å¼ºå¤§å¾ˆå¤šï¼Œå°±æ¯”å¦‚å¯¹ Promise è°ƒç”¨æ ˆçš„è¿½è¸ªã€‚å½“åƒåœ¾å›æ”¶è§¦å‘æ—¶ï¼Œæµè§ˆå™¨å½“ç„¶ Promise çš„çŠ¶æ€æ˜¯å¦æ˜¯ rejectionï¼Œè€Œä¸”è¿˜èƒ½çŸ¥é“æ˜¯å¦æœ‰ uncaught error â€”â€” æŠŠå®ƒè¾“å‡ºåˆ°æ§åˆ¶å°åº”è¯¥æ²¡æœ‰ä»»ä½•éš¾åº¦ã€‚

ä½†ä¹Ÿæœ‰é—®é¢˜ï¼Œæ¯”å¦‚å½“ Promise æ²¡æœ‰è¢«åƒåœ¾å›æ”¶çš„æ—¶å€™ â€”â€” è¿™æ ·çš„æƒ…å†µæ—¶é•¿ä¼šå‘ç”Ÿåœ¨ä½ çš„ä»£ç è¶Šå†™è¶Šå¤šï¼Œè¿›è€Œå˜å¾—æ‚ä¹±ä¸å ªæ—¶ï¼Œé¬¼çŸ¥é“å“ªæ®µä»£ç å½¢æˆäº†é—­åŒ…ï¼Œè¿›è€Œå¯¼è‡´å†…å­˜æº¢å‡ºå•¥çš„ã€‚é‚£é€šè¿‡æµè§ˆå™¨è¿½è¸ª Promise çš„è°ƒç”¨æ ˆï¼Œä»è€Œå‘ç° uncaught error çš„åŠæ³•ï¼Œå°±ä¸å¤ªé è°±äº†ã€‚

é‚£ä¹ˆï¼Œè¿˜æœ‰åˆ«çš„åŠæ³•å—ï¼Ÿå½“ç„¶ï¼

### æˆåŠŸä¹‹å‘(Pit of Success)
è™½ç„¶ä¸‹é¢çš„éƒ¨åˆ†éƒ½æ˜¯çº¯ç†è®ºçš„ï¼Œä½†æœªæ¥çš„æŸå¤©ï¼ŒPromise è¯´ä¸å®šå°±ä¼šå®ç°è¿™äº›åŠŸèƒ½(å³ä¾¿æ²¡æœ‰å®ç°ï¼Œä¹Ÿèƒ½é€šè¿‡å„ç§ polyfill æ¥å®ç°ï¼Œå› ä¸ºå®ƒæ²¡æœ‰æ‰“ç ´ä»»ä½•ç°æœ‰çš„æœºåˆ¶ï¼Œä»è€Œæœ‰ä¸é”™çš„å…¼å®¹æ€§)ï¼š

- Promise ä¼šåœ¨ä¸‹ä¸€è½®çš„ ä»»åŠ¡(Job) æˆ– äº‹ä»¶å¾ªç¯(event lop) å°†ä»»ä½•æœªæ•è·çš„é”™è¯¯æŠ¥å‘Šå‡ºæ¥ï¼›

- Promise çš„å®ä¾‹ä¸Šä¼šå®ç°ä¸€ä¸ª `defer()` æ–¹æ³•ï¼Œå®ƒå¯ä»¥æ— é™æœŸçš„å»¶è¿Ÿ Promise æœªæ•è·çš„å°†è¦è‡ªåŠ¨ä¸ŠæŠ¥çš„é”™è¯¯ã€‚

è‹¥æ˜¯ Promise å‘ç”Ÿäº†å¼‚å¸¸ï¼Œè¢« rejectedï¼Œé‚£å®ƒçš„é»˜è®¤è¡Œä¸ºæ˜¯å°†é”™è¯¯ä¿¡æ¯æ‰“å°åœ¨æ§åˆ¶å°è€Œä¸æ˜¯å°†é”™è¯¯ â€œæ²‰é»˜çš„åå™¬æ‰â€ï¼š

```js
const p = Promise.reject('error msg').defer();

foo(42)
  .then(
    function fulfilled() {
      return p;
    },
    function rejected(err) {
      // handle `foo(..)` error
    }
  );
	
```

ğŸ‘†`defer()` æ¨è¿Ÿäº†é”™è¯¯çš„å¤„ç†ï¼Œæ­¤æ—¶å¹¶ä¸ä¼šæŠ¥å‘Šä»»ä½•é”™è¯¯çš„å‘ç”Ÿï¼Œè€Œä¸”å®ƒè¿˜ä¼šè¿”å›ä¸€ä¸ª Promise ä»¥ä¾¿äºé“¾å¼è°ƒç”¨çš„è¿›è¡Œã€‚

åœ¨ `foo()` çš„è¿”å›çš„ Promise çš„ `then(â€¦)` æ–¹æ³•ä¸­ï¼Œ`fulfilled(â€¦)` è¿”å›çš„ `p` æ²¡æœ‰å†æ¬¡ `defer()`ï¼Œæ‰€ä»¥ä¼šç«‹é©¬å°†é”™è¯¯ä¿¡æ¯ä½œä¸ºä¸€ä¸ª uncaught error æ‰“å°åˆ°æ§åˆ¶å°ä¸Šã€‚

è¿™æ ·çš„è®¾è®¡æ˜¯æˆåŠŸçš„ â€”â€” é”™è¯¯ä¿¡æ¯è¦ä¹ˆè¢«æ•è·å¤„ç†ï¼Œè¦ä¹ˆè¢«æ‰“å°åˆ°æ§åˆ¶å°å‡ºæ¥ â€”â€” è¿™ç¬¦åˆå¤§å¤šæ•°å¼€å‘äººå‘˜çš„é¢„æœŸï¼Œè€Œä¸”ä½ ä¹Ÿèƒ½æ¨è¿Ÿé”™è¯¯çš„å¤„ç†ï¼Œå°±æ¯”å¦‚ `Promise.reject('error msg').defer()`ã€‚

è€Œå”¯ä¸€çš„é£é™©æ¥è‡ª `defer()` â€”â€” å½“ä½ å»¶è¿Ÿäº†é”™è¯¯çš„å¤„ç†åï¼Œä½ å±…ç„¶æœ€ç»ˆå¿˜è®°äº†å¤„ç† â€”â€” ä½ æ€ªè°å‘¢ï¼Ÿ

## Promise æ¨¡å¼(Promise Patterns)
é™¤äº†å¾ˆç†Ÿæ‚‰çš„ Promise é“¾å¼è°ƒç”¨çš„æ¨¡å¼ä¹‹å¤–ï¼Œè¿˜æœ‰å¦å¤–å‡ ç§æ¨¡å¼èƒ½å¤Ÿç®€åŒ–å¼‚æ­¥ç¼–ç¨‹çš„æµç¨‹æ§åˆ¶ã€‚æ¯”å¦‚ï¼Œæœ‰ä¸¤ç§å·²ç»è¢«åŸç”Ÿ Promise æ”¯æŒçš„æ¨¡å¼ï¼Œå¸¸è¢«ç”¨æ¥æ„å»ºå¼‚æ­¥ç¨‹åºã€‚

### Promise.all([â€¦])
åœ¨å¼‚æ­¥é“¾å¼æµä¸­ï¼Œä¸€ä¸ªæ­¥éª¤(step2)ä»»åŠ¡åªèƒ½ç­‰åˆ°ä¹‹å‰çš„æ­¥éª¤(step1)å®Œæˆåï¼Œæ‰èƒ½è¿›è¡Œï¼›è€Œè‹¥æ˜¯æƒ³è¦åŒæ—¶æ‰§è¡Œå¤šä¸ªæ­¥éª¤ä¸­çš„ä»»åŠ¡ï¼Œå³å¹¶å‘(å¹³è¡Œ)å‘¢ï¼Ÿ

åœ¨ç¼–ç¨‹æœ¯è¯­ä¸­ï¼Œ**gate æœºåˆ¶** è¢«ç”¨æ¥å½¢å®¹æŸä¸ªä»»åŠ¡çš„å‰ç½®ä»»åŠ¡æ˜¯æœ‰ä¸¤ä¸ªåŠä»¥ä¸Šçš„ä»»åŠ¡éœ€è¦æ‰§è¡Œï¼Œè‡³äºå®ƒä»¬æœ€ç»ˆå®Œæˆçš„é¡ºåºä¸ç”¨è€ƒè™‘ï¼Œåªéœ€è¦åœ¨å®ƒä»¬å…¨éƒ¨å®Œæˆæ—¶ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚æ­¤æ—¶è‹¥èƒ½åŒæ—¶å¹¶å‘çš„æ‰§è¡Œè¿™äº›å‰ç½®ä»»åŠ¡ï¼Œé‚£å°±èƒ½å¾ˆå¥½çš„æé«˜æ•ˆç‡ã€‚

åœ¨ Promise çš„APIä¸­ï¼Œè¿™ä¸ªæœºåˆ¶å®ç°å°±æ˜¯ `all([â€¦])` æ–¹æ³•ã€‚

æ¯”å¦‚çš„ä½ ä¸šåŠ¡ä»£ç é‡Œæœ‰ä¸‰ä¸ª ajax è¯·æ±‚ï¼Œå…¶ä¸­çš„ä¸€ä¸ªè¯·æ±‚éœ€è¦ç­‰å‰é¢ä¸¤ä¸ªè¯·æ±‚è·å–åˆ°è¿”å›å€¼æ‰èƒ½è¿›è¡Œï¼Œè€Œå¦å¤–ä¸¤ä¸ªè¯·æ±‚æ˜¯ç‹¬ç«‹äº’ä¸å¹²æ‰°çš„ï¼Œè¿™ä¸ªæ—¶å€™æ›´é«˜æ•ˆçš„åšæ³•æ˜¯åŒæ—¶å°†è¿™ä¸¤ä¸ªç‹¬ç«‹çš„è¯·æ±‚å‘é€å‡ºå»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸ªçš„å‘é€ï¼š

```js
const p1 = request('https://some.url.1');
const p2 = request('https://some.url.2');

Promise.all([p1, p2])
  .then(function fulfilled (msgs) {
    return request('https://some.url.3/?v=' + msgs.join(','));
  })
  .then(function (msg) {
    console.info(msg);
  });
```

ğŸ‘† `Promise.all([â€¦])` æ¥å—ä¸€ä¸ªæ•°ç»„å‚æ•°ï¼Œåœ¨å…¶ä¸­çš„æ¯ä¸€é¡¹éƒ½æ˜¯ç”±ä¸€ä¸ª Promise çš„å®ä¾‹æ„æˆï¼Œè€Œå®ƒä»¬ä¸­çš„æ¯ä¸€ä¸ª Promise è¿”å›çš„å€¼éƒ½ä¼šæŒ‰ç…§ä¸€å¼€å§‹åœ¨æ•°ç»„ä¸­çš„é¡ºåºï¼Œè¢«çº³å…¥åˆ°ä¸€ä¸ªæ–°çš„æ•°ç»„ä¸­ï¼Œæœ€ç»ˆä½œä¸º `fulfilled(msgs)` çš„å‚æ•°ã€‚

`Promise.all([â€¦])` çš„æ•°ç»„å‚æ•°å¯ä»¥æ¥å— Promiseã€thenableã€ç”šè‡³æ˜¯ä¸€ä¸ªç›´æ¥å€¼(immediate value)ï¼Œä½†å®ƒä»¬æœ€ç»ˆéƒ½ä¼šè¢«ä¸¢è¿› `Promise.resolve(â€¦)` åŒ…è£¹ä¸€å±‚ï¼Œè¢«æ ‡å‡†åŒ–æˆ Promise å¯¹è±¡ã€‚è€Œè‹¥æ˜¯è¿™ä¸ªæ•°ç»„å‚æ•°æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ï¼Œé‚£ä¹ˆå°±ä¼šç«‹å³å¾—åˆ° fulfill çš„çŠ¶æ€ã€‚

åªå½“æ•°ç»„å‚æ•°ä¸­å…¨éƒ¨çš„ Promise éƒ½ fulfilled æ—¶ï¼Œ`Promise.all([â€¦])` æ‰èƒ½å˜æˆ fulfill çš„çŠ¶æ€ï¼Œå¦åˆ™åªè¦æœ‰ä¸€ä¸ª Promise æ˜¯ rejectedï¼Œé‚£ `Promise.all([â€¦])` å°±ä¼šå˜æˆ reject çš„çŠ¶æ€ã€‚

Promise çš„å¼‚å¸¸æƒ…å†µçš„å¤„ç†ä¸€å®šåˆ«å¿˜è®°ï¼Œç‰¹åˆ«æ˜¯å¯¹äº `Promise.all([â€¦])`ã€‚

### Promise.race([â€¦])
æœ‰æ—¶å€™ï¼Œä½ åªæƒ³æ¥å—ç¬¬ä¸€ä¸ªçŠ¶æ€ç¡®å®š(resolve)çš„ Promiseï¼Œè€Œå…¶ä»–çš„ç»Ÿç»ŸæŠ›å¼ƒï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œç¼–ç¨‹ä¸­çš„æœ¯è¯­å«åš **latch æœºåˆ¶**ã€‚å¯¹åº”çš„ï¼Œåœ¨ Promise ä¸­çš„å®ç°æ˜¯ `race([â€¦])` APIã€‚

**è­¦å‘Š**ï¼šåƒä¸‡åˆ«æŠŠ `Promise.race([â€¦])` å’Œ race condition ææ··æ·†äº†ï¼Œåè€…é€šå¸¸æ˜¯æŒ‡ç¨‹åºçš„ Bugã€‚

`Promise.race([â€¦])` æ¥å—çš„æ•°ç»„å‚æ•°å’Œ `Promise.all([â€¦])` ç›¸åŒã€‚ä½†è‹¥æ˜¯æŸä¸ªå‚æ•°æ˜¯ä¸€ä¸ªéå¼‚æ­¥çš„ç›´æ¥å€¼ï¼Œé‚£å®ƒæ€»ä¼šæ˜¯ç¬¬ä¸€ä¸ªæŠµè¾¾ latch çš„å€¼ â€”â€” è¿™å°±å¥½åƒä¸€åœºè·‘æ­¥æ¯”èµ›ä¸­ï¼Œæœ‰ä¸€ä¸ªé€‰æ‰‹æ˜¯ç›´æ¥ç«™åœ¨ç»ˆç‚¹å‡ºå‘çš„ä¸€æ ·ã€‚

åœ¨ `Promise.race([â€¦])` çš„æ•°ç»„å‚æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªè¢«ç¡®å®šçš„ Promise çš„çŠ¶æ€ï¼Œå°±æ˜¯ `Promise.race([â€¦])` çš„çŠ¶æ€ã€‚è€Œè‹¥æ˜¯å‚æ•°ä¼ å…¥äº†ä¸€ä¸ªç©ºæ•°ç»„ï¼Œè¿™ä¼šå¯¼è‡´ `Promise.race([â€¦])` æ°¸è¿œæ— æ³•è¢« resolve â€”â€” ä¸€ç›´æ˜¯ pending çš„çŠ¶æ€ â€”â€” è¿™ä¸ªé™·é˜±éœ€è¦è­¦æƒ•ã€‚

å°†ä¹‹å‰çš„ä¾‹å­ä¸­çš„ `Promise.all([â€¦])` æ›¿æ¢æˆ `Promise.race([â€¦])`ï¼š

```js
const p1 = request('https://some.url.1');
const p2 = request('https://some.url.2');

Promise.race([p1, p2])
  .then(function fulfilled (msg) {
    return request('https://some.url.3/?v=' + msg);
  })
  .then(function (msg) {
    console.info(msg);
  });
```

ğŸ‘† å› ä¸º `Promise.race([â€¦])` åªæœ‰ä¸€ä¸ªèµ¢å®¶ï¼Œå› æ­¤è¿”å›å€¼è‚¯å®šä¸æ˜¯æ•°ç»„ï¼Œè€Œæ˜¯å•ä¸ªçš„å€¼ã€‚

#### Timeout Race
`Promise.race([â€¦])` å¯ä»¥ç”¨æ¥å®ç° "promise timeout" çš„ç¼–ç¨‹æ¨¡å¼ï¼š

```js
function timeoutPromise (timeout = 1000) {
  return new Promise(function (resolve, reject) {
    setTimeout(function () {
      reject('timeout!');
    }, timeout);
  })
}
Promise.race([
  request('https://some.url.1'),
  timeoutPromise(3000)
])
  .then(
    function () {},
    function (err) {
      console.error(err);
    }
  );
```

ğŸ‘† å®é™…ä¸Šï¼Œç”¨ `Promise.all([â€¦])` æ›¿æ¢ `Promise.race([â€¦])` æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚è™½ç„¶è¿™ä¸ªè¶…æ—¶çš„æ¨¡å¼èƒ½å¤Ÿåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹éƒ½æ­£å¸¸å·¥ä½œï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å¾®å¦™çš„ç»†èŠ‚éœ€è¦è€ƒé‡ã€‚

##### "Finally"
å…³é”®çš„é—®é¢˜æ˜¯ï¼šâ€œåœ¨è¶…æ—¶åï¼Œè¢«æŠ›å¼ƒ/å¿½è§†çš„é‚£äº› Promise è¦æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿâ€ â€”â€” é—®è¿™ä¸ªé—®é¢˜ä¸æ˜¯ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼Œæ¯•ç«Ÿåƒåœ¾å›æ”¶ä¹Ÿä¸æ˜¯åƒç™½é¥­çš„ï¼Œé—®è¿™ä¸ªé—®é¢˜æ˜¯è€ƒè™‘åˆ°è¡Œä¸ºçš„ä¸€è‡´æ€§ï¼Œå°±æ¯”å¦‚æŸäº› Promise æœ‰å¤–éƒ¨çš„å‰¯ä½œç”¨ï¼Œæˆ–è€…å ç”¨äº†æŸäº›èµ„æºï¼Œè€Œè¿™äº› Promise åˆä¸èƒ½è¢«å–æ¶ˆ â€”â€” è¿™æ˜¯ä¹Ÿä¸ºäº†ç¡®ä¿ Promise å¤–éƒ¨ä¸å¯æ›´æ”¹çš„ä¿¡ä»»æœºåˆ¶ â€”â€” å› æ­¤å®ƒä»¬åªèƒ½å®‰é™åœ°è¢«å¿½è§†æ‰ã€‚

`finally(â€¦)` APIå¾ˆå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä¼šåœ¨ Promise çš„çŠ¶æ€ resolve åæ‰§è¡Œï¼Œä½ å¯ä»¥æ‰§è¡Œä¸€äº›æ”¶å°¾çš„å·¥ä½œï¼š

```js
const p = Promise.reject(42);

p
  .then(
    function fulfilled (data) {
      console.info(data);
    }
  )
  .finally(function () {
    // cleanup
  })
  .then(
    function fulfilled (data) {
      console.info('never gets here!');
    },
    function rejected (err) {
      console.error(err);
      return Promise.reject(err)
    }
  );
```

ğŸ‘† `finally(â€¦)` è¿”å›ä¸€ä¸ªçŠ¶æ€ç¡®å®šçš„ Promiseï¼Œå› æ­¤æ— è®ºæ˜¯å“ªä¸ª `fulfilled` æ–¹æ³•ï¼Œéƒ½ä¸ä¼šè§¦å‘ã€‚

åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°ä¸€ä¸ªé™æ€æ–¹æ³• `Promise.observe(â€¦)`ï¼Œç”¨æ¥è§‚å¯Ÿ Promise çš„çŠ¶æ€ï¼š

```js
if (!Promise.observe) {
	Promise.observe = function (pr, cb) {
		pr.then(
			function fulfilled (msg) {
				Promise.resolve(msg).then(cb);
			},
			function rejected (err) {
				Promise.resolve(err).then(cb);
			}
		);
		return pr;
	};
}
```

`Promise.observe(â€¦)` + è¶…æ—¶æ¨¡å¼ï¼š

```js
Promise.race([
  Promise.observe(
    request('https://some.url.1'),
    function cleanup (msg) {
      // cleanup
    }
  ),
  timeoutPromise(3000)
]);
```

å› ä¸º `Promise.observe(â€¦)` å¯ä»¥ç”¨æ¥æ— å¹²æ¶‰åœ°è§‚å¯Ÿ Promise çš„çŠ¶æ€ï¼Œå› æ­¤èƒ½å¤Ÿç›‘æ§é‚£äº›ç”±äºè¶…æ—¶è€Œè¢«æŠ›å¼ƒçš„ Promiseã€‚

### all([â€¦]) å’Œ race([â€¦]) çš„å˜ä½“(Variations on all([â€¦]) and race([â€¦]))
åŸºäº `Promise.all([â€¦])` å’Œ `Promise.race([â€¦])` çš„æ€æƒ³ï¼Œå‡ºç°äº†å‡ ä¸ªå¸¸è§å˜ä½“ï¼š

- `none([â€¦])` å’Œ `all([â€¦])` å¾ˆç›¸ä¼¼ï¼Œè€ŒåŒºåˆ«åœ¨äºå‰è€…å°† fulfilled å’Œ rejected çš„çŠ¶æ€é¢ å€’äº† â€”â€” åªæœ‰å½“å‚æ•°ä¸­çš„å…¨éƒ¨ Promise éƒ½æ˜¯ rejected æ—¶ï¼Œ`none([â€¦])` æ‰èƒ½æ˜¯ fulfill çš„çŠ¶æ€ï¼›

- `any([â€¦])` å’Œ `all([â€¦])` ä¹Ÿå¾ˆç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒå¿½ç•¥æ‰€æœ‰çš„ rejectedï¼Œåªè¦æœ‰ä¸€ä¸ª fulfilled å³å¯ï¼›

- `first([â€¦])` å’Œ `race([â€¦])` å¾ˆç›¸ä¼¼ï¼Œå®ƒä¼šå¿½ç•¥æ‰€æœ‰çš„ rejectedï¼ŒåŒæ—¶åªæ¥å—ç¬¬ä¸€ä¸ª fulfilledï¼›

- `last([â€¦])` å’Œ `first([â€¦])` åŸºæœ¬ä¸€æ ·ï¼ŒåŒºåˆ«æ˜¯åªæœ‰æœ€åä¸€ä¸ª fulfilled æ‰æ˜¯èµ¢å®¶ï¼›

æ¯”å¦‚å®ç° `Promise.first([â€¦])`ï¼š

```js
if (!Promise.first) {
	Promise.first = function (prs) {
		return new Promise(function (resolve,reject) {
			// loop through all promises
			prs.forEach(function(pr){
				// normalize the value
				Promise.resolve(pr)
				  .then(resolve);
			});
		});
	};
}
```

ğŸ‘†ä¸Šé¢å®ç°çš„ `Promise.race([â€¦])` å’Œ `Promise.race([â€¦])` ç›¸æ¯”ï¼Œå…¶ä¸ä¼šå‡ºç° reject çš„çŠ¶æ€ï¼Œè€Œè‹¥æ˜¯ä½ éœ€è¦å¤„ç†è¿™æ ·çš„æƒ…å†µï¼Œå®Œå…¨å¯ä»¥è‡ªå·±æ‰‹åŠ¨æ·»åŠ ç›¸åº”çš„å¤„ç†é€»è¾‘ã€‚

### å¹¶å‘è¿­ä»£(Concurrent Iterations)
é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿­ä»£ä¸€ä¸ªå…¨éƒ¨ç”±åŒæ­¥ä»»åŠ¡æ„æˆçš„ Promise ç»„æˆçš„åˆ—è¡¨ï¼Œæ²¡å•¥é—®é¢˜ï¼Œå°±å¥½åƒä½¿ç”¨æ•°ç»„ä¸­çš„å„ç§æ–¹æ³•(`forEach(â€¦)`ã€`map(â€¦)`ã€`every(â€¦)`ã€`some(â€¦)`ã€`reduce(â€¦)`â€¦â€¦)ï¼Œä½†è‹¥æ˜¯è¦å¤„ç†ä¸€ç»„å¼‚æ­¥ä»»åŠ¡ï¼Œä¸”å¹¶å‘æ‰§è¡Œçš„æƒ…å†µï¼Œè¦ä¹ˆä½ é€‰ç”¨ç¬¬ä¸‰æ–¹çš„å·¥å…·ï¼Œè¦ä¹ˆè‡ªå·±æ”¹é€ ä¸€ä¸‹ `Promise.all(â€¦)`ï¼š

æ¯”å¦‚ä½œè€…æä¾›äº†ä¸€ä¸ªæŒ‚è½½Promiseå¯¹è±¡ä¸‹çš„ `map(â€¦)` æ–¹æ³•ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªç”±å¼‚æ­¥ä»»åŠ¡ç»„æˆçš„æ•°ç»„ï¼Œå¦ä¸€ä¸ªæ˜¯ä¼šæ¯æ¬¡è¿­ä»£éƒ½è¢«æ‰§è¡Œçš„å›è°ƒï¼Œæœ€ç»ˆè¿”å›ä¸€ä¸ªçŠ¶æ€ç¡®å®š(fullfiled)çš„æ•°ç»„ï¼š

```js
if (!Promise.map) {
  Promise.map = function (vals, cb) {
    return Promise.all(
      vals.map(function (val) {
        return new Promise(function (resolve) {
          cb(val, resolve);
        })
      })
    );
  }
}
```

è™½ç„¶ä½ æ— æ³•é‡‡ç”¨ä¼˜é›…çš„æ–¹å¼æŠ›å‡ºå¼‚å¸¸(å› ä¸ºåªä¼ å…¥äº† resolve ä½œä¸ºå›è°ƒå‡½æ•°çš„å‚æ•°)ï¼Œä½†è‹¥æ˜¯åœ¨å›è°ƒå‡½æ•°ä¸­å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆæ•´ä¸ª `Promise.map(â€¦)` ä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€ä¸º rejected çš„ promiseã€‚

å›å¤´çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ï¼š

```js
var p1 = Promise.resolve(21);
var p2 = Promise.resolve(42);
var p3 = Promise.reject('err msg');

Promise.map([p1, p2, p3], function (val, done) {
  Promise.resolve(val)
    .then(
      function (v) { done(v * 2); },
      done
    );
})
  .then(function (vals) {
    console.info(vals); //Â [42, 84, "err msg"]
  });
```

å¦å¤–ï¼Œåœ¨å¹¶å‘æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ä¸­ï¼Œé™¤äº† `Promise.all([â€¦])` ä¹‹å¤–ï¼Œä¹Ÿèƒ½ä½¿ç”¨ `async` + `forâ€¦of` å‡½æ•°å®ç°(æœ‰ç‚¹è¶…çº²ï¼Œä¸è¿‡åé¢ä¹Ÿä¼šè®²åˆ°)ï¼š

```js
async function doConcurrent (vals, cb) {
  const results = [];
  const promises = vals.map(val => new Promise((resolve) => cb(val, resolve)));

  for (let promise of promises) {
    try {
      results.push(await promise);
    } catch (e) {
      results.push(e);
    }
  }
  return results;
}
```

```js
doConcurrent([p1, p2, p3], function (val, done) {
  Promise.resolve(val)
    .then(
      function (v) { done(v * 2); },
      done
    );
})
  .then(function (vals) {
    console.info(vals); //Â [42, 84, "err msg"]
  })
```

## å…³äº Promise API çš„é‡è¦æ¦‚è¿°(Promise API Recap)
è¿™ä¸€èŠ‚ä¸»è¦æ˜¯å›é¡¾ä¸€ä¸‹ä¹‹å‰å·²ç»æåˆ°çš„ä¸€äº› Promise APIã€‚

æ­¤å¤„ä½œè€…ä¹ŸæåŠäº†å…³äºä»–å†™çš„ä¸€ä¸ª [ã€Šnative-promise-onlyã€‹](http://github.com/getify/native-promise-only) åº“çš„ä»‹ç»ï¼Œä¸»è¦ä½œç”¨æ˜¯åšåŸç”Ÿ Promise çš„ polyfillã€‚åœ¨å…¶ä¹¦å†™æ—¶å€™ï¼ŒES6æ‰åˆšå‘å¸ƒä¸ä¹…ï¼Œå¾ˆå¤šæµè§ˆå™¨å¹¶æ²¡æœ‰å®ç°è¿™å¥—è§„èŒƒï¼Œå› æ­¤è¿™ä¸ªåº“æ˜¾å¾—ååˆ†é‡è¦ä¸”å¿…è¦ï¼Œä½†æ˜¯æ—¶è‡³ä»Šæ—¥ï¼ŒPromise çš„å®ç°æ—©ä¸æ˜¯é—®é¢˜ï¼Œå› æ­¤å…¶å®ç”¨æ€§æœ‰æ‰€ä¸‹é™ï¼Œä½†ä¸€å®šä¹Ÿä¸å¦¨ç¢æˆ‘ä»¬å­¦ä¹ ä»–èƒŒåçš„æ€æƒ³å’Œ code çš„æ‰‹æ³•ï¼Œè¿™ä¸ªæ‰æ˜¯ç²¾åã€‚

### new Promise(â€¦) Constructor
æ„é€ ä¸€ä¸ª Promise çš„å®ä¾‹ï¼Œå…³é”®å­—ä¾ç„¶æ˜¯ `new`ï¼ŒåŒæ—¶ä½œä¸ºç¬¬ä¸€ä¸ªå¿…å¡«çš„å‚æ•°(å›è°ƒå‡½æ•°)ï¼Œå®ƒä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œå¹¶æ¥å—ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œä½œä¸ºç¡®å®šè¯¥ promise å®ä¾‹çš„çŠ¶æ€ï¼Œé€šå¸¸æˆ‘ä»¬ç§°å…¶ä¸º `resolve(â€¦)` å’Œ `reject(â€¦)`ï¼š

```js
var p = new Promise(function (resolve, reject) {
  // resolve(â€¦) -> fulfilled or rejected
  // reject(â€¦) -> rejected
});
```

`reject(â€¦)` æ²¡å•¥å¥½è¯´çš„ï¼Œå°±æ˜¯æŠŠ Promise çš„çŠ¶æ€ç¡®å®šä¸º rejectedï¼›è€Œ `resolve(â€¦)` åˆ™å¯èƒ½æ˜¯ fulfilled çš„çŠ¶æ€æˆ– rejected çš„çŠ¶æ€ï¼Œè¿™å–å†³äºä¼ è¿›å»çš„å‚æ•°æ˜¯ä»€ä¹ˆï¼š
  - è‹¥ä¼ é€’çš„æ˜¯ é Promiseã€é thenable çš„å€¼ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯ fulfilled çš„çŠ¶æ€ï¼›

  - è‹¥ä¼ é€’çš„æ˜¯ Promise æˆ– thenable çš„å€¼ï¼Œé‚£ä¹ˆå°±ä¼šä¸€ç›´é€’å½’å»è§£æï¼Œåˆ°æœ€åè¢«ç¡®å®šçš„çŠ¶æ€æ‰æ˜¯ `resolve(â€¦)` çš„çŠ¶æ€(å¯èƒ½æ˜¯ fulfilled ä¹Ÿå¯èƒ½æ˜¯ rejected)ï¼›

### Promise.resolve(â€¦) å’Œ Promise.reject(â€¦)
`Promise.reject(â€¦)` æ˜¯åˆ›å»º rejected çŠ¶æ€çš„ Promise çš„ä¸€ä¸ªç®€å†™ï¼Œæ¯”å¦‚ä¸‹é¢ğŸ‘‡çš„ä¸¤ä¸ªå½¢å¼å…¶å®æ˜¯ç­‰ä»·çš„ï¼š

```js
var p1 = new Promise(function (resolve, reject) {
  reject('err msg');
});

var p2 = Promise.reject('err msg');
```

è€Œ `Promise.resolve(â€¦)` çš„çŠ¶æ€ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼Œä¼šæ ¹æ®ä¼ å…¥çš„å‚æ•°è€Œå†³å®šï¼Œå¹¶ä¸”è‹¥æ˜¯ä¼ å…¥ä¸€ä¸ª Promise çš„è¯ï¼Œå®ƒä¼šè¿”å›è¿™ä¸ª Promiseï¼Œå› æ­¤å½“ä½ ä¸ç¡®å®šå€¼çš„â€œç±»å‹â€æ—¶ï¼Œ`Promise.resolve(â€¦)` æ˜¯ä¸€ä¸ªæ²¡æœ‰è´Ÿæ‹…çš„é€‰æ‹©ï¼š

```js
var fulfilledTh = {
	then: function(cb) { cb(42); }
};
var rejectedTh = {
	then: function(cb, errCb) {
		errCb('err msg');
	}
};

var p1 = Promise.resolve(fulfilledTh);
var p2 = Promise.resolve(rejectedTh);
```

### then(â€¦) å’Œ catch(â€¦)
æ¯ä¸ª Promise çš„å®ä¾‹éƒ½æœ‰ `then(â€¦)` å’Œ `catch(â€¦)` æ–¹æ³•ï¼Œå®ƒä»¬ç”¨æ¥æ¥æ”¶å¤„ç† fulfilled æˆ– rejected çŠ¶æ€çš„å›è°ƒå‡½æ•° â€”â€” å½“ç„¶è¿™éƒ½æ˜¯å¼‚æ­¥çš„ã€‚

`then(â€¦)` æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç”¨æ¥å¤„ç† fulfillment çš„å›è°ƒï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯å¤„ç† rejected çš„å›è°ƒï¼Œè‹¥æ˜¯å…¶ä¸­æœ‰ä¸€ä¸ªè¢«çœç•¥æ‰(æˆ–ä¼ å…¥çš„æ˜¯éå‡½æ•°ç±»å‹çš„å€¼)ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„å›è°ƒå‡½æ•°æ¥å–ä»£æ¯”å¦‚ `data => data` æˆ– `function (e) { return e; }`ã€‚


`catch(â€¦)` æ–¹æ³•åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ŒåŒæ ·çš„ä¹Ÿä¼šæœ‰é»˜è®¤å‚æ•°ï¼Œæ¢å¥è¯è®²ï¼Œå®ƒå…¶å®å°±ç›¸å½“äº `then(null, â€¦)`ï¼š

```js
p.then(fulfilled);

p.then(fulfilled, rejected);

p.catch(rejected); // ç­‰äº p.then(null, rejected);
```

`then(â€¦)` å’Œ `catch(â€¦)` éƒ½ä¼šåˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œè€Œè¿™ä¹Ÿæ˜¯é“¾å¼å›è°ƒçš„åŸºç¡€ã€‚

å¦‚æœä¼ å…¥å®ƒä»¬çš„å›è°ƒå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¹ˆè¿”å›çš„ Promise çš„çŠ¶æ€æ˜¯ rejectedï¼›å¦‚æœä¼ å…¥å®ƒä»¬çš„å›è°ƒè¿”å›é Promise å’Œ é thenable çš„å€¼ï¼Œé‚£ä¹ˆè¿”å›çš„ Promise çš„çŠ¶æ€æ˜¯ fulfilledï¼›è€Œè‹¥æ˜¯ä¼ å…¥å®ƒä»¬çš„å›è°ƒè¿”å›äº†ä¸€ä¸ª Promise æˆ– thanble çš„å€¼ï¼Œé‚£ä¼šé€’å½’è§£æï¼Œç›´åˆ°æœ€ç»ˆçš„çŠ¶æ€è¢«ç¡®å®šã€‚

### Promise.all([â€¦]) å’Œ Promise.race([â€¦])
åŒºåˆ«

`Promise.all([â€¦])` å’Œ `Promise.race([â€¦])` ä¸¤ä¸ªé™æ€æ–¹æ³•éƒ½ä¼šåˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œè€Œè¿™ä¸ª Promise çš„çŠ¶æ€åˆ™å–å†³äºä¼ å…¥çš„æ•°ç»„å‚æ•°ï¼š

å¯¹ `Promise.all([â€¦])` è€Œè¨€ï¼Œåªæœ‰å½“ä½ ä¼ å…¥çš„æ•°ç»„ä¸­çš„æ‰€æœ‰ Promise çš„çŠ¶æ€éƒ½ç¡®å®šä¸º fulfilledï¼Œé‚£ä¹ˆè¿”å›çš„ Promise æ‰æ˜¯ fulfilledï¼›è€Œå“ªæ€•åªæœ‰ä¸€ä¸ªçš„çŠ¶æ€ç¡®å®šä¸º rejectedï¼Œé‚£è¿”å›çš„ Promise çš„çŠ¶æ€éƒ½è¢«å®šä¹‰ä¸º rejected â€”â€” è¿™ç§æ¨¡å¼è¢«ç§°ä¸º gate â€”â€” æ‰€æœ‰äººéƒ½å¿…é¡»åœ¨å¤§é—¨å¼€å¯å‰åˆ°è¾¾ã€‚

è€Œ `Promise.race([â€¦])` åˆ™æ˜¯åªæœ‰ç¬¬ä¸€ä¸ªç¡®å®šçš„ Promise çš„çŠ¶æ€ä¼šä½œä¸ºè¿”å›çš„ Promise çš„çŠ¶æ€ â€”â€” è¿™æ ·çš„æ¨¡å¼è¢«ç§°ä¸º latch â€”â€” åªæœ‰ç¬¬ä¸€ä¸ªæŠµè¾¾é—¨é—©çš„äººæ‰èƒ½å¤Ÿè¿›å…¥ã€‚

```js
const pArr = [
  Promise.resolve(42),
  Promise.resolve('Hello World'),
  Promise.reject('err msg')
];

Promise.race(pArr)
  .then(function(msg){
    console.log(msg);		// 42
  });

Promise.all(pArr)
  .catch(function(err){
    console.error(err);	// "err msg"
  });

Promise.all(pArr.slice(0, 2))
  .then(function(msgs){
    console.log(msgs);	// [42, "Hello World"]
  });
```

**Warning**ï¼šè‹¥æ˜¯ä¼ å…¥ä¸€ä¸ªç©ºæ•°ç»„ä½œä¸ºå‚æ•°æ—¶ï¼Œ`Promise.all([â€¦])` å’Œ `Promise.race([â€¦])` è¡¨ç°çš„è¡Œä¸ºæœ‰å·®å¼‚ï¼šå‰è€…ä¼šç›´æ¥è¿”å›ä¸€ä¸ª fulfilled çŠ¶æ€çš„ Promiseï¼Œè€Œåè€…åˆ™ä¼šæ°¸è¿œçš„ pending åœ¨é‚£é‡Œï¼

åŸç”Ÿçš„ Promise ä½œä¸ºä¸€ä¸ªä»å›è°ƒåœ°ç‹±è¿‡åº¦åˆ°æ–°ç‰ˆçš„ JS å¼‚æ­¥ç¼–ç¨‹çš„è‰¯å¥½å¼€ç«¯æ˜¯ååˆ†é è°±çš„ï¼Œä½†å®ƒä¾ç„¶åœ¨æŸäº›æƒ…å†µä¸‹ä¸èƒ½å¤Ÿå¾ˆå¥½çš„å®Œå…¨æ»¡è¶³å¼‚æ­¥ç¼–ç¨‹çš„éœ€æ±‚ï¼Œè¿™ä¹Ÿä¸ºä¸€äº›åŸºäº Promise æ€æƒ³çš„åº“æä¾›çš„é©±åŠ¨åŠ›ã€‚

## Promise çš„é™åˆ¶(Promise Limitations)
è™½ç„¶ä¹‹å‰çš„å†…å®¹ä¸­å·²ç»æ¶µç›–äº†è¿™éƒ¨åˆ†çš„ä¸€äº›å†…å®¹ï¼Œä½†æ˜¯ä¾ç„¶å¾ˆæœ‰å¿…è¦å•ç‹¬çš„å°†å…¶ç½—åˆ—å‡ºæ¥ã€‚

### å¼‚å¸¸å¤„ç†çš„é¡ºåº(Sequence Error Handling)
Promise çš„é“¾å¼è°ƒç”¨ä»…ä»…æ˜¯å°†ä¸€å † Promise ç»„åˆèµ·æ¥çš„ä¸€ç§å½¢å¼ï¼Œå› æ­¤ä½ æ²¡åŠæ³•ä»…é€šè¿‡ä¸€ä¸ªå®ä½“ï¼Œå°±èƒ½å»ºç«‹å¯¹ Promise é“¾çš„å…¨éƒ¨å¼•ç”¨ï¼›è€Œè¿™ä¹Ÿä¹Ÿæ„å‘³ç€è¯´ï¼Œæ²¡æœ‰å…¶ä»–çš„åŠæ³•èƒ½å¤Ÿç›‘æ§åˆ°å¼‚å¸¸çš„å‘ç”Ÿã€‚

ä¸€æ—¦ Promise é“¾ä¸­æœ‰é”™è¯¯å‘ç”Ÿï¼Œå®ƒå°±ä¼šæ— é™çš„å‘ä¸‹ä¼ æ’­ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªæ³¨å†Œçš„å¼‚å¸¸å¤„ç†æ–¹æ³• â€”â€” åœ¨è¿™ç§æ¨¡å¼ä¸‹

```js
const p = foo(42)
  .then(STEP2)
  .then(STEP3);
```

`p` çš„æŒ‡å‘çš„ Promise å¹¶ä¸æ˜¯ç¬¬ä¸€ä¸ª `foo(42)`ï¼Œè€Œæ˜¯æœ€åä¸€ä¸ªï¼Œå³ `then(STEP3)` çš„è¿”å›å€¼ï¼Œé‚£å³æ„å‘³ç€ä½ å¯ä»¥è‡ªè¡Œæ³¨å†Œä¸€ä¸ªå¼‚å¸¸å¤„ç†çš„æ–¹æ³•ï¼š

```js
p.catch(handleErrors);
```

é€šå¸¸æƒ…å†µä¸‹ğŸ‘†éƒ½èƒ½å¾ˆå¥½çš„å¤„ç†å¼‚å¸¸çš„é—®é¢˜ï¼Œä¸è¿‡ï¼Œè‹¥æ˜¯åœ¨ä¹‹å‰çš„å…¶ä»–æ­¥éª¤æ³¨å†Œäº†å¼‚å¸¸å¤„ç†çš„æ–¹æ³•ï¼Œè¿™å°±ç¼ºå¤±äº†ä¸€ä¸ªé€šçŸ¥ `handleErrors` æœ‰å¼‚å¸¸å·²ç»è¢«å¤„ç†çš„æœºåˆ¶ã€‚

ä½†è¿™ä¹Ÿä¸æ˜¯åªæ­¤ä¸€å®¶ â€”â€” `tryâ€¦catch` åŒæ ·ä¹Ÿæœ‰ç±»ä¼¼çš„é—®é¢˜ï¼Œ`catch` ä¼šå°†å¼‚å¸¸æƒ…å†µåæ‰è€Œæ²¡æœ‰ä»»ä½•å½¢å¼çš„é€šçŸ¥ã€‚

ç”±äºä¸èƒ½å¯¹ä¸­é—´æ­¥éª¤çš„ Promise ä¿ç•™å¼•ç”¨ï¼Œå› æ­¤ä¹Ÿæ²¡åŠæ³•å†™å‡ºä¸€ä¸ªèƒ½å¤Ÿå…¨é¢è¦†ç›– Promise å¼‚å¸¸æƒ…å†µçš„å¤„ç†å‡½æ•°ã€‚

### å•ä¸€çš„å€¼(Single Value)
æ ¹æ®å®šä¹‰ï¼ŒPromise åªèƒ½æœ‰ä¸€ä¸ªå•ä¸€çš„ fulfillment æˆ– rejection çš„å€¼ã€‚é€šå¸¸çš„è§£å†³åŠæ³•æ˜¯å°†å¤šä¸ªå€¼åŒ…è£¹åœ¨ä¸€ä¸ªå¯¹è±¡æˆ–æ•°ç»„ä¸­ï¼Œè€Œåå†è§£æå‡ºæ¥ â€”â€” ä¸ä»…å¾ˆå°´å°¬ï¼Œè€Œä¸”å¾ˆå†—ä½™ã€‚

#### å€¼çš„åˆ†å‰²(Splitting Values)
æœ‰æ—¶å€™è¿™ä¹Ÿæ˜¯ä¸€ä¸ªè®©ä½ å°†é—®é¢˜åˆ†è§£æˆå¤šä¸ª Promise æ¥å¤„ç†çš„ä¿¡å·ï¼Œå°±æ¯”å¦‚ä½ æœ‰ä¸€ä¸ªå¼‚æ­¥è¿”å›ä¸¤ä¸ªå€¼çš„ `foo(â€¦)` æ–¹æ³•ï¼š

```js
function getY(x) {
	return new Promise(function (resolve, reject){
		setTimeout(function (){
			resolve((3 * x) - 1);
		}, 100);
	});
}

function foo(bar,baz) {
	const x = bar * baz;

	return getY(x)
    .then(function (y){
      return [ x,y ];
    });
}

foo(10, 20)
  .then(function (msgs){
    const x = msgs[0];
    const y = msgs[1];

    console.log(x, y);  // 200 599
  });
```

å€ŸåŠ© `Promise.all([â€¦])` æˆ‘ä»¬å°†ğŸ‘†

```js
function foo(bar,baz) {
	const x = bar * baz;

	return [
		Promise.resolve(x),
		getY(x)
	];
}

Promise.all(
	foo( 10, 20 )
)
  .then(function (msgs){
    const x = msgs[0];
    const y = msgs[1];

    console.log(x, y);
  });
```

ä½†ç”± Promise ç»„æˆçš„æ•°ç»„å°±ä¸€å®šä¼˜äºå°†ä¸€ç»„å€¼ä½œä¸ºæ•°ç»„åœ¨ä¸€ä¸ª Promise ä¸­è¿”å›å—ï¼Ÿå°±è¯­æ³•è€Œè¨€ï¼Œå¥½åƒå¹¶æ²¡æœ‰ï¼

ä½†è¿™æ ·çš„æ–¹å¼å’Œ Promise çš„å®é™…æ€è·¯çš„ç¡®æ›´ä¸ºè´´åˆ‡ï¼Œä¹Ÿæ›´å®¹æ˜“ç»„ç»‡å’Œç®¡ç†ä»£ç ã€‚ä¸è¿‡æ˜¾ç„¶è§£å†³çš„åŠæ³•ä¸æ­¢ä¸€ç§ã€‚

#### å‚æ•°çš„æ‰©å±•è¿ç®—(Unwrap/Spread Arguments)
æœ‰æ²¡æœ‰æ›´è®¨å·§çš„æ–¹å¼å‘¢ï¼Ÿç¤¾åŒºä¸­çš„å¤§ç¥éšæ‰‹ä¸€æŒ¥ â€”â€” `apply`ï¼š

```js
function spread(fn) {
	return Function.apply.bind(fn, null);
}

Promise.all(
	foo(10, 20)
)
  .then(
    spread(function (x, y){
      console.log(x, y);
    })
  );
```

ES6 æ˜¾ç„¶ä¹Ÿæä¾›äº†å¦ä¸€ç§ä¼˜é›…çš„æ–¹å¼ï¼š

```js
Promise.all(
	foo(10, 20)
)
  .then(
    function (data) {
      const [x, y] = data;
      console.log(x, y);
    }
  );
```

ä½†æœ€å¥½çš„è«è¿‡äº ES6 æä¾›çš„å¯¹äºå‡½æ•°å‚æ•°çš„æ•°ç»„è§£æ„äº†ï¼š

```js
Promise.all(
	foo(10, 20)
)
  .then(
    function ([x, y]) {
      console.log(x, y);
    }
  );
```

`one-value-per-Promise` çš„ç‰¹æ€§çš„ç¡®æ¶å¿ƒï¼Œä¸è¿‡å¥½åœ¨ä¹Ÿæœ‰è§£å†³æ–¹æ¡ˆã€‚

### æ²¡æœ‰å›å¤´è·¯(Single Resolution)
ä¼—æ‰€å‘¨çŸ¥ï¼ŒPromise çš„çŠ¶æ€ä¸€æ—¦ç¡®å®šï¼Œå°±æ²¡åŠæ³•æ›´å˜ï¼Œè¦ä¹ˆ fulfillmentï¼Œè¦ä¹ˆ rejection â€”â€” å¤§å¤šæ•°çš„æƒ…å†µè¿™æ˜¯å¥½äº‹ï¼Œä½†ä¾ç„¶æœ‰å±€é™ï¼Œå°±æ¯”å¦‚ Promise æ— æ³•é€‚åº”å¤„ç†äº‹ä»¶æˆ–è€…æµçš„è¿™ç§éœ€è¦å¤šæ¬¡è§£æçš„æƒ…å†µï¼Œå¦‚æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼š

```js
const p = new Promise(function (resolve,reject){
  // `click(â€¦)` ç»‘å®šäº† DOM ä¸Šçš„ click äº‹ä»¶
	click('#btn', resolve);
});

p
  .then(function (evt){
    const btnID = evt.currentTarget.id;
    return request('http://some.url.1/?id=' + btnID);
  })
  .then(function (text){
    console.log(text);
  });
```

ğŸ‘†è¿™æ ·çš„äº‹ä»¶å¤„ç†åªç”¨ä½¿ç”¨ä¸€æ¬¡ï¼Œå› ä¸ºä¸‹æ¬¡åœ¨ç‚¹å‡»äº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼Œ`p` çš„çŠ¶æ€æ—©å·²ç»è¢«ç¡®å®šäº†ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ å¯èƒ½è¦è½¬åŒ–ä¸€ä¸‹èŒƒå¼ â€”â€” æ¯æ¬¡äº‹ä»¶è¢«è§¦å‘çš„æ—¶å€™éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„ Promise é“¾ï¼š

```js
click('#btn', function(evt) {
	const btnID = evt.currentTarget.id;

	requestrequest('http://some.url.1/?id=' + btnID)
    .then(function (text){
      console.log(text);
    });
});
```

ğŸ‘†å…ˆä¸ç®¡è¿™æ ·å†™çš„ä»£ç æœ‰å¤šä¸‘ï¼Œè¿™æ ·çš„ä»£ç è¿åäº† èŒè´£ä»»åˆ†ç¦»(separation of concerns/capabilities SoC) çš„åŸåˆ™ â€”â€” å°±æ¯”å¦‚ä½ æƒ³æŠŠäº‹ä»¶æ³¨å†Œå’Œäº‹ä»¶å¤„ç†çš„ä»£ç é€»è¾‘åˆ†å¼€ï¼Œè€Œè¿™æ ·çš„æ¨¡å¼åœ¨æ²¡æœ‰å…¶ä»– helper æ–¹æ³•çš„å¸®åŠ©ä¸‹ï¼Œæ˜¾ç„¶æ²¡åŠæ³•åšåˆ°ã€‚

**æ³¨æ„**ï¼šç¤¾åŒºä¸­ä¹Ÿæœ‰å¾ˆå¤šå¯¹è¿™æ ·çš„é™åˆ¶çš„è§£å†³æ–¹æ¡ˆï¼Œå°±æ¯”å¦‚ [RxJS](https://archive.codeplex.com/?p=rxjs)ã€‚ä½†é—®é¢˜åœ¨äºè¿™ç§è§£å†³æ–¹æ¡ˆä¸€ä¸ªæ˜¯å¤ªé‡äº†ï¼Œå¦ä¸€ä¸ªæ˜¯è¿™æ ·çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å¦éµå¾ªäº† Promise çš„ *trustable* åŸåˆ™è¿˜æœªå¯çŸ¥ã€‚

### æƒ¯æ€§(Inertia)
**A code base in motion (with callbacks) will remain in motion (with callbacks) unless acted upon by a smart, Promises-aware developer.** â€”â€” **æƒ³è¦æ‰“ç ´ç°çŠ¶æ€»æ˜¯å¾ˆéš¾çš„**

Promise ä¸æ˜¯ä¸€ä¸ªä¸€åˆ€åˆ‡(one-size-fits-all)çš„æ–¹æ¡ˆï¼Œæƒ³è¦å°†åŸæ¥çš„å¼‚æ­¥å›è°ƒå‡½æ•°çš„ä»£ç å…¨éƒ¨é‡æ„æˆ Promise çš„ä»£ç ï¼Œæ˜¾ç„¶å·¥ä½œé‡å¾ˆå¤§ï¼Œè€Œä¸”è¿˜å®¹æ˜“å‡ºå¹ºè›¾å­ã€‚

ä½†è¿™å¹¶ä¸æ„å‘³ç€å°±ä¸ç”¨ Promise äº†ï¼Œç›¸åï¼Œç¤¾åŒºä¸­æœ‰å¾ˆå¤šå¼€æºçš„é¡¹ç›®èƒ½å¤Ÿæ”¯æŒå°†ä»£ç  PromiseåŒ–(Promisory)

### ä¸å¯å–æ¶ˆçš„ Promise(Promise Uncancelable)
ä¸€æ—¦ä½ åˆ›å»ºäº†ä¸€ä¸ª Promiseï¼Œå¹¶ä¸”æ³¨å†Œäº†å¤„ç†æ–¹æ³•åœ¨å…¶ä¸­ï¼Œå°±æ²¡åŠæ³•å–æ¶ˆäº†ã€‚

**æ³¨æ„**ï¼šæœ‰å¾ˆå¤šçš„ç¬¬ä¸‰æ–¹åº“æä¾›äº†å–æ¶ˆ Promise çš„å·¥å…·ï¼Œç”šè‡³æœ‰çš„å¼€å‘è€…å¸Œæœ›åŸç”Ÿæ”¯æŒå–æ¶ˆ Promiseï¼Œä½†è¿™å…¶å®æ˜¯å¼Šå¤§äºåˆ©çš„ â€”â€” ä¸€æ—¦ä½ èƒ½å¤Ÿå½±å“åˆ° Promise çš„ç»“æœï¼Œé‚£ä¹ˆå®ƒå°±ä¸åœ¨æ˜¯ trustable äº†ï¼Œé‚£å°±ç­‰äºåˆå›åˆ°äº†è¿‡å»çš„å›è°ƒå‡½æ•°çš„å™©æ¢¦ä¸­å»äº†ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œè¦å®ç° Promise çš„ cancel åŠŸèƒ½ï¼Œåªèƒ½é€šè¿‡åœ¨æ›´é«˜çš„æŠ½è±¡å±‚æ¬¡æ¥è§£å†³ï¼š

```js
let OK = true;

const p = foo(42);

Promise.race([
	p,
	timeoutPromise(3000)
    .catch( function(err){
      OK = false;
      throw err;
    })
])
  .then(
    doSomething,
    handleError
  );

p
  .then( function(){
    if (OK) {
      // åªæœ‰æœªè¶…æ—¶æ‰ä¼šè§¦å‘
    }
  });
```

### Promise çš„æ€§èƒ½(Promise Performance)
Promise è‚¯å®šä¼šæ¯”ç›¸åŒä»£ç çš„ å›è°ƒå‡½æ•° æ…¢ä¸€ä¸¢ä¸¢ â€”â€” åŠ äº†ä¸€å±‚ä¸­é—´å±‚ä¸æ…¢æ€ä¹ˆå¯èƒ½ã€‚ä½†è¿™æ ·çš„æ€§èƒ½æ¯”è¾ƒçœŸçš„æ²¡å¤ªå¤šæ„æ€ï¼Œæœ€èµ·ç ä½ ä¹Ÿåº”è¯¥ç”¨ å¸¦æœ‰å¤„ç†ä¿¡ä»»é—®é¢˜çš„å›è°ƒå‡½æ•° å’Œ Promise æ¯”è¾ƒæ‰æœ‰æ„ä¹‰ä¸æ˜¯ä¹ˆï¼Ÿ

è€Œé—®é¢˜çš„æ ¸å¿ƒä¸åœ¨äºæ¯”è¾ƒæ€§èƒ½çš„ä¼˜åŠ£ï¼Œè€Œåœ¨äºè‹¥æ˜¯ä½ çœŸçš„å·®é‚£ä¹ˆä¸€ä¸¢ä¸¢çš„æ€§èƒ½æ‰èƒ½è§£å†³é—®é¢˜çš„è¯ï¼Œé‚£ä½ ä¸ºä½•ä¸ç”¨æ•ˆç‡æ›´é«˜çš„è¯­è¨€(æ¯”å¦‚ `C++`)æ¥ä»£æ›¿JSï¼Œä»è€Œå®ç°ä½ çš„éœ€æ±‚å‘¢ï¼Ÿ

å†µä¸”ï¼Œå°±ç®—æ˜¯æ…¢äº†ä¸€äº›ï¼Œä½† Promise å¸¦æ¥çš„ä¼˜åŠ¿ï¼Œæ¯”å¦‚å¯ä¿¡ä»»ã€é“¾å¼è°ƒç”¨ç­‰ï¼Œä»ä»»ä½•è§’åº¦çœ‹éƒ½æ˜¯ä¸€ç¬”åˆ’ç®—çš„ä¹°å–ã€‚å³ä¾¿æ˜¯æœ‰è¯¸å¤šçš„é™åˆ¶ï¼Œä½†å…´è®¸æ˜¯ä½ ä¸ç†è§£ Promise å¸¦æ¥çš„å¥½å¤„æ‰ä¼šè€ƒè™‘çš„å§ï¼Ÿï¼

## å›é¡¾(Review)
Promise ä¸»è¦è§£å†³çš„é—®é¢˜æ˜¯å›è°ƒå‡½æ•°çš„æ§åˆ¶åè½¬ï¼Œä»è€Œå¯¼è‡´ä¿¡ä»»ç¼ºå¤±çš„é—®é¢˜ã€‚å®ƒå¹¶æ²¡æœ‰æ‘†è„±å›è°ƒå‡½æ•°ï¼Œå®ƒåªæ˜¯åœ¨æˆ‘ä»¬çš„ä»£ç å’Œç¬¬ä¸‰æ–¹åº“ä¹‹é—´ä½œä¸ºä¸€ä¸ªå¯ä¿¡ä»»çš„ä¸­é—´è€…ï¼Œå¸®åŠ©æˆ‘ä»¬è§£å†³é—®é¢˜ã€‚

Promise çš„é“¾å¼è°ƒç”¨å½“ç„¶ä¹Ÿéƒ¨åˆ†ä¼˜åŒ–äº†å¼‚æ­¥ä»£ç çš„æ§åˆ¶æµï¼Œä½†æ˜¾ç„¶è¿˜ä¸å¤Ÿã€‚
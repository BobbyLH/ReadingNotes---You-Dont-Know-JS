# Promises
é€šè¿‡å‰é¢ä¸€èŠ‚çš„æ·±å…¥æ¢è®¨ï¼Œæˆ‘ä»¬å·²ç»å¾ˆæ¸…æ¥š å›è°ƒå‡½æ•° æ‰€é¢ä¸´çš„é—®é¢˜äº† â€”â€” ä¹¦å†™çš„åäººæ€§å’Œä¿¡ä»»é—®é¢˜ã€‚æ˜¾ç„¶æœ€ä¸ºå¤´ç–¼çš„æ˜¯ç”±äº *æ§åˆ¶åè½¬(inversion of control)* æ‰€å¸¦æ¥çš„ä¿¡ä»»é—®é¢˜ã€‚å¹¸å¥½åœ¨ ES6 ä¸­å·²ç»æä¾›äº†å†…ç½®çš„ API æ¥è§£å†³è¿™ä¸ªé—®é¢˜ â€”â€” Promiseã€‚

## Promiseæ˜¯ä»€ä¹ˆï¼Ÿ(What Is a Promise?)
è®¸å¤šå¼€å‘è€…å­¦ä¹ ä¸€ä¸ªæ–°æŠ€æœ¯çš„ç¬¬ä¸€æ­¥é€šå¸¸æ˜¯ç›´æ¥æ’¸ä»£ç ï¼Œæå‡ºä¸€ä¸ª â€œHello Worldâ€ ä»€ä¹ˆçš„ã€‚å½“ç„¶è¿™æ²¡ä»€ä¹ˆä¸å¥½ï¼Œä¸è¿‡æƒ³è¦æ·±å…¥ç†è§£ Promiseï¼Œä»¥åŠå®ƒèƒŒåæ‰€éšå«çš„ç†è®ºï¼Œä¸å¦¨å…ˆä»ä¸¤ä¸ªç±»æ¯”å¼€å§‹ï¼š

### æœªæ¥çš„å€¼(Future Value)
æƒ³è±¡ä¸€ä¸ªåœ¨ç°å®ä¸–ç•Œä¸­å¸¸è§çš„åœºæ™¯ï¼šå½“ä½ èµ°è¿›ä¸€å®¶å¿«é¤åº—(KFCå•¥çš„)çš„å‰å°ï¼Œå‡†å¤‡ä¹°ä¸€ä¸ªæ±‰å ¡å¥—é¤æ¥è§£å†³åˆé¥­æ—¶ï¼Œä½ é€šå¸¸æ˜¯å…ˆä»˜é’±ï¼Œè€Œåæ‹¿åˆ°ä¸€å¼ å°ç¥¨ï¼Œä¸Šé¢æœ‰ä¸€ä¸ªæ•°å­—ï¼Œä»£è¡¨çš„å°±æ˜¯â€œæˆ‘æ¬ ä½ ä¸€ä»½æ±‰å ¡å¥—é¤â€çš„ *æ‰¿è¯º(promise)* â€”â€” é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ æœ€ç»ˆä¼šå‡­æ­¤æ‹¿åˆ°ä¸€ä»½æ±‰å ¡å¥—é¤ã€‚

åœ¨ç­‰å¾…æ±‰å ¡å¥—é¤çš„æ—¶é—´é‡Œï¼Œä½ ä¼šå¹²ä»€ä¹ˆå‘¢ï¼Ÿæ‰“å¼€æ‰‹æœºç¿»ç¿»æœ‹å‹åœˆï¼Ÿç»™æŸäººå‘ä¸ªæ¶ˆæ¯è¯´å¾…ä¼šåƒå®Œä¸­é¥­å»æ‰¾ä»–èŠèŠå¤©ï¼Ÿæˆ–è€…æµè§ˆä¸‹æœ€æ–°çš„çƒ­ç‚¹æ–°é—»ï¼Ÿâ€¦â€¦åæ­£ä¸ä¼šçç­‰åœ¨é‚£é‡Œå°±å¯¹äº† â€”â€” è€Œåœ¨è¿™è‡ªä¿¡æ»¡æ»¡çš„ç­‰ç€çš„æ±‰å ¡å¥—é¤ï¼Œå°±æ˜¯æ‰€è°“çš„ **future value**ã€‚

æ—¶é—´æºœèµ°äº†ï¼Œå½“ â€œ113å·ï¼Œè¯·å–é¤â€ çš„å£°éŸ³å“èµ·ï¼Œä½ å……æ»¡æœŸå¾…çš„å»å‰å°å‡†å¤‡æ¥ä¸‹å»çš„å¤§å¿«æœµé¢æ—¶ï¼Œæ­¤æ—¶ä¼šæœ‰ä¸¤ä¸ªæƒ…å†µç­‰ç€ä½ ï¼Œç¬¬ä¸€ç§ä¼šæŒ‰ç…§ä½ çš„æœŸå¾…è¿›è¡Œï¼Œè‡ªä¸å¿…è¯´ï¼›å¦å¤–ä¸€ç§å°æ¦‚ç‡ä½†æœªå¿…ä¸ä¼šå‘ç”Ÿçš„äº‹ä»¶æ˜¯ï¼šâ€œå¾ˆæŠ±æ­‰ï¼Œæˆ‘ä»¬çš„æ±‰å ¡å–å®Œäº†ï¼Œæ‚¨çœ‹è¦ä¸æ¥ä»½ä¸‰æ˜æ²»æ€ä¹ˆæ ·ï¼Ÿâ€ â€”â€” æ¯æ¬¡å½“ä½ æƒ³ä¹°æ±‰å ¡å¥—é¤æ—¶ï¼Œä½ éƒ½å¾—åšå¥½å¤±è´¥çš„å‡†å¤‡ã€‚

**Note**ï¼šè¿™é‡Œçš„ç±»æ¯”æ˜¯ä¸ªç®€åŒ–çš„åœºæ™¯ï¼Œæ˜¾ç„¶åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œè¦è€ƒè™‘æ›´å¤šçš„äº‹æƒ…ï¼Œæ¯”å¦‚ä½ çš„å·ç ä¸€ç›´éƒ½æ²¡è¢«å«(å¾ˆæœ‰å¯èƒ½æ˜¯è¢«å¿˜è®°äº†)ï¼Œè¿™ä¸ä¹‹å¯¹åº”çš„å°±æ˜¯ä¸€ç›´ â€œæ‚¬è€Œæœªå†³â€ çš„çŠ¶æ€ã€‚

#### ç°åœ¨å’Œå°†æ¥çš„å€¼(Values Now and Later)
ç›´æ¥æ¥æ®µä»£ç ï¼š

```js
var x, y = 2;

console.log(x + y); // NaN
```

ğŸ‘† `x + y` æœ€ç»ˆäº§ç”Ÿçš„æ˜¯ä¸€ä¸ªä¸é¢„æœŸç»“æœä¸ç¬¦çš„ `NaN` â€”â€” éš¾é“ä½ è¿˜æŒ‡æœ› `+` å¸®ä½ ç›‘è§†ç€ `x` å’Œ `y` éƒ½å·²ç»æ˜¯ `number` ç±»å‹çš„å€¼äº†ï¼Œè€Œåå†å¸®ä½ å®ŒæˆåŠ æ³•è¿ç®—ï¼Ÿ

ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œä½ å¾—é è‡ªå·±ï¼Œæ¯”å¦‚ç”¨å›è°ƒå‡½æ•°ï¼š

```js
function add (getX, getY, cb) {
  var x, y;
  getX(function (xVal) {
     x = xVal;
     if (y != undefined) {
       cb(x + y);
     }
  }),
  getY(function (yVal) {
     y = yVal;
     if (x != undefined) {
       cb(x + y);
     }
  })
}

// `fetchX()` å’Œ `fetchY()` æ˜¯åŒæ­¥æˆ–å¼‚æ­¥çš„è·å–å¯¹åº” x å’Œ y å€¼çš„å‡½æ•°
add(fetchX, fetchY, function (sum) {
  console.log(sum);
})
```

ğŸ‘†å…ˆåˆ«ç®¡å®ƒæ˜¯å¦ä¼˜é›…ï¼Œè‡³å°‘å®ƒèƒ½è®©è¡Œä¸ºå¯æ§ï¼Œå³åœ¨`fetchX()` å’Œ `fetchY()` å·¥ä½œæ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œæ— è®ºå®ƒä»¬æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œ`x + y` éƒ½èƒ½æ­£ç¡®çš„è¿”å›å€¼æœŸå¾…çš„å€¼ï¼Œè€Œé `NaN`ã€‚

#### æ‰¿è¯ºçš„å€¼(Promise Value)
è‹¥æ˜¯æŠŠä¸Šé¢çš„ `add` ç”¨ Promise æ¥æ”¹å†™çš„è¯ï¼š

```js
function add (xPromise, yPromise) {
  return Promise.all([xPromise, yPromise])
    .then(function (values) {
      return values[0] + values[1];
    });
}

add(fetchX(), fetchY())
  .then(function (sum) {
    console.log(sum);
  });
```

ğŸ‘†`fetchX()` å’Œ `fetchY()` éƒ½è¿”å›äº† Promise å¯¹è±¡ï¼Œè€Œåè¢«ä½œä¸ºå‚æ•°ä¼ å…¥äº† `add(â€¦)` ä¸­ã€‚

åœ¨ `add(â€¦)` å†…éƒ¨ï¼Œ`Promise.all([â€¦])` æ¥æ”¶äº†å®ƒä»¬ï¼Œéšåå®ƒä¹Ÿè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œè€Œååœ¨å…¶é“¾æ¥çš„ `then(â€¦)` æ–¹æ³•ä¸­ï¼Œå®Œæˆäº† `x + y`(`values[0] + values[1]`) çš„åŠ¨ä½œï¼Œå¹¶ä½œä¸ºç«‹å³ resolve çš„å€¼è¿”å›ã€‚

æœ€ç»ˆï¼Œåœ¨è°ƒç”¨ `add(â€¦)` è¿”å›çš„ Promise å¯¹è±¡åé¢ï¼Œé“¾æ¥ä¸Š `then(â€¦)` æ–¹æ³•ï¼Œå¹¶å°† `sum` è¾“å‡ºåˆ°äº†æ§åˆ¶å°ä¸Šã€‚

å…³é”®çš„åœ°æ–¹æ˜¯ Promise å¯¹è±¡æœ¬èº«åŒ…å«äº† `then` æ–¹æ³•ï¼Œè€Œè°ƒç”¨ `then(â€¦)` æ–¹æ³•æœ¬èº«åˆä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå› æ­¤è¿™ä¸ªé“¾å¯ä»¥æ— é™è¿›è¡Œä¸‹å»ã€‚

å’Œä¹°æ±‰å ¡å¥—é¤çš„ä¾‹å­ä¸€æ ·ï¼Œæˆ‘ä»¬å¾—å¯¹æ„å¤–çš„æƒ…å†µåšå¥½å‡†å¤‡ï¼Œåœ¨ Promise ä¸­ï¼Œå¯¹åº”çš„å°±æ˜¯ `then(â€¦)` æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°ï¼š

```js
add(fetchX(), fetchY())
  .then(
    function (sum) {
      console.log(sum);
    },
    function (err) {
      console.error(err);
    }
  );
```

å› ä¸º Promise æ˜¯ç‹¬ç«‹äºæ—¶é—´çš„ï¼Œå› æ­¤å®ƒå¯ä»¥å¾ˆå¥½çš„é¢„æµ‹å’Œç»„åˆå„ç§æƒ…å†µå’Œç»“æœã€‚å¹¶ä¸”æ›´é‡è¦çš„æ˜¯ï¼Œä¸€æ—¦ Promise çš„çŠ¶æ€ resolve æ‰äº†ï¼Œå°±ä¸èƒ½æ›´æ”¹äº† â€”â€” å°½ç®¡è¿™ä¸ªçŠ¶æ€çš„ç»“æœèƒ½å¤Ÿè¢«æ— é™æ¬¡çš„è®¿é—®ã€‚

**Note**ï¼šè¿™ç§ *ä¸å¯æ›´æ”¹(immutable)* çš„ç‰¹æ€§ï¼Œä½¿å…¶èƒ½å¤Ÿè¢«ä»»æ„çš„ä¼ å…¥åˆ°å„ç§ç¬¬ä¸‰æ–¹çš„ä»£ç ä¸­ï¼Œè€Œä¸å¿…æ‹…å¿ƒè¢«æ— æ„æˆ–æ˜¯æ¶æ„çš„ç¯¡æ”¹ã€‚è€Œè¿™æ˜¯ Promise è®¾è®¡ä¹‹åˆï¼Œæ®šç²¾ç«­è™‘å®Œæˆçš„æœ€åŸºç¡€ã€æœ€é‡è¦çš„åŠŸèƒ½ã€‚

Promise æ˜¯ä¸€ç§èƒ½å¤Ÿå¾ˆå®¹æ˜“çš„å°è£…ã€ç»„åˆ *æœªæ¥çš„å€¼(fature value)* çš„æœºåˆ¶ã€‚

### å®Œæˆäº‹ä»¶(Completion Event)
é™¤äº†ä»£è¡¨ â€œæœªæ¥çš„å€¼â€ ä¹‹å¤–ï¼Œå¯¹ Promise çš„å¦ä¸€ä¸ªæ´è§æ˜¯æŠŠå®ƒè§†ä¸ºæ˜¯ä¸€ä¸ª â€œæµç¨‹æ§åˆ¶â€ çš„æœºåˆ¶ â€”â€” å°†å¼‚æ­¥çš„ä»»åŠ¡æ‹†è§£ä¸ºå¤šä¸ªæ­¥éª¤ç”¨æ¥æ‰§è¡Œã€‚

å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•° `foo` ä¼šæ‰§è¡Œä¸€äº›ä»»åŠ¡ï¼Œä½†æˆ‘ä»¬å¹¶ä¸çŸ¥é“å®ƒæ‰§è¡Œçš„ç»†èŠ‚ï¼Œä»¥åŠå®ƒåˆ°åº•æ˜¯ç«‹å³æ‰§è¡Œè¿˜æ˜¯å»¶è¿Ÿä¸€ä¼šåå†æ‰§è¡Œï¼Œæˆ‘ä»¬åªçŸ¥é“å®ƒä¼šé€šçŸ¥æˆ‘ä»¬å®ƒå·²ç»å®Œæˆï¼Œè€Œåæˆ‘ä»¬å¯ä»¥æ¥ä¸‹å»åšåç»­çš„ä»»åŠ¡ â€”â€” åœ¨ JS çš„ç¼–ç¨‹èŒƒå¼ä¸­ï¼Œä½ é€šå¸¸éœ€è¦ç›‘å¬è¿™äº› â€œé€šçŸ¥â€ï¼Œå°±å¥½åƒäº‹ä»¶è§¦å‘çš„æœºåˆ¶ä¸€æ ·ï¼Œæˆ‘ä»¬èƒ½å¤Ÿè‡ªå®šä¹‰ä¸€äº›éœ€æ±‚ï¼Œæ‰“åŒ…æˆä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¹¶å°†å›è°ƒå‡½æ•°ä¼ é€’ç»™ `foo`ï¼›æœ€ç»ˆ `foo` ä¼šæ ¹æ®æƒ…å†µè§¦å‘è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œä»¥æ­¤æ¥å®Œæˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚

ä¸è¿‡åœ¨ Promise çš„æœºåˆ¶ä¸‹ï¼Œè¿™æ ·çš„å…³ç³»è¢«åè½¬äº† â€”â€” æˆ‘ä»¬çš„å›è°ƒå‡½æ•°ä¸å†æ˜¯è¢« `foo` è§¦å‘çš„ï¼Œè€Œæ˜¯é€šè¿‡ Promise è¿™ä¸ªä¸­é—´å±‚æ¥è§¦å‘ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¸€æ®µä¼ªä»£ç ï¼š

```js
foo(x) {
	// å¼‚æ­¥æ“ä½œâ€¦â€¦
}

foo(42)

on (foo, 'success') {
	// foo å®Œæˆäº†ï¼Œæ¥ç€åšä¸‹ä¸€æ­¥äº‹æƒ…
}

on (foo, 'error') {
	// foo å‘ç”Ÿäº†ç‚¹é—®é¢˜ï¼Œå¤„ç†ä¸€ä¸‹
}
```

`foo(â€¦)` ä¸å¿…å…³å¿ƒï¼Œä¹Ÿä¸ç”¨è¦å¤„ç†ä¸€äº›è®¢é˜…å®ƒçš„äº‹ä»¶ï¼Œè¿™äº›éƒ½äº¤ç»™äº† `on(â€¦)`ï¼Œè¿™æ˜¯ä¸€ç§å¾ˆå¥½çš„ "è´£ä»»åˆ†ç¦»(separation of concerns)" çš„å®ç°ã€‚

ä½†åœ¨ Promise å‡ºæ¥ä¹‹å‰ï¼Œåœ¨ JS ä¸­æƒ³è¦å®ç°è¿™æ ·çš„æ•ˆæœï¼Œåªèƒ½ â€œé­”æ”¹â€ ä¸€æŠŠï¼š

```js
function foo(x) {
	// å¼‚æ­¥æ“ä½œâ€¦â€¦

	// è¿”å›ä¸€ä¸ª listener å¯¹è±¡ï¼Œå®ƒæœ‰ä¸€ä¸ª `on` æ–¹æ³•ï¼Œèƒ½å¤Ÿå®ç°äº‹ä»¶çš„ç»‘å®š
	return listener;
}

const evt = foo(42);

evt.on('success', function(){
	// foo å®Œæˆäº†ï¼Œæ¥ç€åšä¸‹ä¸€æ­¥äº‹æƒ…
});

evt.on('error', function(err){
  // foo å‘ç”Ÿäº†ç‚¹é—®é¢˜ï¼Œå¤„ç†ä¸€ä¸‹
});
```

ğŸ‘† `foo(â€¦)` è¿”å›äº†ä¸€ä¸ªå¯¹è±¡èƒ½å¤Ÿå¤„ç†äº‹ä»¶çš„è®¢é˜…ï¼Œå¦‚æ­¤ä¸€æ¥æˆ‘ä»¬å°±èƒ½åƒäº‹ä»¶æœºåˆ¶ä¸€æ ·æ¥å®Œæˆå¯¹ `foo` åç»­ä»»åŠ¡çš„å¤„ç†ã€‚ä½†è¯´åˆ°åº•ï¼Œ`listener` ä¾ç„¶æ˜¯ç”± `foo` å†…éƒ¨å®ç°ï¼Œå¹¶æ²¡æœ‰é¢ è¦† â€œæ§åˆ¶åè½¬â€ çš„åº•å±‚é€»è¾‘ã€‚

å½“ç„¶ï¼Œä½ è¿˜èƒ½å°†ç›‘å¬ `foo` çš„ `success` å’Œ `error` äº‹ä»¶åˆ†å¼€ï¼Œå•ç‹¬å°è£…æˆ `bar` å’Œ `baz`ï¼š

```js
// `bar` ç›‘å¬ `foo` çš„ success
bar(evt);

// `baz` ç›‘å¬ `foo` çš„ error
baz(evt);
```

è‹¥æ˜¯ `evt` æˆ–è€…è¯´ `listener` æ˜¯ç”±ä¸€ä¸ªå¯é çš„ç¬¬ä¸‰æ–¹æœºåˆ¶æ¥ç”Ÿæˆçš„è¯ï¼Œé‚£çš„çš„ç¡®ç¡®å®ç°äº† â€œåæ§åˆ¶åè½¬(Uninversion of control)â€ï¼Œå¹¶ä¸”åŠ ä¸Š â€œè´£ä»»åˆ†ç¦»â€ çš„æ•ˆæœï¼Œçœ‹ä¸Šå»çœŸçš„å¾ˆ niceã€‚

#### Promiseâ€œäº‹ä»¶â€(Promise "Events")
å…¶å® `evt` å°±æ˜¯å¯¹ Promise çš„ä¸€ä¸ªç±»æ¯”ï¼Œåœ¨ Promise çš„æœºåˆ¶ä¸‹ï¼Œ`foo(â€¦)` ä¼šè¿”å›ä¸€ä¸ª Promise çš„å®ä¾‹ï¼Œè€Œåè¿™ä¸ªå®ä¾‹ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™ `bar(â€¦)` å’Œ `baz(â€¦)`ã€‚

**Note**ï¼šéœ€è¦æ³¨æ„çš„æ˜¯ä¹‹å‰å¯¹äºäº‹ä»¶çš„æªè¾ï¼Œä¸¥æ ¼æ¥è®²ï¼ŒPromise çš„å®ç°å¹¶ä¸æ˜¯é€šè¿‡äº‹ä»¶æœºåˆ¶ï¼Œæ›´æ²¡æœ‰ `success` å’Œ `error` ä¹‹ç±»çš„äº‹ä»¶ç›‘å¬ï¼›ä¸è¿‡ä½ ä¹Ÿèƒ½å°†è°ƒç”¨å…¶å®ä¾‹ä¸Šçš„ `then(â€¦)` å’Œ `catch(â€¦)` æ–¹æ³•ï¼Œç†è§£æˆæ³¨å†Œäº† `fulfillment` æˆ– `rejection` äº‹ä»¶ â€”â€” è™½ç„¶æˆ‘ä»¬ä¸ä¼šåœ¨çœŸå®çš„ä»£ç ä¸­å±•ç¤ºå‡ºæ¥ï¼š

```js
function bar (fooPromise) {
	fooPromise.then(
		function(){
			// resolve ç›‘å¬
		},
		function(){
			// reject ç›‘å¬
		}
	);
}

// baz åŒä¸Š

function foo(x) {
	// å¼‚æ­¥æ“ä½œâ€¦â€¦

	// è¿”å›ä¸€ä¸ª Promise çš„å®ä¾‹
	return new Promise(function(resolve, reject){
		// å†…éƒ¨è°ƒç”¨ `resolve` æˆ–åˆ™ `reject`ï¼Œæœ€ç»ˆä¼šè§¦å‘ç»‘å®šçš„å›è°ƒ
	});
}

var p = foo(42);

bar(p);

baz(p);
```

ğŸ‘† `new Promise(function (resolve, reject) {})` è¿™ç§æ¨¡å¼è¢«ç§°ä¸º [revealing constructor](https://blog.domenic.me/the-revealing-constructor-pattern/) â€”â€” è¢«ä¼ å…¥ Promise æ„é€ å‡½æ•°çš„å‡½æ•°ä¼šè¢«ç«‹å³æ‰§è¡Œï¼Œå¹¶æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯ `resolve`ï¼Œè°ƒç”¨å®ƒä¼šäº§ç”Ÿ fulfillment çš„çŠ¶æ€ï¼›å¦ä¸€ä¸ªæ˜¯ `reject`ï¼Œè°ƒç”¨å®ƒä¼šäº§ç”Ÿ rejection çš„çŠ¶æ€ã€‚

å¦ä¸€ç§æ›´ä¼˜é›…å®ç°çš„æ–¹å¼ï¼Œå°†æ“ä½œ `resolve` å’Œ `reject` çš„ä»£ç åˆ†ç¦»ï¼Œè€Œä¸æ˜¯è€¦åˆåœ¨ä¸€èµ·ï¼š

```js
function bar() {
	// resolve ç›‘å¬
}

function oopsBar() {
	// reject ç›‘å¬
}

// `baz()` å’Œ `oopsBaz()` åŒä¸Š

var p = foo(42);

p.then(bar, oopsBar);

p.then(baz, oopsBaz);
```

**Note**ï¼š`p.then(â€¦).then(â€¦)` å’Œ `p.then(â€¦);p.then(â€¦)` æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸ä¸€æ ·çš„ä»£ç ï¼Œå‰è€…çš„é“¾å¼è°ƒç”¨ä¸­ï¼Œå‰åä¸¤ä¸ª `then(â€¦)` æ˜¯ä¸åŒçš„ Promise å®ä¾‹ä¸Šçš„æ–¹æ³•ï¼›åè€…åˆ™éƒ½æ˜¯å‡ºè‡ªåŒä¸€ä¸ª Promise å®ä¾‹çš„ `then(â€¦)` æ–¹æ³•ï¼Œå¹¶ä¸”å®ƒçš„çŠ¶æ€ä¸€æ—¦ç¡®å®šï¼Œå°±æ— æ³•è¢«æ”¹å˜äº†ã€‚


## Thençš„é¸­å¼ç±»å‹(Thenable Duck Typing)
ä½¿ç”¨ Promise é¢ä¸´çš„æœ€å¤´ç–¼çš„é—®é¢˜æ˜¯å¦‚ä½•ç¡®å®šæŸä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯çœŸæ­£çš„ Promiseã€‚

`p instanceof Promise` è¿™æ ·çš„æ£€æµ‹æ–¹å¼æ²¡åŠæ³•å®Œå…¨æ»¡è¶³éœ€æ±‚çš„ä¸»è¦åŸå› æ˜¯ï¼Œæµè§ˆå™¨çª—å£ä¹‹é—´(iframe)çš„äº¤äº’ï¼Œè‹¥æ˜¯å®ƒä»¬ä½¿ç”¨çš„ Promiseå®ä¾‹ æ˜¯ä¸åŒçš„æ„é€ å‡½æ•°åˆ›å»ºçš„ï¼Œé‚£è¿™æ ·çš„æ£€æµ‹å°±ä¼šå¤±è´¥ã€‚

å†è€…ï¼Œè‹¥æ˜¯ä½ ä½¿ç”¨äº†æŸä¸ªä¸‰æ–¹çš„åº“ï¼Œå®ƒçš„ Promise å¹¶éæ˜¯åŸºäºåŸç”Ÿçš„ Promise æ¥å®ç°ï¼Œé‚£ä¹ˆä¹Ÿæ— æ³•æ»¡è¶³éœ€æ±‚ã€‚

å› æ­¤ï¼Œç¤¾åŒºå†…å¹¿æ³›æµè¡Œçš„ä¸€ç§ ç±»å‹æ£€æµ‹ æœºåˆ¶æ˜¯åŸºäº â€œé¸­å¼ç±»å‹(duck typing)â€ â€”â€” å¦‚æœå®ƒé•¿å¾—åƒé¸­å­ï¼Œå¹¶ä¸”èƒ½åƒé¸­å­ä¸€æ ·å‘±å‘±çš„å«ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯é¸­å­ã€‚è¿™ç§åŸºäº â€œå€¼çš„å½¢çŠ¶â€ çš„æ£€æŸ¥ï¼Œè¢«ç”¨äº â€œPromiseçš„çœŸå‡ç¾çŒ´ç‹â€ ä¹‹ä¸­ï¼Œå³æ‰€è°“çš„ thenableï¼š

```js
function isPromise (p) {
  if (p !== null && (typeof p === 'object' || typeof p === 'function') && typeof p.then === 'function') {
    // thenable!
    return true;
  }
  return false;
}
```

å¥½åƒè¿˜è¡Œï¼Ÿç«‹é©¬éœ²é¦…ï¼š

```js
var o = { then: function() {} };

var v = Object.create(o);

v.hasOwnProperty('then'); // false

isPromise(v); // true
```

è€Œè‹¥æ˜¯æœ‰äºº æ— æ„/æ•…æ„/æ¶æ„ åœ¨ä¸€äº›å†…ç½®çš„ç±»çš„åŸå‹å¯¹è±¡ä¸Šé¢æ·»åŠ äº† `then` æ–¹æ³•çš„è¯ï¼š

```js
Object.prototype.then = function(){};
Array.prototype.then = function(){};

var v1 = { hello: 'world' };
var v2 = [ 'Hello', 'World' ];

isPromise(v1); // true
isPromise(v2); // true
```

ğŸ‘†è¦æ˜¯ä½ æŠŠè¿™äº›å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™ä¹‹å‰çš„ `baz`ã€`bar` çš„è¯ï¼Œé‚£å®ƒä»¬ä¼šè¢«æ°¸è¿œçš„æŒ‚èµ·â€¦â€¦

ä½ å¯èƒ½ä¼šè§‰å¾—ï¼Œè¿™æ˜¯å±è¨€è€¸å¬å§ï¼Ÿï¼é‡åˆ°è¿™ç§æƒ…å†µçš„æ¦‚ç‡å®åœ¨æ˜¯å¤ªå°äº†ã€‚ä½†ä½ ä¸å¾—ä¸é˜²çš„æ˜¯æœ‰ä¸€äº›ä½ ä¾èµ–çš„ç¬¬ä¸‰æ–¹çš„åº“ï¼Œå®ƒä»¬å¾ˆå¯èƒ½æ˜¯åœ¨ ES6 ä¹‹å‰çš„äº§ç‰©ï¼Œå¹¶ä¸”æœ‰ `then` æ–¹æ³•æŒ‚è½½åœ¨å®ƒçš„æŸä¸ªå¯¹è±¡ä¸Šã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œ`isPromise` å°±ä¸å¥½ä½¿äº†ã€‚

## Promise å’Œ ä¿¡ä»»é—®é¢˜(Promise Trust)
è™½ç„¶å‰é¢æˆ‘ä»¬å·²ç»é€šè¿‡ä¸¤ä¸ªå¾ˆå½¢è±¡çš„ç±»æ¯”(â€œæœªæ¥çš„å€¼â€å’Œâ€œå®Œæˆçš„äº‹ä»¶â€)ï¼Œäº†è§£åˆ° Promise å¦‚ä½•åœ¨å¼‚æ­¥é¢†åŸŸå¤§æ”¾å…‰å½©çš„ï¼Œä½†å¦‚æœä»…ä»…åˆ°è¿™é‡Œï¼Œä¸ç»§ç»­æ·±å…¥çš„è¯ï¼Œé‚£å°±å¤±å»äº†è®©æˆ‘ä»¬äº†è§£å…¶æœ€é‡è¦çš„æ ¸å¿ƒç‰¹å¾(ä¹Ÿæ˜¯Promise ä¹‹æ‰€ä»¥å­˜åœ¨çš„æ ¹æœ¬åŸå› )çš„æœºä¼š â€”â€” ä¿¡ä»»(Trust)ã€‚

å›é¡¾ä¸‹åŸºäº å›è°ƒå‡½æ•° çš„å¼‚æ­¥ä»£ç ç”±äºå…¶ æ§åˆ¶åè½¬ è€Œå¸¦æ¥çš„å„ç§ â€œä¿¡ä»»â€ é—®é¢˜ï¼š

  - è¿‡æ—©çš„è°ƒç”¨å›è°ƒå‡½æ•°

  - è¿‡è¿Ÿçš„è°ƒç”¨å›è°ƒå‡½æ•°

  - å¤ªå°‘/å¤ªå¤š åœ°è°ƒç”¨äº†å›è°ƒå‡½æ•°

  - è°ƒç”¨å›è°ƒå‡½æ•°æ—¶ï¼Œç¼ºå°‘å¿…é¡»çš„å‚æ•°

  - æŠŠå„ç§å¼‚å¸¸å’Œé”™è¯¯éƒ½ â€œåæ‰äº†â€ 

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬ä¸€ä¸ªä¸ªçš„æ¥çœ‹ Promise åˆ°åº•æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ï¼š

### è¿‡æ—©çš„è°ƒç”¨(Calling Too Early)
å›è°ƒå‡½æ•°å¯èƒ½æ˜¯åŒæ­¥ï¼Œä¹Ÿå¯èƒ½æ˜¯å¼‚æ­¥è¢«è°ƒç”¨ï¼Œè€Œæ²¡æœ‰ä¸€ä¸ªå†…ç½®çš„æœºåˆ¶ç¡®ä¿å…¶ä¸€å®šæ˜¯å¼‚æ­¥çš„ï¼Œé™¤éæ‰‹åŠ¨çš„ä½¿ç”¨ `setTimeout(â€¦)`ã€‚

è€Œåœ¨ Promise çš„æœºåˆ¶ä¸­ï¼Œä»»ä½•æ”¾åˆ° `then(â€¦)` ä¸­çš„å›è°ƒå‡½æ•°ï¼Œèƒ½å¤Ÿè¢«ç¡®ä¿æ€»ä¼šæ˜¯å¼‚æ­¥è¢«è°ƒç”¨çš„(å‡†ç¡®æ¥è®²æ˜¯é€šè¿‡ *ä»»åŠ¡é˜Ÿåˆ—* çš„æœºåˆ¶æ¥å®ç°çš„)ã€‚

### è¿‡è¿Ÿçš„è°ƒç”¨(Calling Too Late)
ğŸ‘† å’Œä¸Šé¢çš„ä¸€æ ·ï¼Œä»»ä½•æ”¾åˆ° `then(â€¦)` ä¸­çš„å›è°ƒå‡½æ•°ï¼Œåœ¨ è°ƒç”¨äº†ç”± Promise æä¾›çš„ `resolve(â€¦)` æˆ– `reject(â€¦)` åï¼Œèƒ½å¤Ÿç¡®ä¿æ€»ä¼šåœ¨æ¥ä¸‹å»çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­è¢«è°ƒç”¨ â€”â€” ä½ ä¸å¯èƒ½åœ¨åŒæ­¥çš„ä»»åŠ¡ä¸­è§‚å¯Ÿåˆ°å®ƒè¢«æ‰§è¡Œã€‚å› æ­¤ï¼Œå½“ä¸€ä¸ª Promise å®ä¾‹çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆæ‰€æœ‰æ³¨å†Œåœ¨å®ƒçš„ `then(â€¦)` æ–¹æ³•ä¸Šçš„å›è°ƒå‡½æ•°éƒ½ä¼šæŒ‰ç…§æ³¨å†Œçš„é¡ºåºè¢«è°ƒç”¨ï¼Œå³ä¾¿æ˜¯åœ¨è¿™äº›å›è°ƒå‡½æ•°çš„å†…éƒ¨ï¼Œä¹Ÿæ²¡åŠæ³•å½±å“(å»¶è¿Ÿ)å…¶ä»–çš„å›è°ƒå‡½æ•°ï¼š

```js
const p = new Promise((resolve, reject) => {
  resolve('some data');
});

p.then(function () {
  p.then(function () {
    console.info('C');
  });
  console.info('A');
});

p.then(function () {
  console.info('B');
});

// A B C
```

ğŸ‘† `'C'` æ— æ³•é˜»æ­¢æˆ–æ”¹å˜ `'B'` çš„æ‰§è¡Œ(é¡ºåº)ï¼Œè€Œè¿™ä¹Ÿæ˜¯ Promise çš„ä¼˜åŠ¿ä¹‹ä¸€ã€‚

#### Promise é¡ºåºçš„æ€ªç™–(Promise Scheduling Quirks)
éœ€è¦æ ¼å¤–æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸¤ä¸ªåˆ†å¼€çš„ Promise é“¾å¼ä»£ç é‡Œçš„å›è°ƒå‡½æ•°ï¼Œä½ æ˜¯æ²¡æœ‰åŠæ³•ç¡®ä¿å®ƒä»¬çš„æ‰§è¡Œé¡ºåºçš„ã€‚æ¯”å¦‚ï¼Œä¸¤ä¸ª Promise çš„å®ä¾‹ `p1` å’Œ `p2` åŒæ—¶å˜åˆ°äº† resolved çš„çŠ¶æ€ï¼Œ`p1.then(â€¦)` å’Œ `p2.then(â€¦)` ä¹¦å†™çš„å…ˆåé¡ºåºé€šå¸¸æ˜¯å…¶å†…éƒ¨å›è°ƒå‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼Œä½†è‹¥æ˜¯æ”¹å˜ä¸€äº›ç»†èŠ‚ï¼š

```js
const p3 = new Promise((resolve, reject) => {
  resolve('B');
});

const p1 = new Promise((resolve, reject) => {
  resolve(p3);
});

const p2 = new Promise((resolve, reject) => {
  resolve('A');
});

p1.then(function (v) {
  console.info(v);
});

p2.then(function (v) {
  console.info(v);
});

// A B
```


![Promise Scheduling Quirks](./assets/promise_schedule_quirks.jpg)


ğŸ‘†å¹¶éæŒ‰ç…§è®¾æƒ³çš„æ‰“å°å‡ºäº† `B A`ï¼Œè¿™æ˜¯å› ä¸º `p1` ä¸­çš„ `resolve(p3);` å…¶å®æ˜¯ resolve äº†å¦ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œè€Œ `p2` åˆ™ resolve çš„ä¸€ä¸ªåŒæ­¥ä»»åŠ¡ï¼Œå› æ­¤åœ¨è¿™ä¸ªç»´åº¦çœ‹ï¼Œ`p2` resolve çš„ç»“æœè¦æ—©äº `p1` çš„ç»“æœã€‚ä¸è¿‡è¿™ä¸€åˆ‡éƒ½å‘ç”Ÿåœ¨åŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå³ **å®ƒä»¬resolveçš„ç»“æœ** å¹¶æ²¡æœ‰åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«ã€‚

### æ²¡æœ‰è°ƒç”¨å›è°ƒå‡½æ•°(Never Calling the Callback)
è¿™ä¸ªé—®é¢˜åœ¨ Promise ä¸­å¾ˆå¥½æå®šï¼šåªè¦ä½ æ³¨å†Œäº† fulfillment å’Œ rejection çš„å›è°ƒå‡½æ•°ï¼Œä¸€æ—¦ Promise çš„çŠ¶æ€æ”¹å˜ï¼Œå°±å¿…ç„¶ä¼šè°ƒç”¨å…¶ä¸­çš„æŸä¸€ä¸ªå›è°ƒã€‚è‡³äºæ‰€è°“çš„ä¼šè¢« â€œæ°¸è¿œåœ°æŒ‚èµ·â€ï¼Œå³çŠ¶æ€æ°¸è¿œæ²¡æœ‰ä»»ä½•æ”¹å˜ï¼Ÿå…¶å®å¾ˆå¥½è§£å†³ï¼š

```js
function timeoutPromise (delay) {
  return new Promise(function (resolve, reject) {
    setTimeout(function () {
      reject('timeout');
    }, delay);
  })
}

Promise.race([
  foo(),
  timeoutPromise(3000)
])
.then(
  function () {},
  function (err) {}
);
```

ä¸€æ—¦ `3000` æ¯«ç§’è¿‡äº†ï¼Œ`foo()` è¿”å›çš„ Promise å®ä¾‹è¿˜æ²¡ç¡®å®šçŠ¶æ€çš„è¯ï¼Œå°±ä¼šèµ°åˆ°è¶…æ—¶çš„é€»è¾‘ä¸­ï¼Œå› æ­¤ä½ ä¹Ÿä¸ç”¨æ‹…å¿ƒä½ çš„ç¨‹åºä¼šè¢« â€œæ°¸è¿œåœ°æŒ‚èµ·â€ã€‚

### å¤ªå°‘/å¤ªå¤š çš„è°ƒç”¨(Calling Too Few or Too Many Times)
ç†æƒ³çš„å›è°ƒå‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•°è‚¯å®šæ˜¯ one â€”â€” è¿™æ²¡æœ‰ç–‘è®®å§ï¼Ÿï¼é‚£ä¹ˆ â€œå¤ªå°‘â€ å°±æ˜¯æ²¡æœ‰è¢«è°ƒç”¨ï¼Œé‚£å°±å›åˆ°ğŸ‘†ä¸Šé¢æåˆ°çš„éƒ¨åˆ†ã€‚

â€œå¤ªå¤šâ€ çš„ç–‘è™‘ä¹Ÿå¾ˆå®¹æ˜“è¢«è§£å†³ â€”â€” ä¸€æ—¦ Promise çŠ¶æ€ç¡®å®šäº†ï¼Œé‚£ä¹‹åå°±æ— æ³•å†æ¬¡æ”¹å˜ï¼Œå³ä¾¿ä½ åå¤çš„è°ƒç”¨å®ä¾‹åŒ–æ—¶ï¼Œæä¾›ç»™ä½ çš„ `resolve(â€¦)` å’Œ `reject(â€¦)`ï¼ŒPromise å®ä¾‹åªä¼šæ¥å—ç¬¬ä¸€ä¸ªè¢«è°ƒç”¨çš„ï¼Œå…¶ä»–çš„éƒ½ä¼šè¢«å¿½è§†ã€‚

å› æ­¤ï¼Œä»»ä½•æ³¨å†Œåœ¨ `then(â€¦)` ä¸­çš„å›è°ƒï¼Œåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚å½“ç„¶ï¼Œä½ èƒ½å¤Ÿæ— é™åˆ¶çš„åœ¨ç›¸åŒçš„ Promise å®ä¾‹ä¸­æ³¨å†Œç›¸åŒçš„å›è°ƒå‡½æ•°ï¼Œæ¯”å¦‚ `p.then(f); p.then(f);`ï¼Œé‚£å®ƒä»¬ä¼šè¢«ä¸ä¹‹å¯¹åº”çš„æ¬¡æ•°â€¦ â€”â€” ä¸è¿‡é‚£æ˜¯ä½ è‡ªå·±çš„éå¾—è¦æ¬èµ·çŸ³å¤´ç ¸è‡ªå·±çš„è„šï¼Œä½ æ€ªè°ï¼Ÿï¼

### ç¼ºå°‘æ‰€éœ€çš„å‚æ•°(Failing to Pass Along Any Parameters/Environment)

`resolve(â€¦)` å’Œ `reject(â€¦)` éƒ½èƒ½æ¥æ”¶ **ä¸€ä¸ª** ä»»ä½•ç±»å‹çš„å‚æ•°ï¼Œå®ƒä»¬ä¼šè¢«ä¼ é€’ç»™æ‰€æœ‰æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚

è‹¥æ˜¯è¶…è¿‡äº†ä¸€ä¸ªå‚æ•°ï¼Ÿé™¤äº†ç¬¬ä¸€ä¸ªï¼Œå…¶ä»–éƒ½ä¼šè¢« â€œæ— æƒ…çš„æŠ›å¼ƒâ€ã€‚åƒä¸‡åˆ«å¹»æƒ³ç”¨ `resolve(â€¦);resolve(â€¦);resolve(â€¦);â€¦â€¦` æ¥å®ç°å¤šä¸ªå‚æ•°çš„ä¼ é€’ â€”â€” è¿˜æ˜¯è€è€å®å®çš„ç”¨ `object` æˆ–è€… `array` æ¥åŒ…è£¹å¤šä¸ªå‚æ•°æ¯”è¾ƒç°å®ã€‚

å¦å¤–ï¼Œä»»ä½•æ³¨å†Œåˆ° `then(â€¦)` ä¸­çš„å›è°ƒå‡½æ•°ï¼Œéƒ½ä¿å­˜äº†å®šä¹‰å®ƒæ—¶çš„ä¸Šä¸‹æ–‡ï¼Œå³ â€œé—­åŒ…â€ è¿™ä¸ªèƒ½åŠ›ä¾ç„¶æœ‰æ•ˆã€‚

### â€œåæ‰äº†â€å„ç§å¼‚å¸¸å’Œé”™è¯¯(Swallowing Any Errors/Exceptions)

```js
const p = new Promise(function (resolve, reject) {
	foo.bar();
	resolve(42);
});

p.then(
	function fulfilled () {
    // æ°¸è¿œåˆ°ä¸äº†è¿™å„¿
  },
	function rejected (err) {
    // TypeError
  }
);
```

ğŸ‘† `foo.bar();` æ˜¯äº§ç”Ÿé”™è¯¯çš„æºå¤´ï¼Œè€Œä¸”å³ä¾¿æ˜¯è¿™ä¸ªå¼‚å¸¸æ˜¯å‘ç”Ÿåœ¨ Promise çš„å®ä¾‹åŒ–è¿‡ç¨‹ä¸­(åŒæ­¥)ï¼Œä¹Ÿä¼šè®©è¿™ä¸ªå¼‚å¸¸åœ¨å¼‚æ­¥çš„è¡Œä¸ºä¸­è¢«æ•è· â€”â€” è¿™ä¸€ç‚¹éå¸¸ç‰›é€¼ï¼Œèƒ½å¤Ÿè®©ä½ æ— æ„Ÿçš„å°±è§£å†³äº†ä¹‹å‰æåˆ°çš„ race condition çš„é—®é¢˜ï¼Œæ— è®ºè¿™æ®µä»£ç å¦äº§ç”Ÿäº†å¼‚å¸¸ã€‚

é‚£è‹¥æ˜¯å¼‚å¸¸å‘ç”Ÿåœ¨ `fulfilled` çš„å›è°ƒå‡½æ•°ä¸­å‘¢ï¼Ÿ

```js
const p = new Promise(function (resolve, reject) {
	resolve(42);
});

p.then(
	function fulfilled (val) {
    foo.bar();
    console.info(val);
  },
	function rejected (err) {
    // æ°¸è¿œåˆ°ä¸äº†è¿™å„¿
  }
);
```

å¥½åƒæŠŠå¼‚å¸¸â€œåæ‰äº†â€ï¼Ÿé‚£åªæ˜¯å¹»è§‰ â€”â€” `p.then(â€¦)` å…¶å®ä¼šè¿”å›å¦ä¸€ä¸ª Promise çš„å®ä¾‹ï¼Œè€Œè¿™ä¸ªå®ä¾‹åˆ™ä¼šè¿›å…¥åˆ°å¼‚å¸¸æ•è·çš„çŠ¶æ€ã€‚

ä½ å¯èƒ½ä¼šæƒ³ï¼Œä¸ºå•¥ä¸ç›´æ¥è¿›å…¥åˆ°å½“å‰è¿™ä¸ª Promise å®ä¾‹çš„å¼‚å¸¸æ•è·å®Œäº‹ï¼Ÿå½“ç„¶ä¸èƒ½ï¼Œå› ä¸ºè¿™è¿èƒŒäº† Promise æœ€é‡è¦çš„åŸåˆ™ â€”â€” ä¸€æ—¦çŠ¶æ€ç¡®å®šå°±ä¸èƒ½æ”¹å˜ã€‚å³ `p` æ€»æ˜¯ å€¼ä¸º `42` çš„ fulfilled çš„çŠ¶æ€ã€‚è€Œè‹¥æ˜¯è¿èƒŒäº†è¿™ä¸€åŸåˆ™ï¼Œè¯•æƒ³ä¸‹ï¼Œå½“ä½ åœ¨åŒä¸€ä¸ª Promise çš„å®ä¾‹ä¸Šï¼Œæ³¨å†Œäº†å¤šä¸ªå›è°ƒçš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°æœ‰çš„ç»“æœæ˜¯è¿™æ ·ï¼Œæœ‰çš„ç»“æœæ˜¯é‚£æ ·â€¦â€¦

### èƒ½è¢«ä¿¡ä»»çš„Promise?(Trustable promise?)
åœ¨æˆ‘ä»¬å®Œå…¨ä¿¡ä»» Promise ä¹‹å‰ï¼Œè¿˜æœ‰æœ€åä¸€ä¸ªé—®é¢˜éœ€è¦ä»”ç»†çš„æ¢è®¨ä¸‹ â€”â€” Promise å¹¶æ²¡æœ‰æ‘†è„±æ‰å›è°ƒå‡½æ•°ï¼Œè€Œä»…ä»…æ˜¯æ”¹å˜äº†å›è°ƒå‡½æ•°ä¼ é€’çš„ä½ç½® â€”â€” ä¸å†æ˜¯æŠŠå›è°ƒå‡½æ•°ä¼ åˆ° `foo` é‡Œé¢å»ï¼Œè€Œæ˜¯å°†å›è°ƒå‡½æ•°ä¼ å…¥ `foo(â€¦)` çš„è¿”å›å€¼ä¸­ã€‚ä½†ä¸ºä»€ä¹ˆè¿™ç§æ¨¡å¼å°±å€¼å¾—ä¿¡ä»»å‘¢ï¼Ÿéš¾é“ä»…ä»…æ˜¯å› ä¸ºå®ƒå·²è¢«ä¿¡ä»»äº†ï¼Œæ‰€ä»¥å°±ä¿¡ä»»äº†ä¹ˆï¼Ÿï¼

å¯¹äºå†…ç½®çš„é™æ€æ–¹æ³• `Promise.resolve(â€¦)`ï¼Œè‹¥æ˜¯ä½ ä¼ å…¥çš„æ˜¯ä¸€ä¸ªéå¼‚æ­¥ã€éPromiseã€éthenableçš„å€¼ï¼Œé‚£ä½ ä¼šå¾—åˆ°ä¸€ä¸ª `fulfilled` çš„å€¼ï¼Œæ¯”å¦‚ğŸ‘‡ä¸‹é¢ä¸¤ä¸ª Promise å…¶å®æ˜¯æ²¡å•¥åŒºåˆ«çš„ï¼š

```js
var p1 = new Promise((resolve, reject) => {
  resolve(42);
});

var p2 = Promise.resolve(42);
```

ä½†è‹¥æ˜¯ä½ ä¼ å…¥çš„æ˜¯ä¸€ä¸ª Promise çš„å€¼ï¼Œé‚£åˆ™ä¼šåŸå°ä¸åŠ¨çš„å°†å…¶è¿”å›ï¼š

```js
var p1 = Promise.resolve(42);

var p2 = Promise.resolve(p1);

p1 === p2; // true
```

![promise_resolve](./assets/promise_trusable_promise.png)

æ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œå¯¹äºéšæ„ä½¿ç”¨ éPromiseçš„thenable å¯¼è‡´çš„æ„å¤–çš„åæœï¼š

```js
var p = {
	then: function(cb, errcb) {
		cb(42);
		errcb('evil laugh!');
	}
};

p
.then(
  function fulfilled (val) { console.log(val); },
  function rejected (err) { console.error(err); }
);
```

![thenable](./assets/promise_trusable_promise_thenable.png)

ğŸ‘† `p` æ˜¯ä¸€ä¸ª `thenable` ä½†å¹¶éæ˜¯ä¸¥æ ¼æŒ‰ç…§ promise çš„è§„èŒƒæ¥è®¾è®¡çš„ï¼Œå®ƒä¸èƒ½è¢«ä¿¡ä»»ã€‚ä¸è¿‡å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä½œä¸ºå€¼ï¼Œä¼ å…¥åˆ° `promise.resolve(â€¦)` ä¸­ï¼Œæ¥è§£å†³ä¿¡ä»»é—®é¢˜ï¼š

```js
Promise.resolve(p)
.then(
  function fulfilled (val) { console.log(val); },
  function rejected (err) { console.error(err); }
);
```

![thenable_resolved](./assets/promise_trusable_promise_thenable_resolve.png)

å› æ­¤ï¼Œè‹¥æ˜¯å½“æˆ‘ä»¬è¦ä½¿ç”¨æŸä¸ªç¬¬ä¸‰æ–¹çš„ thenable çš„å·¥å…·å‡½æ•° `foo(â€¦)` æ—¶ï¼Œ`Promise.resolve(â€¦)` èƒ½ç¡®ä¿å…¶è¿”å›çš„å€¼ä¸€å®šæ˜¯å¯ä¿¡ä»»çš„ Promiseï¼š

```js
Promise.resolve(foo(42))
.then(function (v) {
	console.log(v);
});
```

é™¤æ­¤ä¹‹å¤–ï¼Œ`Promise.resolve(â€¦)` è¿˜æœ‰ä¸ªå¥½å¤„å®ƒèƒ½ â€œæ ¼å¼åŒ–â€ ä¼ å…¥çš„å€¼ â€”â€” æ— è®ºä¼ å…¥çš„å€¼æ˜¯ç«‹å³æ‰§è¡Œçš„åŒæ­¥ä»£ç ï¼Œè¿˜æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„å¼‚æ­¥ä»£ç ï¼Œæœ€ç»ˆå®ƒè¿”å›çš„å€¼éƒ½æ˜¯å¼‚æ­¥çš„ã€‚

### ä¿¡ä»»çš„å»ºç«‹(Trust Built)
å›åˆ°å¤šå¹´å‰ï¼Œå½“ JS çš„æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡åªèƒ½ç”¨å›è°ƒå‡½æ•°è§£å†³çš„æ—¶å€™ï¼Œä¿¡ä»»é—®é¢˜æœ‰æ˜¾å¾—é‚£ä¹ˆé‡è¦ä¹ˆï¼Ÿä¸ä¸€å®šå§ï¼ï¼Ÿä½†æ˜¯æ—¶è‡³ä»Šæ—¥ï¼Œå½“ä½ ä¸€æ—¦æ¥è§¦è€Œåä½¿ç”¨è¿‡äº† Promiseï¼Œå†å›å¤´çœ‹çœ‹ä»¥å‰çš„ï¼Œä»…ä»…ç”±å›è°ƒå‡½æ•°æ„æˆçš„æ‘‡æ‘‡æ¬²å çš„å¼‚æ­¥ä»£ç æ—¶ï¼Œä½ å‘ç°ä½ å†ä¹Ÿå›ä¸å»äº†â€¦â€¦

Promise é€šè¿‡é¢ è¦†æ§åˆ¶åè½¬ï¼Œå¸¦æ¥çš„ä¸ä»…ä»…æ˜¯å¯ä¿¡ä»»çš„ä»£ç å’Œæ‰§è¡Œæœºåˆ¶ï¼Œæ›´ä¸ºé‡è¦çš„æ˜¯å®ƒè§£æ”¾äº†æˆ‘ä»¬çš„å¿ƒæ™ºï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿæ›´ä¸“æ³¨äºå…¶ä»–ä»»åŠ¡ã€‚

## é“¾å¼æµ(Chain Flow)
å‰é¢æˆ‘ä»¬å·²ç»çœ‹è¿‡ä¸æ­¢ä¸€éäº†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€è¿ä¸² *this-then-that* çš„æ“ä½œï¼Œå°†è®¸å¤šä¸ª Promise ä¸²è”èµ·æ¥ï¼Œç»„æˆä¸€ä¸ªæœ‰åºçš„å¼‚æ­¥é“¾å¼ä»£ç å—ã€‚

è€Œè®©è¿™ä¸€åˆ‡èµ·ä½œç”¨çš„æ ¸å¿ƒï¼Œæºè‡ªäº Promise çš„ä¸¤ä¸ªå†…ç½®çš„è¡Œä¸ºæ¨¡å¼ï¼š

- æ¯æ¬¡è°ƒç”¨ Promise çš„ `then(â€¦)` æ–¹æ³•åï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ Promiseï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä¸€ç›´é“¾æ¥ä¸‹å»ï¼›

- æ— è®º `then(â€¦)` çš„ fulfillment å›è°ƒå‡½æ•°(å³ `then` çš„ç¬¬ä¸€ä¸ªå‚æ•°) return ä»»ä½•å€¼ï¼Œå®ƒéƒ½ä¼šè¢«è‡ªåŠ¨çš„è®¾ç½®ä¸º Promise é“¾ä¸­çš„ fulfillment çŠ¶æ€ã€‚

```js
var p = Promise.resolve(22);

var p2 = p.then(res => {
  console.log(res); // 22
  return res * 2;
});

p2.then(res => console.log(res)); // 44
```

return çš„ `res * 2` å°±æ˜¯ç¬¬ä¸€ä¸ª `then(â€¦)` æ–¹æ³•çš„ fulfillment å›è°ƒå‡½æ•°è¿”å›çš„å€¼ï¼Œå®ƒä¼šè¢«è‡ªåŠ¨è®¾ç½®ä¸º `p2` çš„ `then(â€¦)` æ–¹æ³•çš„ fulfillment å›è°ƒå‡½æ•°æ¥æ”¶åˆ°çš„å€¼ã€‚è€Œåä½ å¯ä»¥å°† `p2.then(â€¦)` è¿”å›çš„å€¼å‚¨å­˜åˆ°å¦ä¸€ä¸ªå˜é‡ `p3` ä¸­ï¼Œå¹¶æ“ä½œå®ƒçš„ `then(â€¦)` æ–¹æ³•â€¦â€¦

å¯å³ä¾¿æ˜¯å°† Promise å‚¨å­˜äº `p2` ä¹Ÿæ˜¾å¾—æœ‰äº›å¤šä½™ï¼Œç›´æ¥ â€œä¸²â€ èµ·æ¥å…¶å®å°±å¯ä»¥äº†ï¼š

```js
var p = Promise.resolve(22);

p
.then(res => {
  console.log(res); // 22
  return res * 2;
})
.then(res => console.log(res));
```

ğŸ‘†æ— è®ºä½ æƒ³ â€œä¸²â€ èµ·å¤šå°‘ä¸ª `then(â€¦)` éƒ½æ˜¯å¯ä»¥çš„ï¼Œè¿™æºäºæ¯ä¸ª `then(â€¦)` éƒ½ä¼šè‡ªåŠ¨çš„è¿”å›ä¸€ä¸ªæ–°çš„ Promise çš„æœ¬è´¨æ‰€åœ¨ã€‚

åˆ°è¿™é‡Œï¼Œâ€œè¿™é“èœâ€ ä¼¼ä¹ä¸€åˆ‡éƒ½å¾ˆå®Œç¾ï¼Œä½†è¿˜æ˜¯æ„Ÿè§‰ç¼ºç‚¹è°ƒæ–™ â€”â€” è‹¥æ˜¯æƒ³åœ¨ `then(â€¦)` ä¸­å¤„ç†ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶ï¼Œå‘èµ·ä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„è¯ï¼Œè¦æ€ä¹ˆåšå‘¢ï¼Ÿå…³é”®ä¾ç„¶åœ¨ `then(â€¦)` çš„è¿”å›å€¼ä¸Šï¼š

```js
var p = Promise.resolve(22);

p
.then(res => {
  console.log(res); // 22
  return new Promise((resolve, reject) => {
    resolve(res * 2); // å°† Promise çš„çŠ¶æ€è®¾ç½®ä¸º fulfillï¼Œä»¥ä¾¿èƒ½åœ¨ä¸‹ä¸€ä¸ª then(â€¦) ä¸­çš„ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°ä¸­æ‹¿åˆ°ç›¸åº”çš„å€¼
  });
})
.then(res => console.log(res));
```

ğŸ‘†çœ‹è§äº†ä¹ˆï¼Ÿå…³é”®æ˜¯ return ä¸€ä¸ª thenable æˆ– Promiseï¼Œè€Œååœ¨ä¸‹ä¸€ä¸ª `then(â€¦)` æ–¹æ³•é‡Œçš„å›è°ƒå‡½æ•°è¢«è°ƒç”¨å‰ï¼Œä¼šä¸€å±‚å±‚åœ°é€’å½’æ‹†è§£(unwrapping)è¿™ä¸ªè¿”å›çš„ thenable æˆ– Promiseï¼Œç›´åˆ°å®ƒçš„æœ€åçŠ¶æ€è¢«ç¡®å®šä¸‹æ¥(resolution)ä¸ºæ­¢ã€‚

å› æ­¤ï¼Œæƒ³è¦åœ¨è¿™ä¸€ä¸²é“¾å¼ä¸­å®ç°å¼‚æ­¥æ“ä½œï¼š

```js
var p = Promise.resolve(22);

p
.then(res => {
  console.log(res); // 22
  return new Promise((resolve, reject) => {
    // 1000 æ¯«ç§’åçš„å¼‚æ­¥æ“ä½œ
    console.time();
    setTimeout(() => resolve(res * 2), 1000);
  });
})
.then(res => {
  console.timeEnd();
  console.log(res);
}); // logä¼šå‘ç”Ÿåœ¨ 1000 æ¯«ç§’å
```

![promise_async](./assets/promise_chain_flow_async.png)

ğŸ‘†è¿™ä¹Ÿæ„å‘³ç€ï¼Œæ¯ä¸€æ­¥éƒ½èƒ½ä½¿ç”¨å¼‚æ­¥ï¼Œç²¾å‡†åœ°æ§åˆ¶ä½•æ—¶è§¦å‘ä¸‹ä¸€æ­¥çš„å›è°ƒå‡½æ•°ï¼Œå½¢æˆä¸€æ¡å®Œæ•´çš„å¼‚æ­¥æµï¼š

```js
function delay (time, data) {
  return new Promise(function (resolve, reject) {
    setTimeout(() => resolve(data), time)
  });
};

delay(100)
.then(function step2() {
  console.log('step 2 after 100ms');
  return delay(200);
})
.then(function step3() {
  console.log('step 3 after 200ms');
})
.then(function step4() {
  console.log('step 4 next job');
  return delay(50);
})
.then(function step5() {
  console.log('step 5 after 50ms');
})
```

è‹¥æ˜¯æ²¡æœ‰æŒ‡å®š return å€¼ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å› `undefined`ï¼Œä½†è¿™å¹¶ä¸ä¼šå½±å“åˆ° Promise çš„é“¾å¼æµã€‚ä½†è¯´å¥å®è¯ï¼Œç®€å•çš„ä½¿ç”¨ `setTimeout` æ¥å»¶è¿Ÿä»£ç æ‰§è¡Œçš„æ—¶é—´ï¼Œåœ¨å®é™…çš„å¼€å‘ä¸­å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼ŒğŸ‘‡ä»¥ä¸‹æ˜¯æ›´è´´è¿‘å®é™…å¼€å‘çš„ä¾‹å­ï¼š

```js
function request (url) {
  return new Promise((resolve, reject) => {
    ajax(url, resolve);
  });
}

request('http://some.url.1/')
.then(response1 => request(`http://some.url.2/?v=${response1}`))
.then(response2 => console.log(response2));
```

ä¸¤ä¸ªä¸²è¡Œçš„ç½‘ç»œè¯·æ±‚ï¼Œç¬¬äºŒä¸ªè¯·æ±‚ä¾èµ–äºç¬¬ä¸€ä¸ªè¯·æ±‚è¿”å›çš„å€¼ï¼Œè¿™æ ·çš„åœºæ™¯åœ¨å®é™…çš„å¼€å‘è¿‡ç¨‹ä¸­å¾ˆå¸¸è§ã€‚æ­¤æ—¶ Promise çš„é“¾å¼ç»“æ„ä¸ä»…å®ç°äº†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡æŒ‰ç…§é¡ºåºä¸²è¡Œè¿›è¡Œï¼Œè€Œä¸”è¿˜èƒ½å¤Ÿåœ¨æ¯ä¸ªæ­¥éª¤é—´å®ç°æ¶ˆæ¯çš„ä¼ é€’ã€‚

ä¸è¿‡ï¼Œä»»ä½•ç¨‹åºéƒ½å¯èƒ½ä¼šå‘ç”Ÿå¼‚å¸¸æƒ…å†µï¼Œåœ¨ Promise ä¸­å½“ç„¶ä¹Ÿå†…ç½®äº†å¯¹å¼‚å¸¸çš„å¤„ç†é€»è¾‘ï¼š

```js
request('http://some.url.1/')
.then(response1 => {
  foo.bar(); // error!
  request(`http://some.url.2/?v=${response1}`);
})
.then(
  response2 => console.log(response2),
  err => {
    console.log(err);
    return 42;
  }
)
.then(msg => console.log(msg)); // 42
```

`then(â€¦)` çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯å½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œè¢«è°ƒç”¨çš„ rejection å›è°ƒå‡½æ•°ã€‚æ— è®ºæ˜¯ `reject`ã€`throw new Error(â€¦)`ã€æˆ–è€…æ˜¯ä¸Šé¢çœ‹åˆ°é”™è¯¯ä»£ç  `foo.bar();`ï¼Œéƒ½ä¼šæ¿€æ´» rejection å›è°ƒå‡½æ•°ã€‚

æ— è®ºæ˜¯å¿½ç•¥ fulfillment è¿˜æ˜¯ rejection çš„å›è°ƒå‡½æ•°ï¼Œä¸€æ—¦ Promise çš„çŠ¶æ€è¢«ç¡®å®šåï¼Œéƒ½ä¼šç»§ç»­æ²¿ç€ Promise é“¾å†’æ³¡ï¼Œç›´åˆ°é‡è§å¤„ç†å®ƒçš„å›è°ƒå‡½æ•°ä¸ºæ­¢ï¼š

```js
var p = Promise.reject('reject msg!');

p
.then(
  res => console.log('fulfillment handler: ', res)
)
.then(
  null,
  err => console.log('rejection handler: ', err)
);
```

![rejection_handler](./assets/promise_chain_flow_rejection.png)

**Note**ï¼šæœ¬è´¨ä¸Šæ¥çœ‹ï¼Œ`then(null, function (err) { //... })` çš„æ¨¡å¼å’Œ `catch(function (err) { //... })` è¡Œä¸ºä¸€è‡´ã€‚

æ— è®ºé“¾å¼æµå¤šä¹ˆæœ‰ç”¨ï¼Œéƒ½ä¸è¯¥æŠŠå®ƒè§†ä¸ºæ˜¯ Promise çš„æœ€æ ¸å¿ƒçš„æ„ä¹‰æ‰€åœ¨ï¼Œé¡¶å¤šç®—ä½œæ˜¯ä¸€ä¸ªå‰¯äº§å“ã€‚è€Œ *æ ‡å‡†åŒ–å¼‚æ­¥æ“ä½œæµç¨‹* å’Œ *å°†æ—¶é—´å’ŒçŠ¶æ€éƒ½å°è£…åˆ°å€¼çš„ä¾èµ–ä¸­*ï¼Œæ˜¯è®©æˆ‘ä»¬èƒ½å¤Ÿå°†å…¶é“¾æ¥èµ·æ¥çš„å…³é”®æ‰€åœ¨ã€‚

ä¸è¿‡ï¼Œé“¾å¼è°ƒç”¨çš„ *this-then-this-then-this...* çš„æ¨¡å¼ä¾ç„¶æœ‰å¤ªå¤šçš„ â€œå…«è‚¡(boilerplate)â€ éœ€è¦ä¸€æ¬¡åˆä¸€æ¬¡çš„è¢«å®ç°å‡ºæ¥ï¼Œè€Œè§£å†³è¿™ä¸ªé—®é¢˜æ˜¯éœ€è¦ä¸€ä¸ªæ›´ä¸ºä¼˜é›…çš„å¼‚æ­¥æµç¨‹æ§åˆ¶æ¨¡å¼ â€”â€” generatorã€‚

### æœ¯è¯­ï¼šResolve, Fulfill å’Œ Reject(Terminology: Resolve, Fulfill, and Reject)
å¯¹äº "resolve"ã€"fulfill"ã€"reject" è¿™äº›æœ¯è¯­ï¼Œå¥½åƒå¤§è‡´èƒ½åŒºåˆ«å®ƒä»¬ï¼Œä½†å§‹ç»ˆæœ‰ä¸€äº›å›°æƒ‘ï¼Œä¸æ˜ç™½å®ƒä»¬ä¹‹é—´åˆ°åº•æœ‰å•¥ä¸ä¸€æ ·ã€‚å…ˆåˆ«æ€¥ï¼Œæ¥çœ‹ä¸€æ®µä»£ç ï¼š

```js
var p = new Promise(function (x, y) {
  // x() -> fulfillment
  // y() -> rejection
});
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œå®ä¾‹åŒ– Promise çš„å›è°ƒå‡½æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°çš„è°ƒç”¨ `x()` æ ‡å¿—ç€ Promise è¢«å®šä¸º fulfill çš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™ä»£è¡¨ Promise è¢«å®šä¸º reject çš„çŠ¶æ€ã€‚ä½†è¯·æ³¨æ„è¿™ä¸ªç»†èŠ‚ â€”â€” â€œé€šå¸¸â€ã€‚

æœ¬è´¨ä¸Šæ¥çœ‹ï¼Œä½ å†™çš„ä»£ç  `function (x, y) { //â€¦ }` å¯¹äº JSå¼•æ“ æ¥è¯´éƒ½æ˜¯ä¸€æ ·çš„ â€”â€” æ— è®ºæ˜¯ `x` è¿˜æ˜¯ `y` å¯¹å®ƒæ¥è®²éƒ½åªä¸è¿‡æ˜¯ç›¸åŒçš„å‡½æ•°ä½“ï¼Œä½†æ˜¯å‡½æ•°çš„åå­—ï¼Œä¸ä»…ä»…å…³ä¹ä½ è‡ªå·±å¯¹äºä»£ç çš„ç†è§£ï¼Œæ›´ä¸ºå…³é”®çš„æ˜¯ä½ å›¢é˜Ÿçš„å…¶ä»–å¼€å‘è€…å¦‚ä½•ç†è§£ä½ çš„ä»£ç ã€‚ä¸€æ®µå³ä¾¿æ˜¯ç²¾å¿ƒç¼–æ’è®¾è®¡ï¼Œä½†æ€è€ƒé”™è¯¯çš„å¼‚æ­¥ä»£ç å¸¦æ¥çš„å±å®³ï¼Œè¿œæ¯”æ„å¤§åˆ©é¢æ¡èˆ¬çš„å›è°ƒåœ°ç‹±(spaghetti-callback)å¼‚æ­¥ä»£ç å±å®³æ›´å¤§ï¼Œå› æ­¤å¦‚ä½•ç»™ `x` å’Œ `y` ä¸€ä¸ªå‡†ç¡®çš„å‘½åæ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚

ğŸ‘†ä½¿ç”¨ `reject(â€¦)` æ¥å‘½åå®ä¾‹åŒ– Promise å›è°ƒçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ­£ç¡®çš„é€‰æ‹©ã€‚è€Œå¯¹äºç¬¬ä¸€ä¸ªå‚æ•°çš„ç§°è°“ï¼Œå³ä¾¿æ˜¯å®˜æ–¹æ¨èä½¿ç”¨çš„ `resolve(â€¦)`ï¼Œå´ä¹Ÿæ€»æ˜¯ä¼šè®©äººè”æƒ³åˆ° "resolution(å†³å®š)" çš„æ„æ€ â€”â€” è¿™ä¸ªå«ä¹‰é€šå¸¸ä¼šè¢«ç†è§£ä¸º â€œç¡®å®š Promise æœ€ç»ˆçš„å€¼/çŠ¶æ€â€ã€‚

è‹¥æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°è¢«æŒ‡å®šä¸º Promise çš„ fulfill çŠ¶æ€çš„è¯ï¼Œé‚£ä¸ºä½•æˆ‘ä»¬ä¸ç”¨ `fulfill(â€¦)` å–ä»£ `resolve(â€¦)` å‘¢ï¼Ÿè¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œè¿˜å¾—ä»”ç»†çœ‹çœ‹ä¸¤ä¸ª Promise çš„ APIï¼š

```js
var fulfilledPr = Promise.resolve(42);
var rejectedPr = Promise.reject('err');
```

`Promise.resolve(â€¦);` è¿™ä¸ª API å°†æ•°å­— `42` å®šä¸º Promise çš„æœ€ç»ˆå€¼ï¼ŒçŠ¶æ€ä¸º fulfilledï¼›è€Œ `Promise.reject('err');` æ˜¾ç„¶æ˜¯åˆ›å»ºä¸€ä¸ªçŠ¶æ€ä¸º rejected çš„ Promiseï¼Œç†ç”±(å€¼)æ˜¯ `err`ã€‚

ğŸ‘†è¿™å¥½åƒå¹¶æ²¡æœ‰è¯´æ˜ä¸ºå•¥ `resolve(â€¦)` ä¸ç”¨ `fulfill(â€¦)` çš„é—®é¢˜ï¼Ÿå…ˆåˆ«æ€¥ï¼Œçœ‹ä¸‹é¢ä¸€æ®µä»£ç ï¼š

```js
var rejectedTh = {
  then: function (resolved, rejected) {
    rejected('err msg');
  }
};

var rejectedPr = Promise.resolve(rejectedTh);
```

è¿˜è®°å¾—å—ï¼Ÿ`Promise.resolve(â€¦)` ä¼šå°†ä¼ å…¥å…¶ä¸­çš„ thenable æˆ–è€… Promise è§£æå¹¶å±•å¼€ï¼Œå°±ä¸Šé¢çš„ä¾‹å­è€Œè¨€ï¼Œ`Promise.resolve(â€¦)` ä¼šè¿”å›ä¸€ä¸ªçŠ¶æ€æ˜¯ rejected çš„ Promiseã€‚å› æ­¤ï¼Œè¿™ä¸ªæ—¶å€™è‹¥æ˜¯ç”¨ `fulfill(â€¦)` ä½œä¸ºæ–¹æ³•åå°±æ˜¾å¾—å¾ˆä¸åˆæ—¶å®œäº†ï¼Œç›¸æ¯”è¾ƒè€Œè¨€ï¼Œ`resolve(â€¦)` æ˜¾ç„¶æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

è€Œå³ä¾¿æ˜¯åœ¨å®ä¾‹åŒ– Promise çš„å›è°ƒå‡½æ•°ä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åŒæ ·å’Œ `Promise.resolve(â€¦)` ä¸€æ ·ï¼Œä¼šè§£æä¼ å…¥å…¶ä¸­çš„ thenable æˆ–è€… Promiseï¼š

```js
var rejectedPr = new Promise(function (resolve, reject) {
  resolve(Promise.reject('err msg'));
});

rejectedPr.then(
  function fulfilled () {
    // never gets here
  },
  function rejected (err) {
    console.log(err); // "err msg"
  }
);
```

æ‰€ä»¥ï¼Œ`resolve(â€¦)` æ˜¾ç„¶ä¹Ÿæ˜¯å®ä¾‹åŒ– Promise çš„å›è°ƒå‡½æ•°ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°æ›´ä¸ºå‡†ç¡®çš„åç§°ã€‚

**Note**ï¼šğŸ‘† `resolve(Promise.reject('err msg'));` å¹¶ä¸ä¼šæŠŠ `Promise.reject('err msg')` çš„ `'err msg'` è§£æå‡ºæ¥ï¼Œåšè¿™ä»¶äº‹æƒ…çš„æ˜¯ `then(â€¦)` ä¸­çš„ `rejected` å›è°ƒå‡½æ•°ã€‚

è€Œå¯¹äºåœ¨ `then(â€¦)` æ–¹æ³•ä¸­å®šä¹‰çš„ä¸¤ä¸ªå›è°ƒå‡½æ•°å‘¢ï¼Ÿ`fulfilled(â€¦)` å’Œ `rejected(â€¦)` æ˜¾ç„¶æ›´ä¸ºå‡†ç¡®ï¼š

```js
function fulfilled (res) {
  console.log(res);
}

function rejected (err) {
  console.error(err);
}

p.then(
  fulfilled,
  rejected
);
```

åœ¨ ES6 çš„è¯´æ˜æ–‡æ¡£é‡Œé¢ç”¨çš„æ˜¯ `onFulfilled(â€¦)` å’Œ `onRejected(â€¦)`ï¼Œè€Œå®é™…ä¸Šä¹Ÿçš„ç¡®å¦‚æ­¤ï¼Œç¬¬ä¸€ä¸ªå›è°ƒçš„è§¦å‘æ˜¯ Promise è¢«ç¡®å®šä¸º fulfill çŠ¶æ€ï¼›è€Œç¬¬äºŒä¸ªå›è°ƒçš„è§¦å‘æ˜¯ Promise è¢«ç¡®å®šä¸º reject çŠ¶æ€ã€‚


## é”™è¯¯å¤„ç†(Error Handling)
åŒæ­¥çš„ `tryâ€¦catch` æ˜¯å¤§å¤šæ•°JSå¼€å‘è€…é€‰æ‹©çš„å¼‚å¸¸å¤„ç†æ–¹å¼ã€‚ä½†æ˜¯åœ¨å¼‚æ­¥ä»£ç ä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œè¿™ä¸ªæ–¹æ¡ˆæ˜¾å¾—åŠ›ä¸ä»å¿ƒï¼š

```js
function foo () {
  setTimeout(function () {
    baz.bar();
  }, 1000);
}

try {
  foo();
}
catch (err) {
  console.error('try catch æ•è·çš„å¼‚å¸¸ï¼š', err);
}
```

é™¤éé€šè¿‡ä¸€äº›ç‰¹æ®Šçš„æ‰‹æ®µï¼Œå¦åˆ™ `tryâ€¦catch` æ²¡åŠæ³•æå®šå¼‚æ­¥ä»£ç çš„å¼‚å¸¸å¤„ç†ã€‚

è‹¥æ˜¯ä¼ ç»Ÿçš„å›è°ƒå¼‚æ­¥ï¼Œå¼‚å¸¸çš„å¤„ç†ä¸€èˆ¬æ˜¯é€šè¿‡æ‰€è°“çš„ â€œé”™è¯¯ä¼˜å…ˆ(error-first callback style)â€ æ¨¡å¼ï¼š

```js
function foo (cb) {
  setTimeout(function () {
    try {
      var x = baz.bar();
      cb(null, x);
    }
    catch (err) {
      cb(err);
    }
  }, 1000);
}

foo(function (err, val) {
  if (err) {
    console.error('error-first callback: ', err);
  } else {
    console.log(val);
  }
});
```

ä¼ å…¥ `foo(â€¦)` çš„å›è°ƒå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè‹¥æ˜¯é falsy çš„å€¼ï¼Œå°±ä¼šè¢«è®¤ä¸ºå¼‚å¸¸å‘ç”Ÿäº†ï¼›å¦åˆ™çš„è¯ï¼Œå°±æ˜¯æˆåŠŸäº†ã€‚è™½ç„¶è¿™ç§å¼‚æ­¥çš„é”™è¯¯å¤„ç†åœ¨æŠ€æœ¯ä¸Šæ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯å’Œå›è°ƒåœ°ç‹±çš„é—®é¢˜ä¸€æ ·ï¼Œè‹¥æ˜¯æœ‰å¤šä¸ª `ifâ€¦elseâ€¦` çš„é¢æ¡ä»£ç ï¼Œç»•ä¹Ÿèƒ½æŠŠä½ ç»•æ™•ã€‚

Promise é‡‡ç”¨çš„å¼‚å¸¸å¤„ç†ç­–ç•¥æ˜¯ â€œåˆ†è€Œæ²»ä¹‹â€ï¼Œå³å°†å¼‚å¸¸å¤„ç†çš„å›è°ƒå‡½æ•°æ‹†åˆ†å¼€ï¼š

```js
var p = Promise.reject('err msg');

p.then(
  function fulfilled () {
    // â€¦
  },
  function rejected (err) {
    console.error(err);
  }
);
```

è¿™ç§æ¨¡å¼çœ‹ä¸Šå»å¥½åƒæŒºå¥½çš„ï¼Œä½†å…¶å®å‘¢ï¼Œä¹Ÿæ˜¯æœ‰éšå«çš„é—®é¢˜å­˜åœ¨çš„ï¼š

```js
var p = Promise.resolve(42);

p.then(
  function fulfilled (res) {
    // number æ²¡æœ‰ toLowerCase æ–¹æ³•
    // å› æ­¤ä¼šæŠ›å‡ºå¼‚å¸¸
    console.log(res.toLowerCase());
  },
  function rejected (err) {
    // â€¦
  }
);
```

ğŸ‘†ä¹‹å‰æˆ‘ä»¬[è®¨è®ºè¿‡](https://github.com/BobbyLH/ReadingNotes---You-Dont-Know-JS/blob/master/async%20%26%20performance/Promises.md#%E5%90%9E%E6%8E%89%E4%BA%86%E5%90%84%E7%A7%8D%E5%BC%82%E5%B8%B8%E5%92%8C%E9%94%99%E8%AF%AFswallowing-any-errorsexceptions)ä¸ºä»€ä¹ˆ `function rejected (err) { // â€¦ }` æ²¡åŠæ³•æ•è·åˆ°å¼‚å¸¸ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚

è¿™å¾ˆå¥½çš„è§£é‡Šäº†ä¸ºä»€ä¹ˆåœ¨ Promise ä¸­å¤„ç†å¼‚å¸¸å¾ˆå®¹æ˜“å‡ºé—®é¢˜ã€‚

**è­¦å‘Š**ï¼šè‹¥æ˜¯ä½ åœ¨åˆ›å»º Promise çš„è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰æŒ‰ç…§è§„èŒƒæ¥(æ¯”å¦‚ `new Promise(null)`ã€`Promise.all()`ã€`Promise.race(42)`)ï¼Œé‚£è¿™ä¸ªå¼‚å¸¸ä¼šç«‹åˆ»è¢«æŠ›å‡ºï¼Œè€Œä¸æ˜¯è¢«è§£æä¸º rejected çŠ¶æ€åï¼Œç”± reject çš„å›è°ƒå‡½æ•°æ¥å¤„ç†ã€‚

### ç»æœ›ä¹‹å‘(Pit of Despair)